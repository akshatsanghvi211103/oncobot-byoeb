# Expert Verification & Chunk Debug Enhancement

## Summary of Changes

### 1. Enhanced Chunk Retrieval Debug Output

**File:** `byoeb/byoeb/services/chat/message_handlers/user_flow_handlers/generate.py`

**Changes Made:**
- Added detailed debug printing in `__aretrieve_chunks` method
- Now prints query, chunk count, source, content preview, and questions for each chunk
- Prints structured debug output with clear formatting

**Code Added:**
```python
# Print KB context for debugging
print(f"\n=== KB CONTEXT RETRIEVED ({len(all_chunks)} chunks) ===")
print(f"Query: {text}")
for i, chunk in enumerate(all_chunks):
    print(f"Chunk {i+1}:")
    # Print source safely
    source = "Unknown"
    if hasattr(chunk, 'metadata') and chunk.metadata:
        source = chunk.metadata.source or "Unknown"
        if hasattr(chunk.metadata, 'additional_metadata') and chunk.metadata.additional_metadata:
            question = chunk.metadata.additional_metadata.get('question', '')
            if question:
                print(f"  Question: {question}")
    print(f"  Source: {source}")
    
    # Print content safely
    if hasattr(chunk, 'text') and chunk.text:
        print(f"  Content: {chunk.text[:200]}...")
    print("  ---")
print("=== END KB CONTEXT ===\n")
```

### 2. Configured Expert Verifier Phone Number

**File:** `byoeb/byoeb/services/chat/message_handlers/user_flow_handlers/generate.py`

**Changes Made:**
- Updated default expert phone number from `"+91-9739811075"` to `"919739811075"`
- Ensures consistent format with other phone numbers in the system

**Before:**
```python
expert_phone_number_id = "+91-9739811075"
```

**After:**
```python
expert_phone_number_id = "919739811075"
```

### 3. Enhanced Expert Message Detection

**File:** `byoeb/byoeb/services/chat/utils.py`

**Changes Made:**
- Modified `get_expert_byoeb_messages` function to include `BOT_TO_EXPERT_VERIFICATION` messages
- Now detects expert verification messages generated by the system

**Before:**
```python
def get_expert_byoeb_messages(byoeb_messages: List[ByoebMessageContext]):
    expert_user_types = bot_config["expert"]
    expert_messages = [
        byoeb_message for byoeb_message in byoeb_messages
        if byoeb_message.user is not None and byoeb_message.user.user_type in expert_user_types.values()
    ]
    return expert_messages
```

**After:**
```python
def get_expert_byoeb_messages(byoeb_messages: List[ByoebMessageContext]):
    from byoeb.models.message_category import MessageCategory
    expert_user_types = bot_config["expert"]
    expert_messages = [
        byoeb_message for byoeb_message in byoeb_messages
        if (byoeb_message.user is not None and byoeb_message.user.user_type in expert_user_types.values()) 
           or byoeb_message.message_category == MessageCategory.BOT_TO_EXPERT_VERIFICATION.value
    ]
    return expert_messages
```

### 4. Enabled Expert Workflow in Message Sending

**File:** `byoeb/byoeb/services/chat/message_handlers/user_flow_handlers/send.py`

**Changes Made:**
- Removed comment about "skipping expert workflow"
- Added debug output for expert verification messages
- Enhanced logging for expert message sending

**Changes:**
- Updated comment to indicate expert workflow is enabled
- Added print statement showing expert phone number when expert message is found
- Added success confirmation when messages are sent to both user and expert

## Expected Behavior

### 1. Chunk Debug Output
When a user asks a question, you'll see console output like:
```
=== KB CONTEXT RETRIEVED (7 chunks) ===
Query: What are the side effects of chemotherapy?
Chunk 1:
  Question: What are common chemotherapy side effects?
  Source: oncobot_knowledge_base
  Content: Chemotherapy can cause various side effects including nausea, fatigue, hair loss...
  ---
Chunk 2:
  Source: markdown_knowledge_base  
  Content: ### Managing Chemotherapy Side Effects...
  ---
=== END KB CONTEXT ===
```

### 2. Expert Verification Messages
- When a user asks a medical or logistical question, an expert verification message will be sent to `919739811075`
- The expert will receive an interactive button message asking "Is the answer correct?" with Yes/No options
- Console will show: `üë®‚Äç‚öïÔ∏è Found expert verification message for 919739811075`

### 3. Multi-Knowledge Base Search
- System now searches across all 3 knowledge bases (KB1, KB2, KB3)
- Retrieves 3 chunks from Q&A pairs and 4 chunks from markdown sections
- Total of 7 chunks for comprehensive context

## Testing

To test the changes:
1. Start the bot system
2. Send a medical question via QikChat
3. Check console output for chunk debug information
4. Verify expert verification message is sent to 919739811075
5. Expert should receive interactive verification message

## Files Modified

1. `byoeb/byoeb/services/chat/message_handlers/user_flow_handlers/generate.py`
2. `byoeb/byoeb/services/chat/utils.py`
3. `byoeb/byoeb/services/chat/message_handlers/user_flow_handlers/send.py`

## Configuration

- Expert phone number: `919739811075`
- Expert user type: `medical` (for medical queries), `logistical` (for logistical queries)
- Default expert type: `medical` when no experts are configured
- Message format: QikChat interactive buttons with Yes/No options
