(byoeb-py3.11) PS C:\Users\t-asanghvi\work\byoeb\byoeb-v1\byoeb\byoeb\chat_app> p3 .\run.py
cool /subscriptions/cef13953-6a76-4434-9a65-1d95481f83c7/resourceGroups/swasthyabot/providers/Microsoft.CognitiveServices/accounts/swasthyabot-speech2 bruh <function get_bearer_token_provider.<locals>.wrapper at 0x0000017ED2ABAD40> nice
INFO:     Started server process [7204]
INFO:     Waiting for application startup.
FastAPI app is running with PID: 7204
hi there
INFO:     Application startup complete.
INFO:     Uvicorn running on http://127.0.0.1:5000 (Press CTRL+C to quit)
=== WEBHOOK ENDPOINT HIT - PRINT STATEMENT ===
INFO:     35.207.205.165:0 - "POST /webhook/whk HTTP/1.1" 200 OK
=== WEBHOOK ENDPOINT HIT - PRINT STATEMENT ===
INFO:     35.207.205.165:0 - "POST /webhook/whk HTTP/1.1" 200 OK
=== WEBHOOK ENDPOINT HIT - PRINT STATEMENT ===
hi there
DEBUG PRODUCER: Message ID in message: None
DEBUG PRODUCER: Payload ID: QoXyqys78PaoIFWUg6zDmIoRF
DEBUG PRODUCER: Using payload ID as fallback: QoXyqys78PaoIFWUg6zDmIoRF

=== QIKCHAT MESSAGE CONVERSION DEBUG ===
ğŸ“¥ Converting message: {
  "from": "916352927215",
  "timestamp": "2025-12-17T18:30:10.000Z",
  "text": {
    "body": "mera appointment kab hai?"
  },
  "type": "text",
  "id": "QoXyqys78PaoIFWUg6zDmIoRF"
}
ğŸ“ Detected message type: text
âœ… Converting as regular message
ğŸ”— NO REPLY CONTEXT: 'context' not in message keys: ['from', 'timestamp', 'text', 'type', 'id']
=== NO MEDIA CONTEXT CREATED - message_audio is None ===
=== END QIKCHAT MESSAGE CONVERSION DEBUG ===

INFO:     35.207.205.165:0 - "POST /webhook/whk HTTP/1.1" 200 OK
[DEBUG] Looking up users by phone_numbers: ['916352927215']
[DEBUG] get_users_by_phone_numbers called with phone_numbers: ['916352927215']
[DEBUG] Using collection: 'users'
C:\Users\t-asanghvi\AppData\Local\pypoetry\Cache\virtualenvs\byoeb-7XHC672s-py3.11\Lib\site-packages\motor\core.py:171: UserWarning: You appear to be connected to a CosmosDB cluster. For more information regarding feature compatibility and support please visit https://www.mongodb.com/supportability/cosmosdb
  delegate = self.__delegate_class__(*args, **kwargs)
[DEBUG] Raw users_obj from DB (by phone numbers): [{'_id': '1101', 'User': {'user_id': '1101', 'user_name': 'Akshat Sanghvi', 'user_location': {}, 'user_language': 'hi', 'user_type': 'byoebuser', 'phone_number_id': '916352927215', 'test_user': False, 'experts': {'byoebexpert': ['919739811075'], 'byoebexpert2': ['8123273694']}, 'audience': [], 'patient_details': {'date_of_birth': '1985-03-15', 'gender': 'Male', 'age': 21}, 'created_timestamp': 1762936642, 'activity_timestamp': 1765996045, 'last_conversations': [{'question': 'Can I take a bath after radiotherapy?', 'answer': 'Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ask more questions.'}, {'question': 'When is my appointment?', 'answer': 'Let me check with the KMC staff and get back to you with a verified answer. Until then, feel free to ask more questions.'}, {'question': 'When is my appointment?', 'answer': 'Let me check with the KMC staff and get back to you with a verified answer. Until then, feel free to ask more questions.'}]}, 'timestamp': '1762936642'}]
[DEBUG] Retrieved user by phone - user_id: '1101', phone_number_id: '916352927215', user_name: 'Akshat Sanghvi', conversations: 3
ğŸ” GET_BOT_MESSAGES: Database returned 0 results
âŒ GET_BOT_MESSAGES: No messages found in database
ğŸ” Let's check what IDs actually exist in the database...
ğŸ” Recent messages in database (last hour): 54
   Recent 1: ID=WfUtzmYahUg2plgHMIwIJJpzg, Text='Recently, I underwent a major oral and maxillofaci...'
   Recent 2: ID=GQ3VoKODdxtrAZd67d3wRk80O, Text='Let me check with the KMC staff and get back to yo...'
   Recent 3: ID=qhkjHClC9SyNAZUuin8HtY9vH, Text='Let me check with a KMC doctor and get back to you...'
   Recent 4: ID=CyfNwzjteQoXraEcKiDAc1aqe, Text='*Patient Info*: Akshat Sanghvi, Age: 21, Gender: M...'
âŒ Failed to get recent messages for debug: 'NoneType' object is not subscriptable
[DEBUG] Looking for user with phone_number_id: '916352927215' in 1 retrieved users
[DEBUG] Found existing user with user_id: '1101', user_name: 'Akshat Sanghvi', phone_number_id: '916352927215', conversations: 3
ğŸ” PROCESSING MESSAGE: Category=byoebuser_to_bot, UserType=byoebuser
ğŸ” Message Text: mera appointment kab hai?
ğŸ” Added USER conversation to processing queue
ğŸ”¤ USER PROCESS: Translating 'mera appointment kab hai?' from hi to en
Thread ID: 16972, Variable Address: 1644863316864, client address: 1644212040208
ğŸ”¤ USER PROCESS: Translation result: 'When is my appointment?'

=== RESPONSE GENERATION DEBUG ===
ğŸ“ Original message: 'mera appointment kab hai?'
ğŸ“¤ English message for KB: 'When is my appointment?'
ğŸ‘¤ User: 916352927215 (language: hi)

ğŸ” MULTI-KB SEARCH DEBUG:
ğŸ” Query: 'When is my appointment?'
ğŸ” Searching 4 knowledge bases...
ğŸ” Searching KB1 (Q&A pairs) with filter: source eq 'oncobot_knowledge_base'
ğŸ” KB1 returned 3 Q&A results
ğŸ” Searching KB2 (Markdown) with filter: source eq 'kb2_content'
ğŸ” KB2 returned 2 Markdown results
ğŸ” Searching KB3 (Markdown) with filter: source eq 'kb3_content'
ğŸ” KB3 returned 2 Markdown results
ğŸ” Searching KB1_Expert (Expert Corrections) with filter: source eq 'oncobot_expert_knowledge_base'
ğŸ” KB1_Expert returned 1 Expert-validated results
ğŸ” Total chunks retrieved: 8 (KB1: 3, KB2: 2, KB3: 2, KB1_Expert: 1)

=== KB CONTEXT RETRIEVED (8 chunks) ===
Query: When is my appointment?
Chunk 1:
  Question: When is my appointment for radiation ?
  Source: oncobot_knowledge_base
  Content: Question: When is my appointment for radiation ?
Answer: Your appointment for radiation is typically scheduled according to availability of slot. You could enquire about the availability of slots on t...
  ---
Chunk 2:
  Question: Should I book an appointment to meet my doctor after 1 month?
  Source: oncobot_knowledge_base
  Content: Question: Should I book an appointment to meet my doctor after 1 month?
Answer: Once your treatment is over , your doctor will provide you with a date for your follow up visit. This will depend on how...      
  ---
Chunk 3:
  Question: When is my appointment for radiotherapy?
  Source: oncobot_knowledge_base
  Content: Question: When is my appointment for radiotherapy?
Answer: Please contact the radiography team in room number 11 or 12 ( Linear accelerator ) to know more details about your appointment. You can also ...
  ---
Chunk 4:
  Question: Radiation Therapy Guide > Radiotherapy Treatment Process
  Source: kb2_content
  Content: Section: Radiation Therapy Guide > Radiotherapy Treatment Process
Content: The radiotherapy process follows these sequential steps:

1. First examination by the doctor
2. Advised required investigatio...
  ---
Chunk 5:
  Question: Radiation Therapy Guide > Pain Management During Treatment > Pain Medication Guidelines
  Source: kb2_content
  Content: Section: Radiation Therapy Guide > Pain Management During Treatment > Pain Medication Guidelines
Content: Follow the doctor's advice and continue to take the pain medications. Do not alter/change dose...
  ---
Chunk 6:
  Question: Radiation Therapy to Your Head and Neck > After your simulation
  Source: kb3_content
  Content: Section: Radiation Therapy to Your Head and Neck > After your simulation
Content: At the end of your simulation appointment, we will schedule an appointment for your set-up procedure. This is the fina...       
  ---
Chunk 7:
  Question: Radiation Therapy to Your Head and Neck > After your simulation > Scheduling your treatment
  Source: kb3_content
  Content: Section: Radiation Therapy to Your Head and Neck > After your simulation > Scheduling your treatment
Content: You will have radiation treatments every day (Monday through Friday) for about 7 weeks. Yo...
  ---
Chunk 8:
  Question: Hair falls out during treatment.
  Source: oncobot_expert_knowledge_base
  ğŸ† EXPERT-VALIDATED: This chunk contains expert-corrected content
  Content: [EXPERT-VALIDATED] Question: Hair falls out during treatment.
Answer: Hair loss during cancer treatment can occur, but it depends on the site of radiotherapy. Radiation therapy typically causes hair l...
  ---
=== END KB CONTEXT ===


=== FULL LLM INPUT DEBUG ===
Message 1 (system):
  Content: You are an expert oncology assistant helping cancer patients. Your purpose is to answer patients with any oncology-related queries they might have.

You have access to four knowledge bases:
- KB1: Q&A pairs covering general oncology topics.
- KB2 & KB3: Detailed radiation therapy treatment guides and procedures.
- KB1_Expert: Expert-validated corrections and high-priority answers (marked with [EXPERT-VALIDATED]).

Guidelines for answering:
- USE [EXPERT-VALIDATED] content ONLY when it is directl...
Message 2 (user):
  Content: The following knowledge base context has been retrieved from multiple sources to help answer your question. Content marked with [EXPERT-VALIDATED] has been specifically reviewed by medical professionals - use this content ONLY if it directly relates to the user's question:

KNOWLEDGE BASE CONTEXT:
Question: When is my appointment for radiation ?
Answer: Your appointment for radiation is typically scheduled according to availability of slot. You could enquire about the availability of slots on th...
ğŸ” Question being processed: 'When is my appointment?'
ğŸ” Number of chunks: 8
=== END FULL LLM INPUT DEBUG ===


=== LLM RESPONSE DEBUG ===
ğŸ”¤ Raw LLM response_text: '<BEGIN RESPONSE>
To find out the details of your appointment for radiation therapy, please contact the radiography team in room number 11 or 12 (Linear accelerator). You can also call 0820.2922489 for more information. They will be able to provide you with the specific time and date of your appointment.
<END RESPONSE>

<BEGIN QUERY TYPE>
logistical
<END QUERY TYPE>'
ğŸ”¤ Response length: 367
ğŸ”¤ Contains 'Sorry': False
ğŸ”¤ Contains 'assist': False
=== END LLM RESPONSE DEBUG ===

Generated answer:  To find out the details of your appointment for radiation therapy, please contact the radiography team in room number 11 or 12 (Linear accelerator). You can also call 0820.2922489 for more information. They will be able to provide you with the specific time and date of your appointment.
Query the type:  logistical
Query the type:  logistical
ğŸ“Š CLASSIFICATION_FIX: Set original message category to 'byoebuser_to_bot' for proper filtering
finding here ['How do I schedule my radiation treatment time?', 'What steps are involved in radiotherapy treatment?', 'Can I change my radiation treatment schedule?']
Thread ID: 16972, Variable Address: 1644868659904, client address: 1644212040208
Thread ID: 16972, Variable Address: 1644868659904, client address: 1644212040208
Thread ID: 16972, Variable Address: 1644868659904, client address: 1644212040208
âœ… Translated 3 related questions to hi
ğŸ“‹ Using staff waiting message for logistical query
ğŸ”¤ WAITING MESSAGE: Localized (hi): 'à¤®à¥ˆà¤‚ à¤•à¥‡-à¤à¤®-à¤¸à¥€ à¤•à¥‡ à¤¸à¥à¤Ÿà¤¾à¤« à¤¸à¥‡ à¤ªà¥‚à¤› à¤•à¤° à¤†à¤ªà¤•à¥‹ à¤à¤• à¤¸à¤Ÿà¥€à¤• à¤‰à¤¤à¥à¤¤à¤° à¤¦à¥‚à¤à¤—à¤¾à¥¤ à¤¤à¤¬ à¤¤à¤•, à¤¬à¥‡à¤à¤¿à¤à¤• à¤”à¤° à¤ªà¥à¤°à¤¶à¥à¤¨ à¤ªà¥‚à¤›à¥‡à¤‚à¥¤'
ğŸ”¤ WAITING MESSAGE: English: 'Let me check with the KMC staff and get back to you with a verified answer. Until then, feel free to ask more questions.'
ğŸ”— DEBUG: Storing original user question ID for reply context: QoXyqys78PaoIFWUg6zDmIoRF
ğŸ”¤ TRANSLATION DEBUG: About to translate message to hi
ğŸ”¤ TRANSLATION DEBUG: Input text: 'à¤®à¥ˆà¤‚ à¤•à¥‡-à¤à¤®-à¤¸à¥€ à¤•à¥‡ à¤¸à¥à¤Ÿà¤¾à¤« à¤¸à¥‡ à¤ªà¥‚à¤› à¤•à¤° à¤†à¤ªà¤•à¥‹ à¤à¤• à¤¸à¤Ÿà¥€à¤• à¤‰à¤¤à¥à¤¤à¤° à¤¦à¥‚à¤à¤—à¤¾à¥¤ à¤¤à¤¬ à¤¤à¤•, à¤¬à¥‡à¤à¤¿à¤à¤• à¤”à¤° à¤ªà¥à¤°à¤¶à¥à¤¨ à¤ªà¥‚à¤›à¥‡à¤‚à¥¤'
Thread ID: 16972, Variable Address: 1644868659904, client address: 1644212040208
ğŸ”¤ TRANSLATION DEBUG: Final result: 'à¤®à¥ˆà¤‚ à¤•à¥‡-à¤à¤®-à¤¸à¥€ à¤•à¥‡ à¤¸à¥à¤Ÿà¤¾à¤« à¤¸à¥‡ à¤ªà¥‚à¤› à¤•à¤° à¤†à¤ªà¤•à¥‹ à¤à¤• à¤¸à¤Ÿà¥€à¤• à¤‰à¤¤à¥à¤¤à¤° à¤¦à¥‚à¤à¤—à¤¾à¥¤ à¤¤à¤¬ à¤¤à¤•, à¤¬à¥‡à¤à¤¿à¤à¤• à¤”à¤° à¤ªà¥à¤°à¤¶à¥à¤¨ à¤ªà¥‚à¤›à¥‡à¤‚à¥¤'
ğŸ”¤ TRANSLATION DEBUG: Translation used: True
ğŸ”¤ ENGLISH TEXT: Using provided English text: 'Let me check with the KMC staff and get back to you with a verified answer. Until then, feel free to ask more questions.'
ï¿½ Creating user response message...
ğŸ”— Adding 3 follow-up questions to interactive list
ğŸ”— DEBUG: Creating reply context - user message ID: QoXyqys78PaoIFWUg6zDmIoRF
ğŸ”— DEBUG: Created main waiting message reply context with reply_id: QoXyqys78PaoIFWUg6zDmIoRF
ğŸ”— DEBUG: Main waiting message ID: 46f7411d-5f73-427b-b8cd-8136732ec881
ğŸµ Generating TTS audio again for message...
running tts now
running tts now again
ğŸ”§ SPEECH DEBUG - SUCCESS: Generated 107136 bytes of audio
ğŸ”§ TTS DEBUG - Received audio_bytes: <class 'bytes'>, length: 107136
running tts now again 2
ğŸµ TTS audio message generated successfully with SAS URL
ğŸ”— DEBUG: Audio message reply context reply_id: QoXyqys78PaoIFWUg6zDmIoRF
ğŸ”— DEBUG: Audio message ID: 6b2ecf7c-9019-47f1-a04f-19f2f53d0db3
ğŸ’¬ Returning 2 messages: ['interactive_list_reply', 'regular_audio']
âœ… Waiting messages sent to user (in hi)
ğŸ‘¨â€âš•ï¸ Creating expert verification message...
expert result {'byoebexpert': ['919739811075'], 'byoebexpert2': ['8123273694']}
expert result 2 ('8123273694', 'byoebexpert2') logistical
ğŸ‘¨â€âš•ï¸ Using configured expert: 8123273694 (byoebexpert2)
ğŸ†” Generated expert user_id: 17c1ac967b52a4cf1deb6983380f3f0e from phone: 8123273694
ğŸ‘¤ Added patient context for expert: 2 lines
ğŸ¤ DEBUG [Creating expert verification]: Original user query was audio: False
ğŸ”§ Expert additional_info template_language: en (type: <class 'str'>)
ğŸ“‹ Template parameters created:
  {1} Patient Info: Akshat Sanghvi, Age: 21, Gender: Male, DOB: 1985-03-15
  {2} Question: When is my appointment?
  {3} Answer: To find out the details of your appointment for radiation therapy, please contact the radiography team in room number 11 or 12 (Linear accelerator). You can also call 0820.2922489 for more information. They will be able to provide you with the specific time and date of your appointment.
ğŸ” DEBUG [Expert message creation]: additional_info contents:
        emoji: None
        verification_status: pending
        button_titles: ['Yes', 'No']
        template_name: verification_with_butons
        template_language: en
        template_parameters: ['Akshat Sanghvi, Age: 21, Gender: Male, DOB: 1985-03-15', 'When is my appointment?', 'To find out t...     
     âœ… is_audio_query: False
        related_questions: ['à¤®à¥ˆà¤‚ à¤…à¤ªà¤¨à¥‡ à¤°à¥‡à¤¡à¤¿à¤à¤¶à¤¨ à¤‰à¤ªà¤šà¤¾à¤° à¤•à¤¾ à¤¸à¤®à¤¯ à¤•à¥ˆà¤¸à¥‡ à¤¨à¤¿à¤°à¥à¤§à¤¾à¤°à¤¿à¤¤ à¤•à¤°à¥‚à¤?', 'à¤°à¥‡à¤¡à¤¿à¤¯à¥‹à¤¥à¥‡à¤°à¥‡à¤ªà¥€ à¤‰à¤ªà¤šà¤¾à¤° à¤®à¥‡à¤‚ à¤•à¥Œà¤¨-à¤•à¥Œà¤¨ à¤¸à¥‡ à¤•à¤¦à¤® à¤¶à¤¾à¤®à¤¿à¤² ...       
ğŸ‘¨â€âš•ï¸ Expert message created with patient info in template format
ğŸ” DEBUG [After expert message creation]: message_context.additional_info has is_audio_query: True
     Value: False
âœ… Expert verification message created
ğŸ‰ Complete! Generated 5 messages (original user message + waiting messages + expert verification + read receipt)
ğŸ“¥ INCOMING: regular_text, ID=QoXyqys78PaoIFWUg6zDmIoRF
ğŸ“¤ OUTGOING: interactive_list_reply, ID=46f7411d-5f73-427b-b8cd-8136732ec881
ğŸ“¤ OUTGOING: regular_audio, ID=6b2ecf7c-9019-47f1-a04f-19f2f53d0db3
ğŸ” MESSAGE BREAKDOWN: Total=5, Incoming=1, Outgoing=2, Expert=1, ReadReceipt=1
ğŸ” User message 1: Type=interactive_list_reply, ID=46f7411d-5f73-427b-b8cd-8136732ec881
ğŸ” User message 2: Type=regular_audio, ID=6b2ecf7c-9019-47f1-a04f-19f2f53d0db3
ğŸ”§ DEBUG: Using channel_type='qikchat' -> service=QikchatService
ğŸ’¬ Sending response: Let me check with the KMC staff and get back to you with a verified answer. Until then, feel free to...
ğŸ·ï¸ Query type: medical
ğŸ‘¨â€âš•ï¸ Found expert verification message for 8123273694
ğŸ“¤ Processing user message 1/2: interactive_list_reply
ğŸ” HANDLE_USER: Processing interactive_list_reply
Checking interactive list - has description: True, has row_texts: True, row_texts not None: True, result: True
ğŸ” HANDLE_USER: Prepared 1 requests

=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 1 requests
ğŸ“¤ Request 1: {'to_contact': '916352927215', 'type': 'interactive', 'interactive': {'type': 'list', 'body': {'text': 'à¤®à¥ˆà¤‚ à¤•à¥‡-à¤à¤®-à¤¸à¥€ à¤•à¥‡ à¤¸à¥à¤Ÿ    à¤Ÿà¤¾à¤« à¤¸à¥‡ à¤ªà¥‚à¤› à¤•à¤° à¤†à¤ªà¤•à¥‹ à¤à¤• à¤¸à¤Ÿà¥€à¤• à¤‰à¤¤à¥à¤¤à¤° à¤¦à¥‚à¤à¤—à¤¾à¥¤ à¤¤à¤¬ à¤¤à¤•, à¤¬à¥‡à¤à¤¿à¤à¤• à¤”à¤° à¤ªà¥à¤°à¤¶à¥à¤¨ à¤ªà¥‚à¤›à¥‡à¤‚à¥¤'}, 'action': {'button': 'à¤¸à¤‚à¤¬à¤‚à¤§à¤¿à¤¤ à¤ªà¥à¤°à¤¶à¥à¤¨', 'sections': [{'title': ''              ', 'rows': [{'id': 'option_0', 'title': 'Q1', 'description': 'à¤®à¥ˆà¤‚ à¤…à¤ªà¤¨à¥‡ à¤°à¥‡à¤¡à¤¿à¤à¤¶à¤¨ à¤‰à¤ªà¤šà¤¾à¤° à¤•à¤¾ à¤¸à¤®à¤¯ à¤•à¥ˆà¤¸à¥‡ à¤¨à¤¿à¤°à¥à¤§à¤¾à¤°à¤¿à¤¤ à¤•à¤°à¥‚à¤?'}, {'id': 'option_1', 'ti        itle': 'Q2', 'description': 'à¤°à¥‡à¤¡à¤¿à¤¯à¥‹à¤¥à¥‡à¤°à¥‡à¤ªà¥€ à¤‰à¤ªà¤šà¤¾à¤° à¤®à¥‡à¤‚ à¤•à¥Œà¤¨-à¤•à¥Œà¤¨ à¤¸à¥‡ à¤•à¤¦à¤® à¤¶à¤¾à¤®à¤¿à¤² à¤¹à¥‹à¤¤à¥‡ à¤¹à¥ˆà¤‚?'}, {'id': 'option_2', 'title': 'Q3', 'description': 'à¤•à¥         à¤¯à¤¾ à¤®à¥ˆà¤‚ à¤…à¤ªà¤¨à¥€ à¤°à¥‡à¤¡à¤¿à¤à¤¶à¤¨ à¤‰à¤ªà¤šà¤¾à¤° à¤•à¥€ à¤¸à¤®à¤¯-à¤¸à¤¾à¤°à¤£à¥€ à¤¬à¤¦à¤² à¤¸à¤•à¤¤à¤¾ à¤¹à¥‚à¤?'}]}]}}, 'context': {'message_id': 'QoXyqys78PaoIFWUg6zDmIoRF'}}
ğŸ“¤ Got 1 results
ğŸ“¤ Result 1: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'wVODGrh8rYXE3jBKRR6PqxADH', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '916352927215', 'credits': 0, 'created_at': '2025-12-17T18:30:48.424Z', 'status': 'processing'}]}
ğŸ“¤ Extracted message_id for result 1: wVODGrh8rYXE3jBKRR6PqxADH
ğŸ“¤ Final message_ids: ['wVODGrh8rYXE3jBKRR6PqxADH']
=== END QIKCHAT SEND_REQUESTS DEBUG ===


=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 0 requests
ğŸ“¤ Got 0 results
ğŸ“¤ Final message_ids: []
=== END QIKCHAT SEND_REQUESTS DEBUG ===

ğŸ“¤ Processing user message 2/2: regular_audio
ğŸ” HANDLE_USER: Processing regular_audio
Checking interactive list - has description: False, has row_texts: False, row_texts not None: False, result: False
ğŸµ Preparing audio message request (async)...
ğŸµ Using audio URL: https://smartkcstorage1.blob.core.windows.net/onco...
ğŸµ Audio message request prepared
ğŸ” HANDLE_USER: Prepared 1 requests
ğŸµ Sending audio message...
ğŸµ Audio message only (no follow-up questions)
ğŸµ Found 1 audio requests to send

=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 1 requests
ğŸ“¤ Request 1: {'to_contact': '916352927215', 'type': 'audio', 'audio': {'link': 'https://smartkcstorage1.blob.core.windows.net/oncobot-container/tts_audio_bdb13679e5be4538841f613e09a6ed00.mp3?st=2025-12-17T18%3A30%3A47Z&se=2025-12-17T19%3A30%3A47Z&sp=r&sv=2025-01-05&sr=b&skoid=f5b64d94-ba27-422a-abb5-cad2b511c671&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2025-12-17T18%3A30%3A47Z&ske=2025-12-17T19%3A30%3A47Z&sks=b&skv=2025-01-05&sig=Ca/9pblq4VNqG4xDqQ2i3zy30uX6tZCwFoKa5UIYM7M%3D'}, 'context': {'message_id': 'QoXyqys78PaoIFWUg6zDmIoRF'}}  
ğŸ“¤ Got 1 results
ğŸ“¤ Result 1: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'OsToH0Tq3j2xhEWETZcV4L7rf', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '916352927215', 'credits': 0, 'created_at': '2025-12-17T18:30:48.573Z', 'status': 'processing'}]}
ğŸ“¤ Extracted message_id for result 1: OsToH0Tq3j2xhEWETZcV4L7rf
ğŸ“¤ Final message_ids: ['OsToH0Tq3j2xhEWETZcV4L7rf']
=== END QIKCHAT SEND_REQUESTS DEBUG ===


=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 0 requests
ğŸ“¤ Got 0 results
ğŸ“¤ Final message_ids: []
=== END QIKCHAT SEND_REQUESTS DEBUG ===

ğŸ”§ Handling expert message for: 8123273694
ğŸ”§ Expert user_id: 17c1ac967b52a4cf1deb6983380f3f0e
User 17c1ac967b52a4cf1deb6983380f3f0e not found in database - treating as inactive
ğŸ”§ Expert is_active_user: False
ğŸ” Interactive button message length: 429 chars
ğŸ” Split result: 1 chunks
ğŸ”§ Expert prepare_requests returned 1 messages
ğŸ“‹ Sending template message to inactive expert
ğŸ“‹ Sending 0 template messages

=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 0 requests
ğŸ“¤ Got 0 results
ğŸ“¤ Final message_ids: []
=== END QIKCHAT SEND_REQUESTS DEBUG ===

responses []
ğŸ“Œ Skipping emoji reaction (emoji is None)

=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 0 requests
ğŸ“¤ Got 0 results
ğŸ“¤ Final message_ids: []
=== END QIKCHAT SEND_REQUESTS DEBUG ===

âœ… Sent 2 user messages and expert verifier message!
âœ… Response sent successfully!
ğŸ” CREATE_CONV DEBUG:
   byoeb_user_message.message_context.message_id: 46f7411d-5f73-427b-b8cd-8136732ec881
   byoeb_user_message.reply_context.reply_id: QoXyqys78PaoIFWUg6zDmIoRF
ğŸ”— REPLY_CONTEXT_FIX: Using reply_context.reply_id as original user question ID: QoXyqys78PaoIFWUg6zDmIoRF
ğŸ•’ CREATE_CONV Response 1/2 (original 1): created_at from QikChat = 2025-12-17T18:30:48.424Z
ğŸ•’ CREATE_CONV: Parsed QikChat created_at to Unix timestamp: 1765996248
ğŸµ AUDIO_URL_FIX: Using original message 1 additional_info
ğŸ”— REPLY_CONTEXT_FIX: Bot message 1 reply_id set to: QoXyqys78PaoIFWUg6zDmIoRF (QikChat ID: wVODGrh8rYXE3jBKRR6PqxADH)
ğŸ•’ CREATE_CONV Response 2/2 (original 2): created_at from QikChat = 2025-12-17T18:30:48.573Z
ğŸ•’ CREATE_CONV: Parsed QikChat created_at to Unix timestamp: 1765996248
ğŸµ AUDIO_URL_FIX: Using original message 2 additional_info
ğŸµ AUDIO_URL_FIX: Found audio_url in original message: https://smartkcstorage1.blob.core.windows.net/onco...
ğŸ”— REPLY_CONTEXT_FIX: Bot message 2 reply_id set to: QoXyqys78PaoIFWUg6zDmIoRF (QikChat ID: OsToH0Tq3j2xhEWETZcV4L7rf)
ğŸ” CLASSIFICATION_FIX: Found original user message with ID QoXyqys78PaoIFWUg6zDmIoRF
ğŸ” CLASSIFICATION_FIX: Using original user message with preserved classification
ğŸ“ Using original message ID from reply context: QoXyqys78PaoIFWUg6zDmIoRF
ğŸ”§ Created USER_TO_BOT message:
   ID: QoXyqys78PaoIFWUg6zDmIoRF
   Text: 'When is my appointment?...'

=== USER HANDLER MESSAGE STORAGE DEBUG ===
ğŸ“Š Total conversations to store: 3
  1. ID: QoXyqys78PaoIFWUg6zDmIoRF
     Category: byoebuser_to_bot
     Type: regular_text
     Text: 'When is my appointment?...'
  2. ID: wVODGrh8rYXE3jBKRR6PqxADH
     Category: bot_to_byoebuser_response
     Type: interactive_list_reply
     Text: 'Let me check with the KMC staff and get back to yo...'
  3. ID: OsToH0Tq3j2xhEWETZcV4L7rf
     Category: bot_to_byoebuser_response
     Type: regular_audio
     Text: '...'
=== END USER HANDLER DEBUG ===

ğŸ” MESSAGE_CREATE_QUERIES: Processing 3 messages for database storage
ğŸ•’ TIMESTAMP_DEBUG Message 1/3: ID=QoXyqys78PaoIFWUg6zD
   has_outgoing_timestamp: 1765996249
   outgoing_timestamp value: 1765996249
   final timestamp: 1765996249
   message_type: regular_text
ğŸ” MESSAGE_CREATE_QUERIES: Message 1
   Message ID: QoXyqys78PaoIFWUg6zDmIoRF
   Message Type: regular_text
   Message Class: logistical
   Is Expert Verification: False
   QikChat Audio ID: None
   Text Preview: When is my appointment?...
ğŸ•’ TIMESTAMP_DEBUG Message 2/3: ID=wVODGrh8rYXE3jBKRR6P
   has_outgoing_timestamp: 1765996248
   outgoing_timestamp value: 1765996248
   final timestamp: 1765996248
   message_type: interactive_list_reply
ğŸ” MESSAGE_CREATE_QUERIES: Message 2
   Message ID: wVODGrh8rYXE3jBKRR6PqxADH
   Message Type: interactive_list_reply
   Message Class: Not classified
   Is Expert Verification: False
   QikChat Audio ID: None
   Text Preview: Let me check with the KMC staff and get back to you with a verified answer. Unti...
ğŸ•’ TIMESTAMP_DEBUG Message 3/3: ID=OsToH0Tq3j2xhEWETZcV
   has_outgoing_timestamp: 1765996248
   outgoing_timestamp value: 1765996248
   final timestamp: 1765996248
   message_type: regular_audio
ğŸ” MESSAGE_CREATE_QUERIES: Message 3
   Message ID: OsToH0Tq3j2xhEWETZcV4L7rf
   Message Type: regular_audio
   Message Class: Not classified
   Is Expert Verification:
   QikChat Audio ID: None
   Text Preview: ...
ğŸ” MESSAGE_CREATE_QUERIES: Generated 3 database create queries
ğŸ” FINAL_QUERIES_DEBUG: About to return 3 queries:
   Query 1: ID=QoXyqys78PaoIFWUg6zDmIoRF, has_text=True, has_audio=False
   Query 2: ID=wVODGrh8rYXE3jBKRR6PqxADH, has_text=True, has_audio=False
   Query 3: ID=OsToH0Tq3j2xhEWETZcV4L7rf, has_text=False, has_audio=True
Saving conversation history: Q: When is my appointment? | A: Let me check with the KMC staff and get back to you with a verified answer. Until then, feel free to...
ğŸ” PROCESSING RESULTS: Got 1 results from handlers
âœ… Result 0: MSG_CREATE=3, MSG_UPDATE=0, USER_CREATE=0, USER_UPDATE=1
Executing database queries - User updates: 1, Message creates: 3
ğŸ” EXECUTE_QUERIES: Starting execution with queries: ['create', 'update']
ğŸ” EXECUTE_QUERIES: Executing 3 CREATE operations
   CREATE 1: Message ID = QoXyqys78PaoIFWUg6zDmIoRF
   CREATE 2: Message ID = wVODGrh8rYXE3jBKRR6PqxADH
   CREATE 3: Message ID = OsToH0Tq3j2xhEWETZcV4L7rf
Inserting documents: ['QoXyqys78PaoIFWUg6zDmIoRF', 'wVODGrh8rYXE3jBKRR6PqxADH', 'OsToH0Tq3j2xhEWETZcV4L7rf']
âœ… EXECUTE_QUERIES: CREATE operations completed successfully
   Result: (['QoXyqys78PaoIFWUg6zDmIoRF', 'wVODGrh8rYXE3jBKRR6PqxADH', 'OsToH0Tq3j2xhEWETZcV4L7rf'], None)
Database operations completed in 0.66 seconds
=== WEBHOOK ENDPOINT HIT - PRINT STATEMENT ===
INFO:     35.207.205.165:0 - "POST /webhook/whk HTTP/1.1" 200 OK
=== WEBHOOK ENDPOINT HIT - PRINT STATEMENT ===
INFO:     35.207.205.165:0 - "POST /webhook/whk HTTP/1.1" 200 OK
=== WEBHOOK ENDPOINT HIT - PRINT STATEMENT ===
INFO:     35.207.205.165:0 - "POST /webhook/whk HTTP/1.1" 200 OK
=== WEBHOOK ENDPOINT HIT - PRINT STATEMENT ===
INFO:     35.207.205.165:0 - "POST /webhook/whk HTTP/1.1" 200 OK
=== WEBHOOK ENDPOINT HIT - PRINT STATEMENT ===
INFO:     35.207.205.165:0 - "POST /webhook/whk HTTP/1.1" 200 OK
=== WEBHOOK ENDPOINT HIT - PRINT STATEMENT ===
INFO:     35.207.205.165:0 - "POST /webhook/whk HTTP/1.1" 200 OK
