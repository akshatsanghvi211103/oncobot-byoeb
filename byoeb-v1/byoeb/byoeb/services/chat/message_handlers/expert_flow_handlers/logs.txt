(byoeb-py3.11) PS C:\Users\t-asanghvi\work\byoeb\byoeb-v1\byoeb\byoeb\chat_app> p3 .\run.py
cool /subscriptions/cef13953-6a76-4434-9a65-1d95481f83c7/resourceGroups/swasthyabot/providers/Microsoft.CognitiveServices/accounts/swasthyabot-speech2 bruh <function get_bearer_token_provider.<locals>.wrapper at 0x000001FD3077AD40> nice
INFO:     Started server process [50168]
INFO:     Waiting for application startup.
FastAPI app is running with PID: 50168
hi there
INFO:     Application startup complete.
INFO:     Uvicorn running on http://127.0.0.1:5000 (Press CTRL+C to quit)
DEBUG PRODUCER: Message ID in message: None
DEBUG PRODUCER: Payload ID: aH00uNS3TVpOB4Znac5pxuzsI
DEBUG PRODUCER: Using payload ID as fallback: aH00uNS3TVpOB4Znac5pxuzsI

=== QIKCHAT MESSAGE CONVERSION DEBUG ===
ЁЯУе Converting message: {
  "from": "916352927215",
  "timestamp": "2025-12-23T10:29:22.000Z",
  "text": {
    "body": "kya mai radiotherapy ke  pehle naha sakta hu?"
  },
  "type": "text",
  "id": "aH00uNS3TVpOB4Znac5pxuzsI"
}
ЁЯУЭ Detected message type: text
тЬЕ Converting as regular message
ЁЯФЧ NO REPLY CONTEXT: 'context' not in message keys: ['from', 'timestamp', 'text', 'type', 'id']
=== NO MEDIA CONTEXT CREATED - message_audio is None ===
=== END QIKCHAT MESSAGE CONVERSION DEBUG ===

INFO:     35.207.205.165:0 - "POST /webhook/whk HTTP/1.1" 200 OK
[DEBUG] Looking up users by phone_numbers: ['916352927215']
[DEBUG] get_users_by_phone_numbers called with phone_numbers: ['916352927215']
[DEBUG] Using collection: 'users'
C:\Users\t-asanghvi\AppData\Local\pypoetry\Cache\virtualenvs\byoeb-7XHC672s-py3.11\Lib\site-packages\motor\core.py:171: UserWarning: You appear to be connected to a CosmosDB cluster. For more information regarding feature compatibility and support please visit https://www.mongodb.com/supportability/cosmosdb
  delegate = self.__delegate_class__(*args, **kwargs)
[DEBUG] Raw users_obj from DB (by phone numbers): [{'_id': '1101', 'User': {'user_id': '1101', 'user_name': 'Akshat Sanghvi', 'user_location': {}, 'user_language': 'hi', 'user_type': 'byoebuser', 'phone_number_id': '916352927215', 'test_user': False, 'experts': {'byoebexpert': ['919739811075'], 'byoebexpert2': ['8123273694']}, 'audience': [], 'patient_details': {'date_of_birth': '1985-03-15', 'gender': 'Male', 'age': 21}, 'created_timestamp': 1762936642, 'activity_timestamp': 1766485668, 'last_conversations': [{'question': 'Can I take a bath after radiotherapy?', 'answer': 'Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ask more questions.'}, {'question': 'Can I take a bath after radiotherapy?', 'answer': 'Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ask more questions.'}, {'question': 'Can I take a bath after radiotherapy?', 'answer': 'Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ask more questions.'}]}, 'timestamp': '1762936642'}]    
[DEBUG] Retrieved user by phone - user_id: '1101', phone_number_id: '916352927215', user_name: 'Akshat Sanghvi', conversations: 3
ЁЯФН GET_BOT_MESSAGES: Database returned 0 results
тЭМ GET_BOT_MESSAGES: No messages found in database
ЁЯФН Let's check what IDs actually exist in the database...
ЁЯФН Recent messages in database (last hour): 115
   Recent 1: ID=MxFxy9BYFhaCdX2LKmk10rhzs, Text='Yes, you can take a bath after radiotherapy, but i...'
   Recent 2: ID=oTrk4CUqbuaViPFgwnpqMel1b, Text='Thank you for verifiying the answer....'
   Recent 3: ID=nNu1MKriuZPXz6qQqf5WC4u1Q, Text='Yes...'
   Recent 4: ID=HOy8PS2fxBKooIw8iYZCmRJ2j, Text='Yes, you can take a bath after radiotherapy, but i...'
   Recent 5: ID=sENvU5bOsQJV10Cf2IGLOVhbx, Text='Thank you for verifiying the answer....'
[DEBUG] Looking for user with phone_number_id: '916352927215' in 1 retrieved users
[DEBUG] Found existing user with user_id: '1101', user_name: 'Akshat Sanghvi', phone_number_id: '916352927215', conversations: 3
ЁЯФН PROCESSING MESSAGE: Category=byoebuser_to_bot, UserType=byoebuser
ЁЯФН Message Text: kya mai radiotherapy ke  pehle naha sakta hu?
ЁЯФН Added USER conversation to processing queue
ЁЯФд USER PROCESS: Translating 'kya mai radiotherapy ke  pehle naha sakta hu?' from hi to en
Thread ID: 45520, Variable Address: 2187603802816, client address: 2186951569872
ЁЯФд USER PROCESS: Translation result: 'Can I take a bath before radiotherapy?'

=== RESPONSE GENERATION DEBUG ===
ЁЯУЭ Original message: 'kya mai radiotherapy ke  pehle naha sakta hu?'
ЁЯУд English message for KB: 'Can I take a bath before radiotherapy?'
ЁЯСд User: 916352927215 (language: hi)

ЁЯФН MULTI-KB SEARCH DEBUG:
ЁЯФН Query: 'Can I take a bath before radiotherapy?'
ЁЯФН Searching 4 knowledge bases...
ЁЯФН Searching KB1 (Q&A pairs) with filter: source eq 'oncobot_knowledge_base'
ЁЯФН KB1 returned 3 Q&A results
ЁЯФН Searching KB2 (Markdown) with filter: source eq 'kb2_content'
ЁЯФН KB2 returned 2 Markdown results
ЁЯФН Searching KB3 (Markdown) with filter: source eq 'kb3_content'
ЁЯФН KB3 returned 2 Markdown results
ЁЯФН Searching KB1_Expert (Expert Corrections) with filter: source eq 'oncobot_expert_knowledge_base'
ЁЯФН KB1_Expert returned 1 Expert-validated results
ЁЯФН Total chunks retrieved: 8 (KB1: 3, KB2: 2, KB3: 2, KB1_Expert: 1)

=== KB CONTEXT RETRIEVED (8 chunks) ===
Query: Can I take a bath before radiotherapy?
Chunk 1:
  Question: Can I use soap on the rest of my body while undergoing radiation therapy?
  Source: oncobot_knowledge_base
  Content: Question: Can I use soap on the rest of my body while undergoing radiation therapy?
Answer: Yes, you can use mild soap on the rest of your body while undergoing radiation therapy. However, be gentle a...
  ---
=== END KB CONTEXT ===


=== FULL LLM INPUT DEBUG ===
Message 1 (system):
  Content: You are an expert oncology assistant helping cancer patients. Your purpose is to answer patients with any oncology-related queries they might have. 

You have access to four knowledge bases:
- KB1: Q&A pairs covering general oncology topics.
- KB2 & KB3: Detailed radiation therapy treatment guides and procedures.
- KB1_Expert: Expert-validated corrections and high-priority answers (marked with [EXPERT-VALIDATED]).

Guidelines for answering:
- USE [EXPERT-VALIDATED] content ONLY when it is directl...
Message 2 (user):
  Content: The following knowledge base context has been retrieved from multiple sources to help answer your question. Content marked with [EXPERT-VALIDATED] has been specifically reviewed by medical professionals - use this content ONLY if it directly relates to the user's question:

KNOWLEDGE BASE CONTEXT:
Question: Can I use soap on the rest of my body while undergoing radiation therapy?
Answer: Yes, you can use mild soap on the rest of your body while undergoing radiation therapy. However, be gentle an...
ЁЯФН Question being processed: 'Can I take a bath before radiotherapy?'
ЁЯФН Number of chunks: 8
=== END FULL LLM INPUT DEBUG ===


=== LLM RESPONSE DEBUG ===
ЁЯФд Raw LLM response_text: '<BEGIN RESPONSE>
Yes, you can take a bath before radiotherapy, but it's important to be gentle with your skin, especially in the treatment area. Use warm water and a mild, unscented soap, and avoid using soap on the treatment area itself. Pat your skin dry with a soft towel and avoid rubbing. Always follow any specific recommendations from your healthcare provider regarding skin care during treatment.
<END RESPONSE>

<BEGIN QUERY TYPE>
medical
<END QUERY TYPE>'
ЁЯФд Response length: 464
ЁЯФд Contains 'Sorry': False
ЁЯФд Contains 'assist': False
=== END LLM RESPONSE DEBUG ===

Generated answer:  Yes, you can take a bath before radiotherapy, but it's important to be gentle with your skin, especially in the treatment area. Use warm water and a mild, unscented soap, and avoid using soap on the treatment area itself. Pat your skin dry with a soft towel and avoid rubbing. Always follow any specific recommendations from your healthcare provider regarding skin care during treatment.
Query the type:  medical
Query the type:  medical
ЁЯУК CLASSIFICATION_FIX: Set original message category to 'byoebuser_to_bot' for proper filtering
finding here ['Can I use moisturizer on the treatment area?', 'What should I do if my skin becomes itchy?', 'Is it safe to swim during radiation therapy?']
Thread ID: 45520, Variable Address: 2187607877696, client address: 2186951569872
Thread ID: 45520, Variable Address: 2187607877696, client address: 2186951569872
Thread ID: 45520, Variable Address: 2187607877696, client address: 2186951569872
тЬЕ Translated 3 related questions to hi
ЁЯСитАНтЪХя╕П Using doctor waiting message for medical query
ЁЯФд WAITING MESSAGE: Localized (hi): 'рдореИрдВ рдХреЗ-рдПрдо-рд╕реА рдХреЗ рдбреЙрдХреНрдЯрд░ рд╕реЗ рдкреВрдЫ рдХрд░ рдЖрдкрдХреЛ рдПрдХ рд╕рдЯреАрдХ рдЙрддреНрддрд░ рджреВрдБрдЧрд╛ред рддрдм рддрдХ, рдмреЗрдЭрд┐рдЭрдХ рдФрд░ рдкреНрд░рд╢реНрди рдкреВрдЫреЗрдВред'
ЁЯФд WAITING MESSAGE: English: 'Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ask more questions.'
ЁЯФЧ DEBUG: Storing original user question ID for reply context: aH00uNS3TVpOB4Znac5pxuzsI
ЁЯФд TRANSLATION DEBUG: About to translate message to hi
ЁЯФд TRANSLATION DEBUG: Input text: 'рдореИрдВ рдХреЗ-рдПрдо-рд╕реА рдХреЗ рдбреЙрдХреНрдЯрд░ рд╕реЗ рдкреВрдЫ рдХрд░ рдЖрдкрдХреЛ рдПрдХ рд╕рдЯреАрдХ рдЙрддреНрддрд░ рджреВрдБрдЧрд╛ред рддрдм рддрдХ, рдмреЗрдЭрд┐рдЭрдХ рдФрд░ рдкреНрд░рд╢реНрди рдкреВрдЫреЗрдВред'
Thread ID: 45520, Variable Address: 2187607877696, client address: 2186951569872
ЁЯФд TRANSLATION DEBUG: Final result: 'рдореИрдВ рдХреЗ-рдПрдо-рд╕реА рдХреЗ рдбреЙрдХреНрдЯрд░ рд╕реЗ рдкреВрдЫ рдХрд░ рдЖрдкрдХреЛ рдПрдХ рд╕рдЯреАрдХ рдЙрддреНрддрд░ рджреВрдБрдЧрд╛ред рддрдм рддрдХ, рдмреЗрдЭрд┐рдЭрдХ рдФрд░ рдкреНрд░рд╢реНрди рдкреВрдЫреЗрдВред'
ЁЯФд TRANSLATION DEBUG: Translation used: True
ЁЯФд ENGLISH TEXT: Using provided English text: 'Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ask more questions.'
я┐╜ Creating user response message...
ЁЯФЧ Adding 3 follow-up questions to interactive list
ЁЯФЧ DEBUG: Creating reply context - user message ID: aH00uNS3TVpOB4Znac5pxuzsI
ЁЯФЧ DEBUG: Created main waiting message reply context with reply_id: aH00uNS3TVpOB4Znac5pxuzsI
ЁЯФЧ DEBUG: Main waiting message ID: 1a65c10b-259e-4c34-ba77-e930323fef19
ЁЯО╡ Generating TTS audio again for message...
running tts now
running tts now again
ЁЯФз SPEECH DEBUG - SUCCESS: Generated 109152 bytes of audio
ЁЯФз TTS DEBUG - Received audio_bytes: <class 'bytes'>, length: 109152
running tts now again 2
ЁЯО╡ TTS audio message generated successfully with SAS URL
ЁЯФЧ DEBUG: Audio message reply context reply_id: aH00uNS3TVpOB4Znac5pxuzsI
ЁЯФЧ DEBUG: Audio message ID: 8abf2271-dc34-4395-a311-efd7ac2a9176
ЁЯТм Returning 2 messages: ['interactive_list_reply', 'regular_audio']
тЬЕ Waiting messages sent to user (in hi)
ЁЯСитАНтЪХя╕П Creating expert verification message...
expert result {'byoebexpert': ['919739811075'], 'byoebexpert2': ['8123273694']}
expert result 2 ('919739811075', 'byoebexpert') medical
ЁЯСитАНтЪХя╕П Using configured expert: 919739811075 (byoebexpert)
ЁЯЖФ Generated expert user_id: d7022499fc5fbcd34df184209477a79f from phone: 919739811075
ЁЯСд Added patient context for expert: 2 lines
ЁЯОд DEBUG [Creating expert verification]: Original user query was audio: False
ЁЯФз Expert additional_info template_language: en (type: <class 'str'>)
ЁЯУЛ Template parameters created:
  {1} Patient Info: Akshat Sanghvi, Age: 21, Gender: Male, DOB: 1985-03-15
  {2} Question: Can I take a bath before radiotherapy?
  {3} Answer: Yes, you can take a bath before radiotherapy, but it's important to be gentle with your skin, especially in the treatment area. Use warm water and a mild, unscented soap, and avoid using soap on the treatment area itself. Pat your skin dry with a soft towel and avoid rubbing. Always follow any specific recommendations from your healthcare provider regarding skin care during treatment.
ЁЯФН DEBUG [Expert message creation]: additional_info contents:
        emoji: None
        verification_status: pending
        button_titles: ['Yes', 'No']
        template_name: verification_with_butons
        template_language: en
        template_parameters: ['Akshat Sanghvi, Age: 21, Gender: Male, DOB: 1985-03-15', 'Can I take a bath before radiotherapy?',...
     тЬЕ is_audio_query: False
        related_questions: ['рдХреНрдпрд╛ рдореИрдВ рдЙрдкрдЪрд╛рд░ рдХреНрд╖реЗрддреНрд░ рдкрд░ рдореЙрдЗрд╕реНрдЪрд░рд╛рдЗрдЬрд╝рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реВрдБ?', 'рдЕрдЧрд░ рдореЗрд░реА рддреНрд╡рдЪрд╛ рдореЗрдВ рдЦреБрдЬрд▓реА рд╣реЛ рддреЛ рдореБрдЭ...
ЁЯСитАНтЪХя╕П Expert message created with patient info in template format
ЁЯФН DEBUG [After expert message creation]: message_context.additional_info has is_audio_query: True
     Value: False
тЬЕ Expert verification message created
ЁЯОЙ Complete! Generated 5 messages (original user message + waiting messages + expert verification + read receipt)
ЁЯУе INCOMING: regular_text, ID=aH00uNS3TVpOB4Znac5pxuzsI
ЁЯУд OUTGOING: interactive_list_reply, ID=1a65c10b-259e-4c34-ba77-e930323fef19
ЁЯУд OUTGOING: regular_audio, ID=8abf2271-dc34-4395-a311-efd7ac2a9176
ЁЯФН MESSAGE BREAKDOWN: Total=5, Incoming=1, Outgoing=2, Expert=1, ReadReceipt=1
ЁЯФН User message 1: Type=interactive_list_reply, ID=1a65c10b-259e-4c34-ba77-e930323fef19
ЁЯФН User message 2: Type=regular_audio, ID=8abf2271-dc34-4395-a311-efd7ac2a9176
ЁЯФз DEBUG: Using channel_type='qikchat' -> service=QikchatService
ЁЯТм Sending response: Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ...
ЁЯП╖я╕П Query type: medical
ЁЯСитАНтЪХя╕П Found expert verification message for 919739811075
ЁЯУд Processing user message 1/2: interactive_list_reply
ЁЯФН HANDLE_USER: Processing interactive_list_reply
Checking interactive list - has description: True, has row_texts: True, row_texts not None: True, result: True
ЁЯФН HANDLE_USER: Prepared 1 requests

=== QIKCHAT SEND_REQUESTS DEBUG ===
ЁЯУд Sending 1 requests
ЁЯУд Request 1: {'to_contact': '916352927215', 'type': 'interactive', 'interactive': {'type': 'list', 'body': {'text': 'рдореИрдВ рдХреЗ-рдПрдо-рд╕реА рдХреЗ рдбреЙрдХреНрдЯрд░ рд╕реЗ рдкреВрдЫ рдХрд░ рдЖрдкрдХреЛ рдПрдХ        рд╕рдЯреАрдХ рдЙрддреНрддрд░ рджреВрдБрдЧрд╛ред рддрдм рддрдХ, рдмреЗрдЭрд┐рдЭрдХ рдФрд░ рдкреНрд░рд╢реНрди рдкреВрдЫреЗрдВред'}, 'action': {'button': 'рд╕рдВрдмрдВрдзрд┐рдд рдкреНрд░рд╢реНрди', 'sections': [{'title': '', 'rows': [{'id': 'option_0', 'title': 'Q1'            ', 'description': 'рдХреНрдпрд╛ рдореИрдВ рдЙрдкрдЪрд╛рд░ рдХреНрд╖реЗрддреНрд░ рдкрд░ рдореЙрдЗрд╕реНрдЪрд░рд╛рдЗрдЬрд╝рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реВрдБ?'}, {'id': 'option_1', 'title': 'Q2', 'description': 'рдЕрдЧрд░ рдореЗрд░реА рддреНрд╡рдЪрд╛ рдореЗрдВ рдЦреБрдЬрд▓реА рд╣реЛ              реЛ рддреЛ рдореБрдЭреЗ рдХреНрдпрд╛ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП?'}, {'id': 'option_2', 'title': 'Q3', 'description': 'рд░реЗрдбрд┐рдПрд╢рди рдереЗрд░реЗрдкреА рдХреЗ рджреМрд░рд╛рди рддреИрд░рдирд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИ рдпрд╛ рдирд╣реАрдВ, рдпрд╣ рдЖрдкрдХреЗ рдбреЙрдХреНрдЯрд░ рдкрд░ ...'}]}]}},             , 'context': {'message_id': 'aH00uNS3TVpOB4Znac5pxuzsI'}}
ЁЯУд Got 1 results
ЁЯУд Result 1: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'm9mMkD4KroCtyzhYEBevxntDH', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '916352927215', 'credits': 0, 'created_at': '2025-12-23T10:30:06.732Z', 'status': 'processing'}]}
ЁЯУд Extracted message_id for result 1: m9mMkD4KroCtyzhYEBevxntDH
ЁЯУд Final message_ids: ['m9mMkD4KroCtyzhYEBevxntDH']
=== END QIKCHAT SEND_REQUESTS DEBUG ===


=== QIKCHAT SEND_REQUESTS DEBUG ===
ЁЯУд Sending 0 requests
ЁЯУд Got 0 results
ЁЯУд Final message_ids: []
=== END QIKCHAT SEND_REQUESTS DEBUG ===

ЁЯУд Processing user message 2/2: regular_audio
ЁЯФН HANDLE_USER: Processing regular_audio
Checking interactive list - has description: False, has row_texts: False, row_texts not None: False, result: False
ЁЯО╡ Preparing audio message request (async)...
ЁЯО╡ Using audio URL: https://smartkcstorage1.blob.core.windows.net/onco...
ЁЯО╡ Audio message request prepared
ЁЯФН HANDLE_USER: Prepared 1 requests
ЁЯО╡ Sending audio message...
ЁЯО╡ Audio message only (no follow-up questions)
ЁЯО╡ Found 1 audio requests to send

=== QIKCHAT SEND_REQUESTS DEBUG ===
ЁЯУд Sending 1 requests
ЁЯУд Request 1: {'to_contact': '916352927215', 'type': 'audio', 'audio': {'link': 'https://smartkcstorage1.blob.core.windows.net/oncobot-container/tts_audio_a65a96c3fe6347118ad4c67823490293.mp3?st=2025-12-23T10%3A30%3A04Z&se=2025-12-23T11%3A30%3A04Z&sp=r&sv=2025-01-05&sr=b&skoid=f5b64d94-ba27-422a-abb5-cad2b511c671&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2025-12-23T10%3A30%3A04Z&ske=2025-12-23T11%3A30%3A04Z&sks=b&skv=2025-01-05&sig=LqS9VX6nnrn6YxZVsgS1rtg74SAve5PXyD4PgYjh0As%3D'}, 'context': {'message_id': 'aH00uNS3TVpOB4Znac5pxuzsI'}}
ЁЯУд Got 1 results
ЁЯУд Result 1: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'Fmf385XFjOvISP3BnPDRJLjHJ', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '916352927215', 'credits': 0, 'created_at': '2025-12-23T10:30:06.909Z', 'status': 'processing'}]}
ЁЯУд Extracted message_id for result 1: Fmf385XFjOvISP3BnPDRJLjHJ
ЁЯУд Final message_ids: ['Fmf385XFjOvISP3BnPDRJLjHJ']
=== END QIKCHAT SEND_REQUESTS DEBUG ===


=== QIKCHAT SEND_REQUESTS DEBUG ===
ЁЯУд Sending 0 requests
ЁЯУд Got 0 results
ЁЯУд Final message_ids: []
=== END QIKCHAT SEND_REQUESTS DEBUG ===

ЁЯФз Handling expert message for: 919739811075
ЁЯФз Expert user_id: d7022499fc5fbcd34df184209477a79f
ЁЯФз Expert is_active_user: False
ЁЯУЛ Preparing template message for inactive expert
ЁЯФз Expert prepare_requests returned 1 messages

=== QIKCHAT SEND_REQUESTS DEBUG ===
ЁЯУд Sending 1 requests
ЁЯУд Request 1: {'to_contact': '919739811075', 'type': 'template', 'template': {'name': 'verification_with_butons', 'language': 'en', 'components': [{'type': 'body', 'parameters': [{'type': 'text', 'text': 'Akshat Sanghvi, Age: 21, Gender: Male, DOB: 1985-03-15'}, {'type': 'text', 'text': 'Can I take a bath before radiotherapy?'}, {'type': 'text', 'text': "Yes, you can take a bath before radiotherapy, but it's important to be gentle with your skin, especially in the treatment area. Use warm water and a mild, unscented soap, and avoid using soap on the treatment area itself. Pat your skin dry with a soft towel and avoid rubbing. Always follow any specific recommendations from your healthcare provider regarding skin care during treatment."}]}]}}
ЁЯУд Got 1 results
ЁЯУд Result 1: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'fqyRUqHjyAma4zg5JmnNDTNYr', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '919739811075', 'credits': 0.2, 'created_at': '2025-12-23T10:30:07.099Z', 'status': 'processing'}]}
ЁЯУд Extracted message_id for result 1: fqyRUqHjyAma4zg5JmnNDTNYr
ЁЯУд Final message_ids: ['fqyRUqHjyAma4zg5JmnNDTNYr']
=== END QIKCHAT SEND_REQUESTS DEBUG ===

responses [{'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'fqyRUqHjyAma4zg5JmnNDTNYr', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '919739811075', 'credits': 0.2, 'created_at': '2025-12-23T10:30:07.099Z', 'status': 'processing'}]}]
ЁЯУМ Skipping emoji reaction (emoji is None)

=== QIKCHAT SEND_REQUESTS DEBUG ===
ЁЯУд Sending 0 requests
ЁЯУд Got 0 results
ЁЯУд Final message_ids: []
=== END QIKCHAT SEND_REQUESTS DEBUG ===

тЬЕ Sent 2 user messages and expert verifier message!
тЬЕ Response sent successfully!
ЁЯФН CREATE_CONV DEBUG:
   byoeb_user_message.message_context.message_id: 1a65c10b-259e-4c34-ba77-e930323fef19
   byoeb_user_message.reply_context.reply_id: aH00uNS3TVpOB4Znac5pxuzsI
ЁЯФЧ REPLY_CONTEXT_FIX: Using reply_context.reply_id as original user question ID: aH00uNS3TVpOB4Znac5pxuzsI
ЁЯХТ CREATE_CONV Response 1/2 (original 1): created_at from QikChat = 2025-12-23T10:30:06.732Z
ЁЯХТ CREATE_CONV: Parsed QikChat created_at to Unix timestamp: 1766485806
ЁЯО╡ AUDIO_URL_FIX: Using original message 1 additional_info
ЁЯФЧ REPLY_CONTEXT_FIX: Bot message 1 reply_id set to: aH00uNS3TVpOB4Znac5pxuzsI (QikChat ID: m9mMkD4KroCtyzhYEBevxntDH)
ЁЯХТ CREATE_CONV Response 2/2 (original 2): created_at from QikChat = 2025-12-23T10:30:06.909Z
ЁЯХТ CREATE_CONV: Parsed QikChat created_at to Unix timestamp: 1766485806
ЁЯО╡ AUDIO_URL_FIX: Using original message 2 additional_info
ЁЯО╡ AUDIO_URL_FIX: Found audio_url in original message: https://smartkcstorage1.blob.core.windows.net/onco...
ЁЯФЧ REPLY_CONTEXT_FIX: Bot message 2 reply_id set to: aH00uNS3TVpOB4Znac5pxuzsI (QikChat ID: Fmf385XFjOvISP3BnPDRJLjHJ)
ЁЯФз EXPERT MESSAGE ID DEBUG:
   Original expert ID: f1a2e3f0-cb47-43b7-be01-9e0c078318fa
   Expert responses count: 1
   First expert response: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'fqyRUqHjyAma4zg5JmnNDTNYr', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '919739811075', 'credits': 0.2, 'created_at': '2025-12-23T10:30:07.099Z', 'status': 'processing'}]}
ЁЯз╣ FILTER_DUPLICATES: Before filtering - 2 entries in messages_context
ЁЯз╣ FILTER_DUPLICATES: Keeping entry: 90a127ca-9ec5-46a7-b4b8-144d12de6811 (UUID: True, Corrected: False)
ЁЯз╣ FILTER_DUPLICATES: Keeping entry: 421a3190-7f57-47f7-a53c-e07f0744348d (UUID: True, Corrected: False)
ЁЯз╣ FILTER_DUPLICATES: After filtering - 2 entries remaining
ЁЯФз CREATE_CROSS_CONV: Processing 1 expert responses (primary only)
ЁЯФз CREATE_CROSS_CONV: Expert response 1: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'fqyRUqHjyAma4zg5JmnNDTNYr', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '919739811075', 'credits': 0.2, 'created_at': '2025-12-23T10:30:07.099Z', 'status': 'processing'}]}
ЁЯФз CREATE_CROSS_CONV: Top-level message ID: None
ЁЯФз CREATE_CROSS_CONV: Checking data array with 1 items
ЁЯФз CREATE_CROSS_CONV: Found message ID in data[0]: fqyRUqHjyAma4zg5JmnNDTNYr
ЁЯФз CREATE_CROSS_CONV: Final extracted expert message ID: fqyRUqHjyAma4zg5JmnNDTNYr
ЁЯФз CREATE_CROSS_CONV: Original expert message ID: f1a2e3f0-cb47-43b7-be01-9e0c078318fa
ЁЯФз CREATE_CROSS_CONV: Updated expert message ID: f1a2e3f0-cb47-43b7-be01-9e0c078318fa -> fqyRUqHjyAma4zg5JmnNDTNYr
ЁЯФз CREATE_CROSS_CONV: Expert message will be stored with Qikchat ID: fqyRUqHjyAma4zg5JmnNDTNYr
ЁЯФз CREATE_CROSS_CONV: Returning 3 messages for database storage
   Message 1: ID=90a127ca-9ec5-46a7-b4b8-144d12de6811, Type=interactive_list_reply, Text='...'
   Message 2: ID=421a3190-7f57-47f7-a53c-e07f0744348d, Type=interactive_list_reply, Text='...'
   Message 3: ID=fqyRUqHjyAma4zg5JmnNDTNYr, Type=template_button, Text='*Patient Info*: Akshat Sanghvi, Age: 21, Gender: M...'
   Expert ID after create_cross_conv: fqyRUqHjyAma4zg5JmnNDTNYr
   ID changed: True
   тД╣я╕П Expert message will be stored in database with correct QikChat ID: fqyRUqHjyAma4zg5JmnNDTNYr
ЁЯФН CLASSIFICATION_FIX: Found original user message with ID aH00uNS3TVpOB4Znac5pxuzsI
ЁЯФН CLASSIFICATION_FIX: Using original user message with preserved classification
ЁЯУО Using original message ID from reply context: aH00uNS3TVpOB4Znac5pxuzsI
ЁЯФз Created USER_TO_BOT message:
   ID: aH00uNS3TVpOB4Znac5pxuzsI
   Text: 'Can I take a bath before radiotherapy?...'

=== USER HANDLER MESSAGE STORAGE DEBUG ===
ЁЯУК Total conversations to store: 6
  1. ID: aH00uNS3TVpOB4Znac5pxuzsI
     Category: byoebuser_to_bot
     Type: regular_text
     Text: 'Can I take a bath before radiotherapy?...'
  2. ID: m9mMkD4KroCtyzhYEBevxntDH
     Category: bot_to_byoebuser_response
     Type: interactive_list_reply
     Text: 'Let me check with a KMC doctor and get back to you...'
  3. ID: Fmf385XFjOvISP3BnPDRJLjHJ
     Category: bot_to_byoebuser_response
     Type: regular_audio
     Text: '...'
  4. ID: 90a127ca-9ec5-46a7-b4b8-144d12de6811
     Category: None
     Type: interactive_list_reply
     Text: '...'
  5. ID: 421a3190-7f57-47f7-a53c-e07f0744348d
     Category: None
     Type: interactive_list_reply
     Text: '...'
  6. ID: fqyRUqHjyAma4zg5JmnNDTNYr
     Category: bot_to_byoebexpert_verification
     Type: template_button
     Text: '*Patient Info*: Akshat Sanghvi, Age: 21, Gender: M...'
=== END USER HANDLER DEBUG ===

ЁЯФН MESSAGE_CREATE_QUERIES: Processing 6 messages for database storage
ЁЯХТ TIMESTAMP_DEBUG Message 1/6: ID=aH00uNS3TVpOB4Znac5p
   has_outgoing_timestamp: 1766485806
   outgoing_timestamp value: 1766485806
   final timestamp: 1766485806
   message_type: regular_text
ЁЯФН MESSAGE_CREATE_QUERIES: Message 1
   Message ID: aH00uNS3TVpOB4Znac5pxuzsI
   Message Type: regular_text
   Message Class: medical
   Is Expert Verification: False
   QikChat Audio ID: None
   Text Preview: Can I take a bath before radiotherapy?...
ЁЯХТ TIMESTAMP_DEBUG Message 2/6: ID=m9mMkD4KroCtyzhYEBev
   has_outgoing_timestamp: 1766485806
   outgoing_timestamp value: 1766485806
   final timestamp: 1766485806
   message_type: interactive_list_reply
ЁЯФН MESSAGE_CREATE_QUERIES: Message 2
   Message ID: m9mMkD4KroCtyzhYEBevxntDH
   Message Type: interactive_list_reply
   Message Class: Not classified
   Is Expert Verification: False
   QikChat Audio ID: None
   Text Preview: Let me check with a KMC doctor and get back to you with a verified answer. Until...
ЁЯХТ TIMESTAMP_DEBUG Message 3/6: ID=Fmf385XFjOvISP3BnPDR
   has_outgoing_timestamp: 1766485806
   outgoing_timestamp value: 1766485806
   final timestamp: 1766485806
   message_type: regular_audio
ЁЯФН MESSAGE_CREATE_QUERIES: Message 3
   Message ID: Fmf385XFjOvISP3BnPDRJLjHJ
   Message Type: regular_audio
   Message Class: Not classified
   Is Expert Verification:
   QikChat Audio ID: None
   Text Preview: ...
ЁЯХТ TIMESTAMP_DEBUG Message 4/6: ID=90a127ca-9ec5-46a7-b
   has_outgoing_timestamp: None
   outgoing_timestamp value: None
   final timestamp: 1766485806
   message_type: interactive_list_reply
ЁЯФН MESSAGE_CREATE_QUERIES: Message 4
   Message ID: 90a127ca-9ec5-46a7-b4b8-144d12de6811
   Message Type: interactive_list_reply
   Message Class: Not classified
   Is Expert Verification: None
   QikChat Audio ID: None
   Text Preview: ...
ЁЯХТ TIMESTAMP_DEBUG Message 5/6: ID=421a3190-7f57-47f7-a
   has_outgoing_timestamp: None
   outgoing_timestamp value: None
   final timestamp: 1766485806
   message_type: interactive_list_reply
ЁЯФН MESSAGE_CREATE_QUERIES: Message 5
   Message ID: 421a3190-7f57-47f7-a53c-e07f0744348d
   Message Type: interactive_list_reply
   Message Class: Not classified
   Is Expert Verification: None
   QikChat Audio ID: None
   Text Preview: ...
ЁЯХТ TIMESTAMP_DEBUG Message 6/6: ID=fqyRUqHjyAma4zg5JmnN
   has_outgoing_timestamp: None
   outgoing_timestamp value: None
   final timestamp: 1766485806
   message_type: template_button
ЁЯФН MESSAGE_CREATE_QUERIES: Message 6
   Message ID: fqyRUqHjyAma4zg5JmnNDTNYr
   Message Type: template_button
   Message Class: Not classified
   Is Expert Verification: True
   QikChat Audio ID: None
   Text Preview: *Patient Info*: Akshat Sanghvi, Age: 21, Gender: Male, DOB: 1985-03-15

*Questio...
   ЁЯФН Expert verification additional_info keys: ['emoji', 'verification_status', 'button_titles', 'template_name', 'template_language', 'template_parameters', 'is_audio_query', 'related_questions']
   тЬЕ is_audio_query in additional_info: False
ЁЯФН MESSAGE_CREATE_QUERIES: Generated 6 database create queries
ЁЯФН FINAL_QUERIES_DEBUG: About to return 6 queries:
   Query 1: ID=aH00uNS3TVpOB4Znac5pxuzsI, has_text=True, has_audio=False
   Query 2: ID=m9mMkD4KroCtyzhYEBevxntDH, has_text=True, has_audio=False
   Query 3: ID=Fmf385XFjOvISP3BnPDRJLjHJ, has_text=False, has_audio=True
   Query 4: ID=90a127ca-9ec5-46a7-b4b8-144d12de6811, has_text=False, has_audio=False
   Query 5: ID=421a3190-7f57-47f7-a53c-e07f0744348d, has_text=False, has_audio=False
   Query 6: ID=fqyRUqHjyAma4zg5JmnNDTNYr, has_text=True, has_audio=False
Saving conversation history: Q: Can I take a bath before radiotherapy? | A: Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ...
ЁЯФН PROCESSING RESULTS: Got 1 results from handlers
тЬЕ Result 0: MSG_CREATE=6, MSG_UPDATE=0, USER_CREATE=0, USER_UPDATE=1
Executing database queries - User updates: 1, Message creates: 6
ЁЯФН EXECUTE_QUERIES: Starting execution with queries: ['create', 'update']
ЁЯФН EXECUTE_QUERIES: Executing 6 CREATE operations
   CREATE 1: Message ID = aH00uNS3TVpOB4Znac5pxuzsI
   CREATE 2: Message ID = m9mMkD4KroCtyzhYEBevxntDH
   CREATE 3: Message ID = Fmf385XFjOvISP3BnPDRJLjHJ
   CREATE 4: Message ID = 90a127ca-9ec5-46a7-b4b8-144d12de6811
   CREATE 5: Message ID = 421a3190-7f57-47f7-a53c-e07f0744348d
   CREATE 6: Message ID = fqyRUqHjyAma4zg5JmnNDTNYr
Inserting documents: ['aH00uNS3TVpOB4Znac5pxuzsI', 'm9mMkD4KroCtyzhYEBevxntDH', 'Fmf385XFjOvISP3BnPDRJLjHJ', '90a127ca-9ec5-46a7-b4b8-144d12de6811', '421a3190-7f57-47f7-a53c-e07f0744348d', 'fqyRUqHjyAma4zg5JmnNDTNYr']
тЬЕ EXECUTE_QUERIES: CREATE operations completed successfully
   Result: (['aH00uNS3TVpOB4Znac5pxuzsI', 'm9mMkD4KroCtyzhYEBevxntDH', 'Fmf385XFjOvISP3BnPDRJLjHJ', '90a127ca-9ec5-46a7-b4b8-144d12de6811', '421a3190-7f57-47f7-a53c-e07f0744348d', 'fqyRUqHjyAma4zg5JmnNDTNYr'], None)
Database operations completed in 0.61 seconds
DEBUG PRODUCER: Message ID in message: None
DEBUG PRODUCER: Payload ID: Gy9vJy3QXsK7oS9X8Y6VviTOs
DEBUG PRODUCER: Using payload ID as fallback: Gy9vJy3QXsK7oS9X8Y6VviTOs

=== QIKCHAT MESSAGE CONVERSION DEBUG ===
ЁЯУе Converting message: {
  "from": "919739811075",
  "timestamp": "2025-12-23T10:30:25.000Z",
  "button": {
    "payload": "Yes",
    "text": "Yes"
  },
  "type": "button",
  "context": {
    "messageId": "fqyRUqHjyAma4zg5JmnNDTNYr"
  },
  "id": "Gy9vJy3QXsK7oS9X8Y6VviTOs"
}
ЁЯУЭ Detected message type: button
ЁЯФШ Converting button message as interactive message
ЁЯФН Interactive context data found: {'messageId': 'fqyRUqHjyAma4zg5JmnNDTNYr'}
ЁЯФЧ INTERACTIVE REPLY CONTEXT FOUND: reply_to_message_id = fqyRUqHjyAma4zg5JmnNDTNYr
тЬЕ Button conversion successful
   - Reply ID: fqyRUqHjyAma4zg5JmnNDTNYr
=== END QIKCHAT MESSAGE CONVERSION DEBUG ===

INFO:     35.207.205.165:0 - "POST /webhook/whk HTTP/1.1" 200 OK
[DEBUG] Looking up users by phone_numbers: ['919739811075']
[DEBUG] get_users_by_phone_numbers called with phone_numbers: ['919739811075']
[DEBUG] Using collection: 'users'
[DEBUG] Raw users_obj from DB (by phone numbers): [{'_id': 'd7022499fc5fbcd34df184209477a79f', 'User': {'user_id': 'd7022499fc5fbcd34df184209477a79f', 'user_name': None, 'user_location': {}, 'user_language': 'en', 'user_type': 'byoebexpert', 'phone_number_id': '919739811075', 'test_user': False, 'experts': {}, 'audience': ['916360720233', '919740379935', '916352927215'], 'patient_details': {}, 'created_timestamp': 1762936628, 'activity_timestamp': 1766485689, 'last_conversations': []}, 'timestamp': '1762936628'}]
[DEBUG] Retrieved user by phone - user_id: 'd7022499fc5fbcd34df184209477a79f', phone_number_id: '919739811075', user_name: 'None', conversations: 0
ЁЯФН GET_BOT_MESSAGES: Database returned 1 results
тЬЕ GET_BOT_MESSAGES: Found matching messages
   Found 1: ID=fqyRUqHjyAma4zg5JmnNDTNYr
ЁЯдЦ Bot message 0: ID=fqyRUqHjyAma4zg5JmnNDTNYr
[DEBUG] Looking for user with phone_number_id: '919739811075' in 1 retrieved users
[DEBUG] Found existing user with user_id: 'd7022499fc5fbcd34df184209477a79f', user_name: 'None', phone_number_id: '919739811075', conversations: 0
я┐╜ Expert message debug - reply_id: fqyRUqHjyAma4zg5JmnNDTNYr, bot_message found: True
ЁЯФН Reply context exists: reply_id=fqyRUqHjyAma4zg5JmnNDTNYr
ЁЯФН PROCESSING MESSAGE: Category=('byoebexpert_to_bot',), UserType=byoebexpert
ЁЯФН Message Text: Yes
ЁЯФН Added EXPERT conversation to processing queue

=== EXPERT MESSAGE CONSUMER DEBUG ===
ЁЯСитАНтЪХя╕П Processing expert message from: 919739811075
ЁЯТм Message text: 'Yes'
ЁЯУЭ Message type: interactive_button_reply
ЁЯФЧ Reply ID: fqyRUqHjyAma4zg5JmnNDTNYr
ЁЯФЧ Reply additional info: {'emoji': None, 'verification_status': 'pending', 'button_titles': ['Yes', 'No'], 'template_name': 'verification_with_butons', 'template_language': 'en', 'template_parameters': ['Akshat Sanghvi, Age: 21, Gender: Male, DOB: 1985-03-15', 'Can I take a bath before radiotherapy?', "Yes, you can take a bath before radiotherapy, but it's important to be gentle with your skin, especially in the treatment area. Use warm water and a mild, unscented soap, and avoid using soap on the treatment area itself. Pat your skin dry with a soft towel and avoid rubbing. Always follow any specific recommendations from your healthcare provider regarding skin care during treatment."], 'is_audio_query': False, 'related_questions': ['рдХреНрдпрд╛ рдореИрдВ рдЙрдкрдЪрд╛рд░ рдХреНрд╖реЗрддреНрд░ рдкрд░ рдореЙрдЗрд╕реНрдЪрд░рд╛рдЗрдЬрд╝рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░         рд╕рдХрддрд╛ рд╣реВрдБ?', 'рдЕрдЧрд░ рдореЗрд░реА рддреНрд╡рдЪрд╛ рдореЗрдВ рдЦреБрдЬрд▓реА рд╣реЛ рддреЛ рдореБрдЭреЗ рдХреНрдпрд╛ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП?', 'рд░реЗрдбрд┐рдПрд╢рди рдереЗрд░реЗрдкреА рдХреЗ рджреМрд░рд╛рди рддреИрд░рдирд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИ рдпрд╛ рдирд╣реАрдВ, рдпрд╣ рдЖрдкрдХреЗ рдбреЙрдХреНрдЯрд░ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИред рдХреБрдЫ рдо                       рдорд╛рдорд▓реЛрдВ рдореЗрдВ, рддреИрд░рдирд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рддреНрд╡рдЪрд╛ рдХреА рд╕рдВрд╡реЗрджрдирд╢реАрд▓рддрд╛ рдФрд░ рд╕рдВрдХреНрд░рдордг рдХреЗ рдЬреЛрдЦрд┐рдо рдХреЛ рдзреНрдпрд╛рди рдореЗрдВ рд░рдЦрддреЗ рд╣реБрдП рдбреЙрдХреНрдЯрд░ рд╕реЗ рд╕рд▓рд╛рд╣ рд▓реЗрдирд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИред']}
=== END EXPERT MESSAGE CONSUMER DEBUG ===

Translation skipped - same language

=== EXPERT GENERATE RESPONSE DEBUG ===
ЁЯУз Processing expert message from: 919739811075
ЁЯТм Message text: 'Yes'
ЁЯУЭ Message type: interactive_button_reply
ЁЯФЧ Reply context exists: True
ЁЯФЧ Reply ID: fqyRUqHjyAma4zg5JmnNDTNYr
ЁЯФЧ Reply message category: bot_to_byoebexpert_verification
ЁЯФЧ Reply additional_info keys: ['emoji', 'verification_status', 'button_titles', 'template_name', 'template_language', 'template_parameters', 'is_audio_query', 'related_questions']
ЁЯФЧ Verification status: pending
тЬЕ Branch: Expert clicked YES - sending approved answer to user and thank you to expert
ЁЯФз DEBUG: Final extracted question: 'Can I take a bath before radiotherapy?' bot_answer: 'Yes, you can take a bath before radiotherapy, but it's important to be gentle with your skin, especially in the treatment area. Use warm water and a mild, unscented soap, and avoid using soap on the treatment area itself. Pat your skin dry with a soft towel and avoid rubbing. Always follow any specific recommendations from your healthcare provider regarding skin care during treatment.'
ЁЯФз DEBUG: Expert thank you message: 'Thank you for verifiying the answer.'
ЁЯФз DEBUG: Created expert message with text: 'Thank you for verifiying the answer.'
Translating bot answer to user's language: hi
ЁЯФН DEBUG [Expert YES - checking additional_info]:
     reply_context.additional_info keys: ['emoji', 'verification_status', 'button_titles', 'template_name', 'template_language', 'template_parameters', 'is_audio_query', 'related_questions']
     has is_audio_query: True
     is_audio_query value: False
ЁЯОд DEBUG [Expert YES approval]: Original user query was audio: False
ЁЯОд DEBUG [Expert YES approval]: User is_active_user: False
ЁЯОд DEBUG [Expert YES approval]: Including Question prefix (audio=False, inactive=True)
here now,  Question: Can I take a bath before radiotherapy?
Answer: Yes, you can take a bath before radiotherapy, but it's important to be gentle with your skin, especially in the treatment area. Use warm water and a mild, unscented soap, and avoid using soap on the treatment area itself. Pat your skin dry with a soft towel and avoid rubbing. Always follow any specific recommendations from your healthcare provider regarding skin care during treatment.
Thread ID: 45520, Variable Address: 2187559570176, client address: 2186951569872
ЁЯФз SPEECH DEBUG - SUCCESS: Generated 495072 bytes of audio
ЁЯФз TTS DEBUG - Received audio_bytes: <class 'bytes'>, length: 495072
ЁЯФз DEBUG: Audio message generated successfully for YES flow with SAS URL
ЁЯФз User 1101 is_active_user: False
COMING HERE 3
ЁЯФз DEBUG: Using translated template params (case 3) - Q: 'рдХреНрдпрд╛ рдореИрдВ рд░реЗрдбрд┐рдпреЛрдереЗрд░реЗрдкреА рд╕реЗ рдкрд╣рд▓реЗ рд╕реНрдирд╛рди рдХрд░ рд╕рдХрддрд╛ рд╣реВрдБ?', A: 'рд╣рд╛рдБ, рдЖрдк рд░реЗрдбрд┐рдпреЛрдереЗрд░реЗрдкреА рд╕реЗ рдкрд╣рд▓реЗ рд╕реНрдирд╛рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ                    , рд▓реЗрдХрд┐рди рдЕрдкрдиреА рддреНрд╡рдЪрд╛ рдХреЗ рд╕рд╛рде рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдЙрдкрдЪрд╛рд░ рдХреНрд╖реЗрддреНрд░ рдореЗрдВ рдХреЛрдорд▓ рд░рд╣рдирд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИред рдЧреБрдирдЧреБрдиреЗ рдкрд╛рдиреА рдФрд░ рд╣рд▓реНрдХреЗ, рдмрд┐рдирд╛ рд╕реБрдЧрдВрдз рд╡рд╛рд▓реЗ рд╕рд╛рдмреБрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ, рдФрд░ рдЙрдкрдЪрд╛рд░ рдХреНрд╖реЗрддреНрд░                              рдкрд░ рд╕рд╛рдмреБрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╕реЗ рдмрдЪреЗрдВред рдЕрдкрдиреА рддреНрд╡рдЪрд╛ рдХреЛ рдПрдХ рдирд░рдо рддреМрд▓рд┐рдпреЗ рд╕реЗ рдердкрдердкрд╛рдХрд░ рд╕реБрдЦрд╛рдПрдВ рдФрд░ рд░рдЧрдбрд╝рдиреЗ рд╕реЗ рдмрдЪреЗрдВред рдЙрдкрдЪрд╛рд░ рдХреЗ рджреМрд░рд╛рди рддреНрд╡рдЪрд╛ рдХреА рджреЗрдЦрднрд╛рд▓ рдХреЗ рд▓рд┐рдП рдЕрдкрдиреЗ рд╕реНрд╡рд╛рд╕реНрдереНрдп рд╕реЗрд╡рд╛ рдкреНрд░рдж                        рджрд╛рддрд╛ рдХреА рдХрд┐рд╕реА рднреА рд╡рд┐рд╢реЗрд╖ рд╕рд┐рдлрд╛рд░рд┐рд╢ рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдВред'
ЁЯФз DEBUG: Using last message in conversation context: 421a3190-7f57-47f7-a53c-e07f0744348d
ЁЯФз DEBUG: Last message category: 'None'
ЁЯФз __create_user_reply_context DEBUG: status=verified, cross_conv_message has reply_context=True
ЁЯФз __create_user_reply_context DEBUG: cross_conv_message.reply_context.reply_id=aH00uNS3TVpOB4Znac5pxuzsI
ЁЯФз __create_user_reply_context DEBUG: additional_info exists=False
ЁЯФз __create_user_reply_context DEBUG: additional_info is None!
ЁЯФз __create_user_reply_context DEBUG: Checking verified condition:
  - status == constants.VERIFIED: True (status='verified', VERIFIED='verified')
  - reply_context is not None: True
  - additional_info is not None: False
ЁЯФз __create_user_reply_context DEBUG: Using verified flow, reply_id set to: aH00uNS3TVpOB4Znac5pxuzsI
ЁЯФз __create_user_reply_context DEBUG: Final reply_id being returned: aH00uNS3TVpOB4Znac5pxuzsI
ЁЯФз DEBUG: Created reply_context with reply_id: aH00uNS3TVpOB4Znac5pxuzsI
ЁЯУЛ User is inactive for 24 hours, preparing template message
ЁЯФз DEBUG: user_requests length: 1

=== QIKCHAT SEND_REQUESTS DEBUG ===
ЁЯУд Sending 1 requests
ЁЯУд Request 1: {'to_contact': '916352927215', 'type': 'template', 'template': {'name': 'bot_temp', 'language': 'hi', 'components': [{'type': 'body', 'parameters': [{'type': 'text', 'text': 'рдХреНрдпрд╛ рдореИрдВ рд░реЗрдбрд┐рдпреЛрдереЗрд░реЗрдкреА рд╕реЗ рдкрд╣рд▓реЗ рд╕реНрдирд╛рди рдХрд░ рд╕рдХрддрд╛ рд╣реВрдБ?'}, {'type': 'text', 'text': 'рд╣рд╛рдБ, рдЖрдк рд░реЗрдбрд┐рдпреЛрдереЗрд░реЗрдкреА рд╕реЗ рдкрд╣рд▓реЗ рд╕реНрдирд╛рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХ                     рдХрд┐рди рдЕрдкрдиреА рддреНрд╡рдЪрд╛ рдХреЗ рд╕рд╛рде рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдЙрдкрдЪрд╛рд░ рдХреНрд╖реЗрддреНрд░ рдореЗрдВ рдХреЛрдорд▓ рд░рд╣рдирд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИред рдЧреБрдирдЧреБрдиреЗ рдкрд╛рдиреА рдФрд░ рд╣рд▓реНрдХреЗ, рдмрд┐рдирд╛ рд╕реБрдЧрдВрдз рд╡рд╛рд▓реЗ рд╕рд╛рдмреБрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ, рдФрд░ рдЙрдкрдЪрд╛рд░ рдХреНрд╖реЗрддреНрд░ рдкрд░ рд╕рд╛                           рд╛рдмреБрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╕реЗ рдмрдЪреЗрдВред рдЕрдкрдиреА рддреНрд╡рдЪрд╛ рдХреЛ рдПрдХ рдирд░рдо рддреМрд▓рд┐рдпреЗ рд╕реЗ рдердкрдердкрд╛рдХрд░ рд╕реБрдЦрд╛рдПрдВ рдФрд░ рд░рдЧрдбрд╝рдиреЗ рд╕реЗ рдмрдЪреЗрдВред рдЙрдкрдЪрд╛рд░ рдХреЗ рджреМрд░рд╛рди рддреНрд╡рдЪрд╛ рдХреА рджреЗрдЦрднрд╛рд▓ рдХреЗ рд▓рд┐рдП рдЕрдкрдиреЗ рд╕реНрд╡рд╛рд╕реНрдереНрдп рд╕реЗрд╡рд╛ рдкреНрд░рджрд╛рддрд╛ рдХ                        рдХреА рдХрд┐рд╕реА рднреА рд╡рд┐рд╢реЗрд╖ рд╕рд┐рдлрд╛рд░рд┐рд╢ рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдВред'}]}]}}
ЁЯУд Got 1 results
ЁЯУд Result 1: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'nCcP6aFGx5UmkRESBMfGrBWYi', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '916352927215', 'credits': 0.2, 'created_at': '2025-12-23T10:30:38.099Z', 'status': 'processing'}]}
ЁЯУд Extracted message_id for result 1: nCcP6aFGx5UmkRESBMfGrBWYi
ЁЯУд Final message_ids: ['nCcP6aFGx5UmkRESBMfGrBWYi']
=== END QIKCHAT SEND_REQUESTS DEBUG ===

ЁЯУЛ Template message sent to inactive user: [{'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'nCcP6aFGx5UmkRESBMfGrBWYi', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '916352927215', 'credits': 0.2, 'created_at': '2025-12-23T10:30:38.099Z', 'status': 'processing'}]}]
ЁЯФз DEBUG: Created user message with bot_answer: 'Yes, you can take a bath before radiotherapy, but it's important to be gentle with your skin, especially in the treatment area. Use warm water and a mild, unscented soap, and avoid using soap on the treatment area itself. Pat your skin dry with a soft towel and avoid rubbing. Always follow any specific recommendations from your healthcare provider regarding skin care during treatment.'
ЁЯФз Including original expert message for storage: ID=Gy9vJy3QXsK7oS9X8Y6VviTOs
ЁЯФз Original expert message category: ('byoebexpert_to_bot',)
ЁЯУд Generated messages: 1 user, 1 expert
=== END EXPERT GENERATE RESPONSE DEBUG ===


=== EXPERT SEND RESPONSE DEBUG ===
ЁЯУи Processing 4 messages in send handler
ЁЯУи Message 1: user_type='byoebuser', category='bot_to_byoebuser_response'
ЁЯУи Message 2: user_type='byoebexpert', category='bot_to_byoebexpert'
ЁЯУи Message 3: user_type='None', category='read_receipt'
ЁЯУи Message 4: user_type='byoebexpert', category='('byoebexpert_to_bot',)'
ЁЯУи After filtering: 1 read receipts, 1 user messages, 2 expert messages

=== QIKCHAT SEND_REQUESTS DEBUG ===
ЁЯУд Sending 1 requests
ЁЯУд Request 1: {'to_contact': '919739811075', 'type': 'text', 'text': {'body': 'Thank you for verifiying the answer.'}, 'context': {'message_id': 'fqyRUqHjyAma4zg5JmnNDTNYr'}}
ЁЯУд Got 1 results
ЁЯУд Result 1: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'WQFEDYzstiJeylSnzaw3VXrfT', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '919739811075', 'credits': 0, 'created_at': '2025-12-23T10:30:38.284Z', 'status': 'processing'}]}
ЁЯУд Extracted message_id for result 1: WQFEDYzstiJeylSnzaw3VXrfT
ЁЯУд Final message_ids: ['WQFEDYzstiJeylSnzaw3VXrfT']
=== END QIKCHAT SEND_REQUESTS DEBUG ===

ЁЯФз EXPERT_ID_FIX: Updating expert message ID: 552627be-03f7-4846-96a4-7f86465bc28f -> WQFEDYzstiJeylSnzaw3VXrfT
ЁЯФД Updating expert message ID in database: 552627be-03f7-4846-96a4-7f86465bc28f -> WQFEDYzstiJeylSnzaw3VXrfT
ЁЯФД UPDATE_MESSAGE_ID: Starting ID update process
   Old ID: 552627be-03f7-4846-96a4-7f86465bc28f
   New ID: WQFEDYzstiJeylSnzaw3VXrfT
ЁЯФД UPDATE_MESSAGE_ID: Looking for document with old ID: 552627be-03f7-4846-96a4-7f86465bc28f
тЭМ UPDATE_MESSAGE_ID: Message with ID 552627be-03f7-4846-96a4-7f86465bc28f not found for update
ЁЯФН UPDATE_MESSAGE_ID: Checking if message exists in different format...
тЭМ UPDATE_MESSAGE_ID: Message not found in nested structure either
ЁЯУи Sending 1 user messages
ЁЯУд __handle_user: Processing 1 user messages
ЁЯФз __modify_user_messages_context: Processing 1 messages
ЁЯФз No audio messages found, fixing reply contexts for user messages
ЁЯФз Original reply_id: aH00uNS3TVpOB4Znac5pxuzsI
ЁЯФз Reply_id already looks like valid QikChat message ID, keeping it: aH00uNS3TVpOB4Znac5pxuzsI
ЁЯУд After modification: 1 messages to send
ЁЯУд Preparing request for message 1/1
ЁЯУд Message type: template_button
ЁЯУд Message source text length: 472
ЁЯУд Has reply_context: True
ЁЯУд Reply ID: aH00uNS3TVpOB4Znac5pxuzsI
ЁЯУд Successfully prepared 1 requests for message 1

=== QIKCHAT SEND_REQUESTS DEBUG ===
ЁЯУд Sending 1 requests
ЁЯУд Request 1: {'to_contact': '916352927215', 'type': 'template', 'template': {'name': 'bot_temp', 'language': 'hi', 'components': [{'type': 'body', 'parameters': [{'type': 'text', 'text': 'рдХреНрдпрд╛ рдореИрдВ рд░реЗрдбрд┐рдпреЛрдереЗрд░реЗрдкреА рд╕реЗ рдкрд╣рд▓реЗ рд╕реНрдирд╛рди рдХрд░ рд╕рдХрддрд╛ рд╣реВрдБ?'}, {'type': 'text', 'text': 'рд╣рд╛рдБ, рдЖрдк рд░реЗрдбрд┐рдпреЛрдереЗрд░реЗрдкреА рд╕реЗ рдкрд╣рд▓реЗ рд╕реНрдирд╛рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХ                     рдХрд┐рди рдЕрдкрдиреА рддреНрд╡рдЪрд╛ рдХреЗ рд╕рд╛рде рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдЙрдкрдЪрд╛рд░ рдХреНрд╖реЗрддреНрд░ рдореЗрдВ рдХреЛрдорд▓ рд░рд╣рдирд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИред рдЧреБрдирдЧреБрдиреЗ рдкрд╛рдиреА рдФрд░ рд╣рд▓реНрдХреЗ, рдмрд┐рдирд╛ рд╕реБрдЧрдВрдз рд╡рд╛рд▓реЗ рд╕рд╛рдмреБрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ, рдФрд░ рдЙрдкрдЪрд╛рд░ рдХреНрд╖реЗрддреНрд░ рдкрд░ рд╕рд╛                           рд╛рдмреБрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╕реЗ рдмрдЪреЗрдВред рдЕрдкрдиреА рддреНрд╡рдЪрд╛ рдХреЛ рдПрдХ рдирд░рдо рддреМрд▓рд┐рдпреЗ рд╕реЗ рдердкрдердкрд╛рдХрд░ рд╕реБрдЦрд╛рдПрдВ рдФрд░ рд░рдЧрдбрд╝рдиреЗ рд╕реЗ рдмрдЪреЗрдВред рдЙрдкрдЪрд╛рд░ рдХреЗ рджреМрд░рд╛рди рддреНрд╡рдЪрд╛ рдХреА рджреЗрдЦрднрд╛рд▓ рдХреЗ рд▓рд┐рдП рдЕрдкрдиреЗ рд╕реНрд╡рд╛рд╕реНрдереНрдп рд╕реЗрд╡рд╛ рдкреНрд░рджрд╛рддрд╛ рдХ                        рдХреА рдХрд┐рд╕реА рднреА рд╡рд┐рд╢реЗрд╖ рд╕рд┐рдлрд╛рд░рд┐рд╢ рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдВред'}]}]}}
ЁЯУд Got 1 results
ЁЯУд Result 1: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'hqpe9HxPJwXpVchIa8pS1eRoV', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '916352927215', 'credits': 0.2, 'created_at': '2025-12-23T10:30:39.057Z', 'status': 'processing'}]}
ЁЯУд Extracted message_id for result 1: hqpe9HxPJwXpVchIa8pS1eRoV
ЁЯУд Final message_ids: ['hqpe9HxPJwXpVchIa8pS1eRoV']
=== END QIKCHAT SEND_REQUESTS DEBUG ===

ЁЯУд Successfully sent message 1, got response: 1 items, message_id: ['hqpe9HxPJwXpVchIa8pS1eRoV']
ЁЯФз FINAL_ANSWER_ID_FIX: Updating 1 message IDs with QikChat IDs
ЁЯФз FINAL_ANSWER_ID_FIX: Available QikChat IDs: ['hqpe9HxPJwXpVchIa8pS1eRoV']
ЁЯФз FINAL_ANSWER_ID_FIX: Processing message 1
   - Original ID: 4b88ae2e-df9b-4201-a962-5cce31d40850
   - Has audio: False
   - Message type: template_button
ЁЯФз FINAL_ANSWER_ID_FIX: Message 1 ID updated: 4b88ae2e-df9b-4201-a962-5cce31d40850 -> hqpe9HxPJwXpVchIa8pS1eRoV
ЁЯУд No emoji found, skipping final reaction
ЁЯЧДя╕П __prepare_db_queries: Preparing queries for 1 user messages and 2 expert messages
ЁЯЧДя╕П AUDIO_DEBUG: Checking 1 user messages for audio processing
ЁЯЧДя╕П AUDIO_DEBUG: User message 1: ID=hqpe9HxPJwXpVchIa8pS1eRoV, has_audio=False
ЁЯЧДя╕П Added 1 user response messages for storage
ЁЯЧДя╕П Added 2 expert messages for storage

=== EXPERT HANDLER MESSAGE STORAGE DEBUG ===
ЁЯУК Total messages to store: 3
  1. ID: hqpe9HxPJwXpVchIa8pS1eRoV
     Category: bot_to_byoebuser_response
     Type: template_button
     Has Audio: False
     Text: 'Question: Can I take a bath before radiotherapy?
A...'
  2. ID: WQFEDYzstiJeylSnzaw3VXrfT
     Category: bot_to_byoebexpert
     Type: regular_text
     Has Audio: None
     Text: 'Thank you for verifiying the answer....'
  3. ID: Gy9vJy3QXsK7oS9X8Y6VviTOs
     Category: ('byoebexpert_to_bot',)
     Type: interactive_button_reply
     Has Audio: False
     Text: 'Yes...'
=== END EXPERT HANDLER DEBUG ===

ЁЯФН MESSAGE_CREATE_QUERIES: Processing 3 messages for database storage
ЁЯХТ TIMESTAMP_DEBUG Message 1/3: ID=hqpe9HxPJwXpVchIa8pS
   has_outgoing_timestamp: None
   outgoing_timestamp value: None
   final timestamp: 1766485838
   message_type: template_button
ЁЯФН MESSAGE_CREATE_QUERIES: Message 1
   Message ID: hqpe9HxPJwXpVchIa8pS1eRoV
   Message Type: template_button
   Message Class: Not classified
   Is Expert Verification: False
   QikChat Audio ID: None
   Text Preview: Question: Can I take a bath before radiotherapy?
Answer: Yes, you can take a bat...
ЁЯХТ TIMESTAMP_DEBUG Message 2/3: ID=WQFEDYzstiJeylSnzaw3
   has_outgoing_timestamp: None
   outgoing_timestamp value: None
   final timestamp: 1766485838
   message_type: regular_text
ЁЯФН MESSAGE_CREATE_QUERIES: Message 2
   Message ID: WQFEDYzstiJeylSnzaw3VXrfT
   Message Type: regular_text
   Message Class: Not classified
   Is Expert Verification: False
   QikChat Audio ID: None
   Text Preview: Thank you for verifiying the answer....
ЁЯХТ TIMESTAMP_DEBUG Message 3/3: ID=Gy9vJy3QXsK7oS9X8Y6V
   has_outgoing_timestamp: None
   outgoing_timestamp value: None
   final timestamp: 1766485838
   message_type: interactive_button_reply
C:\Users\t-asanghvi\AppData\Local\pypoetry\Cache\virtualenvs\byoeb-7XHC672s-py3.11\Lib\site-packages\pydantic\main.py:463: UserWarning: Pydantic serializer warnings:
  PydanticSerializationUnexpectedValue(Expected `str` - serialized value may not be as expected [input_value=('byoebexpert_to_bot',), input_type=tuple])       
  return self.__pydantic_serializer__.to_python(
ЁЯФН MESSAGE_CREATE_QUERIES: Message 3
   Message ID: Gy9vJy3QXsK7oS9X8Y6VviTOs
   Message Type: interactive_button_reply
   Message Class: Not classified
   Is Expert Verification: False
   QikChat Audio ID: None
   Text Preview: Yes...
ЁЯФН MESSAGE_CREATE_QUERIES: Generated 3 database create queries
ЁЯФН FINAL_QUERIES_DEBUG: About to return 3 queries:
   Query 1: ID=hqpe9HxPJwXpVchIa8pS1eRoV, has_text=True, has_audio=False
   Query 2: ID=WQFEDYzstiJeylSnzaw3VXrfT, has_text=True, has_audio=False
   Query 3: ID=Gy9vJy3QXsK7oS9X8Y6VviTOs, has_text=True, has_audio=False
ЁЯЧДя╕П Generated 3 CREATE queries
ЁЯЧДя╕П Calling correction_update_query
ЁЯЧДя╕П Calling verification_status_update_query
ЁЯЧДя╕П Generated 4 UPDATE queries
ЁЯЧДя╕П Database queries prepared successfully
=== END EXPERT SEND RESPONSE DEBUG ===

ЁЯФН PROCESSING RESULTS: Got 1 results from handlers
тЬЕ Result 0: MSG_CREATE=3, MSG_UPDATE=4, USER_CREATE=0, USER_UPDATE=1
Executing database queries - User updates: 1, Message creates: 3
ЁЯФН EXECUTE_QUERIES: Starting execution with queries: ['create', 'update']
ЁЯФН EXECUTE_QUERIES: Executing 3 CREATE operations
   CREATE 1: Message ID = hqpe9HxPJwXpVchIa8pS1eRoV
   CREATE 2: Message ID = WQFEDYzstiJeylSnzaw3VXrfT
   CREATE 3: Message ID = Gy9vJy3QXsK7oS9X8Y6VviTOs
Inserting documents: ['hqpe9HxPJwXpVchIa8pS1eRoV', 'WQFEDYzstiJeylSnzaw3VXrfT', 'Gy9vJy3QXsK7oS9X8Y6VviTOs']
тЬЕ EXECUTE_QUERIES: CREATE operations completed successfully
   Result: (['hqpe9HxPJwXpVchIa8pS1eRoV', 'WQFEDYzstiJeylSnzaw3VXrfT', 'Gy9vJy3QXsK7oS9X8Y6VviTOs'], None)
Database operations completed in 0.66 seconds
