=== QIKCHAT MESSAGE CONVERSION DEBUG ===
ğŸ“¥ Converting message: {
  "from": "916352927215",
  "timestamp": "2025-11-05T05:32:53.000Z",
  "text": {
    "body": "whatis cancer again?"
  },
  "type": "text",
  "id": "MLvW21NqBlyoyhTgYqVkOF0r5"
}
ğŸ“ Detected message type: text
âœ… Converting as regular message
ğŸ”— NO REPLY CONTEXT: 'context' not in message keys: ['from', 'timestamp', 'text', 'type', 'id']
=== NO MEDIA CONTEXT CREATED - message_audio is None ===
=== END QIKCHAT MESSAGE CONVERSION DEBUG ===

[DEBUG] Looking up users by phone_numbers: ['916352927215']
[DEBUG] get_users_by_phone_numbers called with phone_numbers: ['916352927215']
[DEBUG] Using collection: 'users'
C:\Users\t-asanghvi\AppData\Local\pypoetry\Cache\virtualenvs\byoeb-7XHC672s-py3.11\Lib\site-packages\motor\core.py:171: UserWarning: You appear to be connected to a CosmosDB cluster. For more information regarding feature compatibility and support please visit https://www.mongodb.com/supportability/cosmosdb
  delegate = self.__delegate_class__(*args, **kwargs)
[DEBUG] Raw users_obj from DB (by phone numbers): [{'_id': '002', 'User': {'user_id': '002', 'user_name': 'Akshat Sanghvi', 'user_location': {}, 'user_language': 'en', 'user_type': 'byoebuser', 'phone_number_id': '916352927215', 'test_user': False, 'experts': {'byoebexpert': ['919739811075'], 'byoebexpert2': ['919741363511']}, 'audience': [], 'patient_details': {'date_of_birth': '1985-03-15', 'gender': 'Male', 'age': 21}, 'created_timestamp': 1761388632, 'activity_timestamp': 1762320058, 'last_conversations': [{'question': 'what is cancer in 1 word?', 'answer': 'Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ask more questions.'}, {'question': 'what is radiotherapy?', 'answer': 'Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ask more questions.'}, {'question': 'what si cancer?', 'answer': 'Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ask more questions.'}]}, 'timestamp': '1761388632'}]
[DEBUG] Retrieved user by phone - user_id: '002', phone_number_id: '916352927215', user_name: 'Akshat Sanghvi', conversations: 3
ğŸ” GET_BOT_MESSAGES: Database returned 0 results
âŒ GET_BOT_MESSAGES: No messages found in database
ğŸ” Let's check what IDs actually exist in the database...
ğŸ” Recent messages in database (last hour): 27
   Recent 1: ID=JEY2t5C2RshqlQyMxEkGBqAPq, Text='what is cancer in 1 word?...'
   Recent 2: ID=KxiltXztJMBeqKX0h01Kr3E3b, Text='Let me check with a KMC doctor and get back to you...'
   Recent 3: ID=hBF2G1m05JVVJQALTd3AVMk7S, Text='Let me check with a KMC doctor and get back to you...'
âŒ Failed to get recent messages for debug: 'NoneType' object is not subscriptable
[DEBUG] Looking for user with phone_number_id: '916352927215' in 1 retrieved users
[DEBUG] Found existing user with user_id: '002', user_name: 'Akshat Sanghvi', phone_number_id: '916352927215', conversations: 3
ğŸ” PROCESSING MESSAGE: Category=byoebuser_to_bot, UserType=byoebuser
ğŸ” Message Text: whatis cancer again?
ğŸ” Added USER conversation to processing queue
ğŸ§µ Generated conversation_thread_id: thread_f5bb10ce5cea9fd5
ğŸ§µ Added conversation_thread_id to original user message: MLvW21NqBlyoyhTgYqVkOF0r5

=== RESPONSE GENERATION DEBUG ===
ğŸ“ Original message: 'whatis cancer again?'
ğŸ“¤ English message for KB: 'whatis cancer again?'
ğŸ‘¤ User: 916352927215 (language: en)

ğŸ” MULTI-KB SEARCH DEBUG:
ğŸ” Query: 'whatis cancer again?'
ğŸ” Searching 4 knowledge bases...
ğŸ” Searching KB1 (Q&A pairs) with filter: source eq 'oncobot_knowledge_base'
ğŸ” KB1 returned 3 Q&A results
ğŸ” Searching KB2 (Markdown) with filter: source eq 'kb2_content'
ğŸ” KB2 returned 2 Markdown results
ğŸ” Searching KB3 (Markdown) with filter: source eq 'kb3_content'
ğŸ” KB3 returned 2 Markdown results
ğŸ” Searching KB1_Expert (Expert Corrections) with filter: source eq 'oncobot_expert_knowledge_base'
ğŸ” KB1_Expert: No expert corrections available yet (will be populated as experts provide corrections)
ğŸ” Total chunks retrieved: 7 (KB1: 3, KB2: 2, KB3: 2, KB1_Expert: 0)

=== KB CONTEXT RETRIEVED (7 chunks) ===
Query: whatis cancer again?
Chunk 1:
  Question: What is cancer ?
  Source: oncobot_knowledge_base
  Content: Question: What is cancer ?
Answer: Cancer is a disease in which some cells of the body grow uncontrollably. They lose the ability to stop multiplying. It occurs due to multiple factors. This abnormal ...
  ---
  ...
=== END KB CONTEXT ===


=== FULL LLM INPUT DEBUG ===
Message 1 (system):
  Content: You are an expert oncology assistant helping cancer patients. Your purpose is to answer patients with any oncology-related queries they might have.

You have access to four knowledge bases:
- KB1: Q&A pairs covering general oncology topics
- KB2 & KB3: Detailed radiation therapy treatment guides and procedures
- KB1_Expert: Expert-validated corrections and high-priority answers (marked with [EXPERT-VALIDATED])

Guidelines for answering:
- USE [EXPERT-VALIDATED] content ONLY when it is directly r...
Message 2 (user):
  Content: The following knowledge base context has been retrieved from multiple sources to help answer your question. Content marked with [EXPERT-VALIDATED] has been specifically reviewed by medical professionals - use this content ONLY if it directly relates to the user's question:

KNOWLEDGE BASE CONTEXT:
Question: What is cancer ?
Answer: Cancer is a disease in which some cells of the body grow uncontrollably. They lose the ability to stop multiplying. It occurs due to multiple factors. This abnormal m...
ğŸ” Question being processed: 'whatis cancer again?'
ğŸ” Number of chunks: 7
=== END FULL LLM INPUT DEBUG ===


=== LLM RESPONSE DEBUG ===
ğŸ”¤ Raw LLM response_text: '<BEGIN RESPONSE>
Cancer is a disease where some cells in the body grow uncontrollably and lose the ability to stop multiplying. This abnormal growth can cause local symptoms like pain, bleeding, or difficulty swallowing, and may spread to other parts of the body. It's important to consult with your healthcare provider for personalized information and support.
<END RESPONSE>

<BEGIN QUERY TYPE>
medical
<END QUERY TYPE>'
ğŸ”¤ Response length: 421
ğŸ”¤ Contains 'Sorry': False
ğŸ”¤ Contains 'assist': False
=== END LLM RESPONSE DEBUG ===

Generated answer:  Cancer is a disease where some cells in the body grow uncontrollably and lose the ability to stop multiplying. This abnormal growth can cause local symptoms like pain, bleeding, or difficulty swallowing, and may spread to other parts of the body. It's important to consult with your healthcare provider for personalized information and support.
Query the type:  medical
finding here ['What are local symptoms of cancer?', 'How is radiation therapy administered?', 'What foods should be avoided during radiotherapy?']
ğŸ‘¨â€âš•ï¸ Using doctor waiting message for medical query
ğŸ”— DEBUG: Storing original user question ID for reply context: MLvW21NqBlyoyhTgYqVkOF0r5
ğŸ”¤ TRANSLATION DEBUG: About to translate message to en
ğŸ”¤ TRANSLATION DEBUG: Input text: 'Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ask more questions.'
ğŸ”¤ TRANSLATION DEBUG: Skipping translation - English target
ğŸ”¤ TRANSLATION DEBUG: Final result: 'Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ask more questions.'
ğŸ”¤ TRANSLATION DEBUG: Translation used: False
ï¿½ Creating user response message...
ğŸ”— Adding 3 follow-up questions to interactive list
ğŸ”— DEBUG: Creating reply context - user message ID: MLvW21NqBlyoyhTgYqVkOF0r5
ğŸ”— DEBUG: Created main waiting message reply context with reply_id: MLvW21NqBlyoyhTgYqVkOF0r5
ğŸ”— DEBUG: Main waiting message ID: 6881e6f7-2a8c-48e0-b9b5-1bcfdfdd86a4
ğŸµ Generating TTS audio again for message...
running tts now
running tts now again
ğŸ”§ SPEECH DEBUG - SUCCESS: Generated 119232 bytes of audio
ğŸ”§ TTS DEBUG - Received audio_bytes: <class 'bytes'>, length: 119232
running tts now again 2
ğŸµ TTS audio message generated successfully with SAS URL
ğŸ”— DEBUG: Audio message reply context reply_id: MLvW21NqBlyoyhTgYqVkOF0r5
ğŸ”— DEBUG: Audio message ID: 38972f82-78af-4b4f-8397-325bc7f6260b
ğŸ’¬ Returning 2 messages: ['interactive_list_reply', 'regular_audio']
âœ… Waiting messages sent to user (in en)
ğŸ‘¨â€âš•ï¸ Creating expert verification message...
expert result {'byoebexpert': ['919739811075'], 'byoebexpert2': ['919741363511']}
expert result 2 ('919739811075', 'byoebexpert') medical
ğŸ‘¨â€âš•ï¸ Using configured expert: 919739811075 (byoebexpert)
ğŸ†” Generated expert user_id: d7022499fc5fbcd34df184209477a79f from phone: 919739811075
ğŸ‘¤ Added patient context for expert: 2 lines
ğŸ”§ Expert additional_info template_language: en (type: <class 'str'>)
ğŸ“‹ Template parameters created:
  {1} Patient Info: Akshat Sanghvi, Age: 21, Gender: Male, DOB: 1985-03-15
  {2} Question: whatis cancer again?
  {3} Answer: Cancer is a disease where some cells in the body grow uncontrollably and lose the ability to stop multiplying. This abnormal growth can cause local symptoms like pain, bleeding, or difficulty swallowing, and may spread to other parts of the body. It's important to consult with your healthcare provider for personalized information and support.
ğŸ‘¨â€âš•ï¸ Expert message created with patient info in template format
âœ… Expert verification message created
ğŸ‰ Complete! Generated 4 messages (waiting messages to user + expert verification + read receipt)
ğŸ” MESSAGE BREAKDOWN: Total=4, User=2, Expert=1, ReadReceipt=1
ğŸ” User message 1: Type=interactive_list_reply, ID=6881e6f7-2a8c-48e0-b9b5-1bcfdfdd86a4
ğŸ” User message 2: Type=regular_audio, ID=38972f82-78af-4b4f-8397-325bc7f6260b
ğŸ”§ DEBUG: Using channel_type='qikchat' -> service=QikchatService
ğŸ’¬ Sending response: Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ...
ğŸ·ï¸ Query type: medical
ğŸ‘¨â€âš•ï¸ Found expert verification message for 919739811075
ğŸ“¤ Processing user message 1/2: interactive_list_reply
ğŸ” HANDLE_USER: Processing interactive_list_reply
Checking interactive list - has description: True, has row_texts: True, row_texts not None: True, result: True
ğŸ” HANDLE_USER: Prepared 1 requests

=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 1 requests
ğŸ“¤ Request 1: {'to_contact': '916352927215', 'type': 'interactive', 'interactive': {'type': 'list', 'body': {'text': 'Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ask more questions.'}, 'action': {'button': 'Related questions', 'sections': [{'title': '', 'rows': [{'id': 'option_0', 'title': 'Q1', 'description': 'What are local symptoms of cancer?'}, {'id': 'option_1', 'title': 'Q2', 'description': 'How is radiation therapy administered?'}, {'id': 'option_2', 'title': 'Q3', 'description': 'What foods should be avoided during radiotherapy?'}]}]}}, 'context': {'message_id': 'MLvW21NqBlyoyhTgYqVkOF0r5'}}      
ğŸ“¤ Got 1 results
ğŸ“¤ Result 1: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'gNGCoobKZzdbkQJujopLMYfqF', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '916352927215', 'credits': 0, 'created_at': '2025-11-05T05:33:49.810Z', 'status': 'processing'}]}
ğŸ“¤ Extracted message_id for result 1: gNGCoobKZzdbkQJujopLMYfqF
ğŸ“¤ Final message_ids: ['gNGCoobKZzdbkQJujopLMYfqF']
=== END QIKCHAT SEND_REQUESTS DEBUG ===


=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 0 requests
ğŸ“¤ Got 0 results
ğŸ“¤ Final message_ids: []
=== END QIKCHAT SEND_REQUESTS DEBUG ===

ğŸ“¤ Processing user message 2/2: regular_audio
ğŸ” HANDLE_USER: Processing regular_audio
Checking interactive list - has description: False, has row_texts: False, row_texts not None: False, result: False
ğŸµ Preparing audio message request (async)...
ğŸµ Using audio URL: https://smartkcstorage1.blob.core.windows.net/onco...
ğŸµ Audio message request prepared
ğŸ” HANDLE_USER: Prepared 1 requests
ğŸµ Sending audio message...
ğŸµ Audio message only (no follow-up questions)
ğŸµ Found 1 audio requests to send

=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 1 requests
ğŸ“¤ Request 1: {'to_contact': '916352927215', 'type': 'audio', 'audio': {'link': 'https://smartkcstorage1.blob.core.windows.net/oncobot-container/tts_audio_ca5e6717b0174312a9d47055d26a3b9f.mp3?st=2025-11-05T05%3A33%3A49Z&se=2025-11-05T06%3A33%3A49Z&sp=r&sv=2025-01-05&sr=b&skoid=f5b64d94-ba27-422a-abb5-cad2b511c671&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2025-11-05T05%3A33%3A49Z&ske=2025-11-05T06%3A33%3A49Z&sks=b&skv=2025-01-05&sig=8upWi8/ulf93MkdgzNFPe98pcsbsEcdNwVcovtB9Vz4%3D'}, 'context': {'message_id': 'MLvW21NqBlyoyhTgYqVkOF0r5'}}
ğŸ“¤ Got 1 results
ğŸ“¤ Result 1: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'Yav32x1XgmmblYpgu4vLPXKBa', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '916352927215', 'credits': 0, 'created_at': '2025-11-05T05:33:49.985Z', 'status': 'processing'}]}
ğŸ“¤ Extracted message_id for result 1: Yav32x1XgmmblYpgu4vLPXKBa
ğŸ“¤ Final message_ids: ['Yav32x1XgmmblYpgu4vLPXKBa']
=== END QIKCHAT SEND_REQUESTS DEBUG ===


=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 0 requests
ğŸ“¤ Got 0 results
ğŸ“¤ Final message_ids: []
=== END QIKCHAT SEND_REQUESTS DEBUG ===

ğŸ”§ Handling expert message for: 919739811075
ğŸ”§ Expert user_id: d7022499fc5fbcd34df184209477a79f
Last active duration 752.861728
Cached False
ğŸ”§ Expert is_active_user: True
ğŸ”˜ Sending interactive button to active expert

=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 1 requests
ğŸ“¤ Request 1: {'to_contact': '919739811075', 'type': 'interactive', 'interactive': {'type': 'button', 'body': {'text': "*Patient Info*: Akshat Sanghvi, Age: 21, Gender: Male, DOB: 1985-03-15\n\n*Question:* whatis cancer again?\n*Answer:* Cancer is a disease where some cells in the body grow uncontrollably and lose the ability to stop multiplying. This abnormal growth can cause local symptoms like pain, bleeding, or difficulty swallowing, and may spread to other parts of the body. It's important to consult with your healthcare provider for personalized information and support.\n\nIs the answer correct?"}, 'action': {'buttons': [{'type': 'reply', 'reply': {'id': '9d538364-54f6-4465-b46d-9387cd829a8a', 'title': 'Yes'}}, {'type': 'reply', 'reply': {'id': '298584ad-61d7-4e48-9c0f-151f53c85a6d', 'title': 'No'}}]}}}
ğŸ“¤ Got 1 results
ğŸ“¤ Result 1: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'bSuGY19YSkuRX6nHGoPgwhHKX', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '919739811075', 'credits': 0, 'created_at': '2025-11-05T05:33:50.447Z', 'status': 'processing'}]}
ğŸ“¤ Extracted message_id for result 1: bSuGY19YSkuRX6nHGoPgwhHKX
ğŸ“¤ Final message_ids: ['bSuGY19YSkuRX6nHGoPgwhHKX']
=== END QIKCHAT SEND_REQUESTS DEBUG ===

responses [{'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'bSuGY19YSkuRX6nHGoPgwhHKX', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '919739811075', 'credits': 0, 'created_at': '2025-11-05T05:33:50.447Z', 'status': 'processing'}]}]
ğŸ“Œ Skipping emoji reaction (emoji is None)

=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 0 requests
ğŸ“¤ Got 0 results
ğŸ“¤ Final message_ids: []
=== END QIKCHAT SEND_REQUESTS DEBUG ===

âœ… Sent 2 user messages and expert verifier message!
âœ… Response sent successfully!
ğŸ” CREATE_CONV DEBUG:
   byoeb_user_message.message_context.message_id: 6881e6f7-2a8c-48e0-b9b5-1bcfdfdd86a4
   byoeb_user_message.reply_context.reply_id: MLvW21NqBlyoyhTgYqVkOF0r5
ğŸ”— REPLY_CONTEXT_FIX: Using reply_context.reply_id as original user question ID: MLvW21NqBlyoyhTgYqVkOF0r5
ğŸ”— REPLY_CONTEXT_FIX: Bot message 1 reply_id set to: MLvW21NqBlyoyhTgYqVkOF0r5 (QikChat ID: gNGCoobKZzdbkQJujopLMYfqF)
ğŸ”— REPLY_CONTEXT_FIX: Bot message 2 reply_id set to: MLvW21NqBlyoyhTgYqVkOF0r5 (QikChat ID: Yav32x1XgmmblYpgu4vLPXKBa)
ğŸ”§ EXPERT MESSAGE ID DEBUG:
   Original expert ID: b89fd2ba-7846-4e23-8717-3fc6fa849481
   Expert responses count: 1
   First expert response: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'bSuGY19YSkuRX6nHGoPgwhHKX', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '919739811075', 'credits': 0, 'created_at': '2025-11-05T05:33:50.447Z', 'status': 'processing'}]}
ğŸ”§ CREATE_CROSS_CONV: Processing 1 expert responses
ğŸ”§ CREATE_CROSS_CONV: Expert response 1: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'bSuGY19YSkuRX6nHGoPgwhHKX', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '919739811075', 'credits': 0, 'created_at': '2025-11-05T05:33:50.447Z', 'status': 'processing'}]}
ğŸ”§ CREATE_CROSS_CONV: Top-level message ID: None
ğŸ”§ CREATE_CROSS_CONV: Checking data array with 1 items
ğŸ”§ CREATE_CROSS_CONV: Found message ID in data[0]: bSuGY19YSkuRX6nHGoPgwhHKX
ğŸ”§ CREATE_CROSS_CONV: Final extracted expert message ID: bSuGY19YSkuRX6nHGoPgwhHKX
ğŸ”§ CREATE_CROSS_CONV: Original expert message ID: b89fd2ba-7846-4e23-8717-3fc6fa849481
ğŸ”§ CREATE_CROSS_CONV: Updated expert message ID: b89fd2ba-7846-4e23-8717-3fc6fa849481 -> bSuGY19YSkuRX6nHGoPgwhHKX
ğŸ”§ CREATE_CROSS_CONV: Expert message will be stored with Qikchat ID: bSuGY19YSkuRX6nHGoPgwhHKX
ğŸ”§ CREATE_CROSS_CONV: Returning 3 messages for database storage
   Message 1: ID=b8d87e42-b55c-4399-b042-fc8c25ef56b7, Type=interactive_list_reply, Text='...'
   Message 2: ID=deab52be-630e-4440-a126-dd4d637bc8a0, Type=interactive_list_reply, Text='...'
   Message 3: ID=bSuGY19YSkuRX6nHGoPgwhHKX, Type=interactive_button_reply, Text='*Patient Info*: Akshat Sanghvi, Age: 21, Gender: M...'
   Expert ID after create_cross_conv: bSuGY19YSkuRX6nHGoPgwhHKX
   ID changed: True
   â„¹ï¸ Expert message will be stored in database with correct QikChat ID: bSuGY19YSkuRX6nHGoPgwhHKX
ğŸ“ Using original message ID from reply context: MLvW21NqBlyoyhTgYqVkOF0r5
ğŸ”§ Created USER_TO_BOT message:
   ID: MLvW21NqBlyoyhTgYqVkOF0r5
   Text: 'whatis cancer again?...'

=== USER HANDLER MESSAGE STORAGE DEBUG ===
ğŸ“Š Total conversations to store: 6
  1. ID: MLvW21NqBlyoyhTgYqVkOF0r5
     Category: byoebuser_to_bot
     Type: interactive_list_reply
     Text: 'whatis cancer again?...'
  2. ID: gNGCoobKZzdbkQJujopLMYfqF
     Category: bot_to_byoebuser_response
     Type: interactive_list_reply
     Text: 'Let me check with a KMC doctor and get back to you...'
  3. ID: Yav32x1XgmmblYpgu4vLPXKBa
     Category: bot_to_byoebuser_response
     Type: interactive_list_reply
     Text: 'Let me check with a KMC doctor and get back to you...'
  4. ID: b8d87e42-b55c-4399-b042-fc8c25ef56b7
     Category: None
     Type: interactive_list_reply
     Text: '...'
  5. ID: deab52be-630e-4440-a126-dd4d637bc8a0
     Category: None
     Type: interactive_list_reply
     Text: '...'
  6. ID: bSuGY19YSkuRX6nHGoPgwhHKX
     Category: bot_to_byoebexpert_verification
     Type: interactive_button_reply
     Text: '*Patient Info*: Akshat Sanghvi, Age: 21, Gender: M...'
=== END USER HANDLER DEBUG ===

ğŸ” MESSAGE_CREATE_QUERIES: Processing 6 messages for database storage
ğŸ” MESSAGE_CREATE_QUERIES: Message 1
   Message ID: MLvW21NqBlyoyhTgYqVkOF0r5
   Message Type: interactive_list_reply
   Conversation Thread ID: None
   Is Expert Verification: False
   Text Preview: whatis cancer again?...
ğŸ” MESSAGE_CREATE_QUERIES: Message 2
   Message ID: gNGCoobKZzdbkQJujopLMYfqF
   Message Type: interactive_list_reply
   Conversation Thread ID: None
   Is Expert Verification: False
   Text Preview: Let me check with a KMC doctor and get back to you with a verified answer. Until...
ğŸ” MESSAGE_CREATE_QUERIES: Message 3
   Message ID: Yav32x1XgmmblYpgu4vLPXKBa
   Message Type: interactive_list_reply
   Conversation Thread ID: None
   Is Expert Verification: False
   Text Preview: Let me check with a KMC doctor and get back to you with a verified answer. Until...
ğŸ” MESSAGE_CREATE_QUERIES: Message 4
   Message ID: b8d87e42-b55c-4399-b042-fc8c25ef56b7
   Message Type: interactive_list_reply
   Conversation Thread ID: None
   Is Expert Verification: None
   Text Preview: ...
ğŸ” MESSAGE_CREATE_QUERIES: Message 5
   Message ID: deab52be-630e-4440-a126-dd4d637bc8a0
   Message Type: interactive_list_reply
   Conversation Thread ID: None
   Is Expert Verification: None
   Text Preview: ...
ğŸ” MESSAGE_CREATE_QUERIES: Message 6
   Message ID: bSuGY19YSkuRX6nHGoPgwhHKX
   Message Type: interactive_button_reply
   Conversation Thread ID: None
   Is Expert Verification: True
   Text Preview: *Patient Info*: Akshat Sanghvi, Age: 21, Gender: Male, DOB: 1985-03-15

*Questio...
ğŸ” MESSAGE_CREATE_QUERIES: Generated 6 database create queries
Saving conversation history: Q: whatis cancer again? | A: Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ...      
ğŸ” PROCESSING RESULTS: Got 1 results from handlers
âœ… Result 0: MSG_CREATE=6, MSG_UPDATE=0, USER_CREATE=0, USER_UPDATE=1
Executing database queries - User updates: 1, Message creates: 6
ğŸ” EXECUTE_QUERIES: Starting execution with queries: ['create', 'update']
ğŸ” EXECUTE_QUERIES: Executing 6 CREATE operations
   CREATE 1: Message ID = MLvW21NqBlyoyhTgYqVkOF0r5
   CREATE 2: Message ID = gNGCoobKZzdbkQJujopLMYfqF
   CREATE 3: Message ID = Yav32x1XgmmblYpgu4vLPXKBa
   CREATE 4: Message ID = b8d87e42-b55c-4399-b042-fc8c25ef56b7
   CREATE 5: Message ID = deab52be-630e-4440-a126-dd4d637bc8a0
   CREATE 6: Message ID = bSuGY19YSkuRX6nHGoPgwhHKX
âœ… EXECUTE_QUERIES: CREATE operations completed successfully
   Result: (['MLvW21NqBlyoyhTgYqVkOF0r5', 'gNGCoobKZzdbkQJujopLMYfqF', 'Yav32x1XgmmblYpgu4vLPXKBa', 'b8d87e42-b55c-4399-b042-fc8c25ef56b7', 'deab52be-630e-4440-a126-dd4d637bc8a0', 'bSuGY19YSkuRX6nHGoPgwhHKX'], None)
Database operations completed in 0.68 seconds
hi there
DEBUG PRODUCER: Message ID in message: None
DEBUG PRODUCER: Payload ID: gOkOmShezg2YkfSGa0zHYm1kR
DEBUG PRODUCER: Using payload ID as fallback: gOkOmShezg2YkfSGa0zHYm1kR

=== QIKCHAT MESSAGE CONVERSION DEBUG ===
ğŸ“¥ Converting message: {
  "from": "919739811075",
  "timestamp": "2025-11-05T05:34:02.000Z",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "9d538364-54f6-4465-b46d-9387cd829a8a",
      "title": "Yes"
    }
  },
  "type": "interactive",
  "context": {
    "messageId": "bSuGY19YSkuRX6nHGoPgwhHKX"
  },
  "id": "gOkOmShezg2YkfSGa0zHYm1kR"
}
ğŸ“ Detected message type: interactive
ğŸ”˜ Converting as interactive message
ğŸ” Interactive context data found: {'messageId': 'bSuGY19YSkuRX6nHGoPgwhHKX'}
ğŸ”— INTERACTIVE REPLY CONTEXT FOUND: reply_to_message_id = bSuGY19YSkuRX6nHGoPgwhHKX
âœ… Interactive conversion successful
   - Reply ID: bSuGY19YSkuRX6nHGoPgwhHKX
=== END QIKCHAT MESSAGE CONVERSION DEBUG ===

[DEBUG] Looking up users by phone_numbers: ['919739811075']
[DEBUG] get_users_by_phone_numbers called with phone_numbers: ['919739811075']
[DEBUG] Using collection: 'users'
[DEBUG] Raw users_obj from DB (by phone numbers): [{'_id': 'd7022499fc5fbcd34df184209477a79f', 'User': {'user_id': 'd7022499fc5fbcd34df184209477a79f', 'user_name': None, 'user_location': {}, 'user_language': 'en', 'user_type': 'byoebexpert', 'phone_number_id': '919739811075', 'test_user': False, 'experts': {}, 'audience': ['918123273694', '916352927215', '918375066113', '918861000105'], 'patient_details': {}, 'created_timestamp': 1759916945, 'activity_timestamp': 1762320078, 'last_conversations': []}, 'timestamp': '1759916945'}]
[DEBUG] Retrieved user by phone - user_id: 'd7022499fc5fbcd34df184209477a79f', phone_number_id: '919739811075', user_name: 'None', conversations: 0
ğŸ” GET_BOT_MESSAGES: Database returned 1 results
âœ… GET_BOT_MESSAGES: Found matching messages
   Found 1: ID=bSuGY19YSkuRX6nHGoPgwhHKX
ğŸ¤– Bot message 0: ID=bSuGY19YSkuRX6nHGoPgwhHKX
[DEBUG] Looking for user with phone_number_id: '919739811075' in 1 retrieved users
[DEBUG] Found existing user with user_id: 'd7022499fc5fbcd34df184209477a79f', user_name: 'None', phone_number_id: '919739811075', conversations: 0
ï¿½ Expert message debug - reply_id: bSuGY19YSkuRX6nHGoPgwhHKX, bot_message found: True
ğŸ” Reply context exists: reply_id=bSuGY19YSkuRX6nHGoPgwhHKX
ğŸ” PROCESSING MESSAGE: Category=('byoebexpert_to_bot',), UserType=byoebexpert
ğŸ” Message Text: Yes
ğŸ” Added EXPERT conversation to processing queue

=== EXPERT MESSAGE CONSUMER DEBUG ===
ğŸ‘¨â€âš•ï¸ Processing expert message from: 919739811075
ğŸ’¬ Message text: 'Yes'
ğŸ“ Message type: interactive_button_reply
ğŸ”— Reply ID: bSuGY19YSkuRX6nHGoPgwhHKX
ğŸ”— Reply additional info: {'verification_status': 'pending'}
=== END EXPERT MESSAGE CONSUMER DEBUG ===


=== EXPERT GENERATE RESPONSE DEBUG ===
ğŸ“§ Processing expert message from: 919739811075
ğŸ’¬ Message text: 'Yes'
ğŸ“ Message type: interactive_button_reply
ğŸ”— Reply context exists: True
ğŸ”— Reply ID: bSuGY19YSkuRX6nHGoPgwhHKX
ğŸ”— Reply message category: bot_to_byoebexpert_verification
ğŸ”— Reply additional_info keys: ['verification_status']
ğŸ”— Verification status: pending
âœ… Branch: Expert clicked YES - sending approved answer to user and thank you to expert
ğŸ”§ DEBUG: Original verification text: '*Patient Info*: Akshat Sanghvi, Age: 21, Gender: Male, DOB: 1985-03-15

*Question:* whatis cancer again?
*Answer:* Cancer is a disease where some cells in the body grow uncontrollably and lose the ability to stop multiplying. This abnormal growth can cause local symptoms like pain, bleeding, or difficulty swallowing, and may spread to other parts of the body. It's important to consult with your healthcare provider for personalized information and support.

Is the answer correct?'
ğŸ”§ DEBUG: Parsed verification message: {}
âŒ ERROR: Bot_Answer not found in parsed message. Available keys: []
ğŸ”§ DEBUG: Attempting alternative parsing...
ğŸ”§ DEBUG: Alternative parsed message: {'Question': '*Patient Info*: Akshat Sanghvi, Age: 21, Gender: Male, DOB: 1985-03-15', 'Bot_Answer': "*Question:* whatis cancer again?\n*Answer:* Cancer is a disease where some cells in the body grow uncontrollably and lose the ability to stop multiplying. This abnormal growth can cause local symptoms like pain, bleeding, or difficulty swallowing, and may spread to other parts of the body. It's important to consult with your healthcare provider for personalized information and support."}
ğŸ”§ DEBUG: Final extracted question: '*Patient Info*: Akshat Sanghvi, Age: 21, Gender: Male, DOB: 1985-03-15' bot_answer: '*Question:* whatis cancer again?
*Answer:* Cancer is a disease where some cells in the body grow uncontrollably and lose the ability to stop multiplying. This abnormal growth can cause local symptoms like pain, bleeding, or difficulty swallowing, and may spread to other parts of the body. It's important to consult with your healthcare provider for personalized information and support.'
ğŸ”§ DEBUG: Expert thank you message: 'Thank you for verifiying the answer.'
ğŸ”§ DEBUG: Created expert message with text: 'Thank you for verifiying the answer.'
Translating bot answer to user's language: en
ğŸ”§ SPEECH DEBUG - SUCCESS: Generated 362880 bytes of audio
ğŸ”§ TTS DEBUG - Received audio_bytes: <class 'bytes'>, length: 362880
ğŸ”§ DEBUG: Audio message generated successfully for YES flow with SAS URL
Last active duration 26.235185
Cached False
ğŸ”§ User 002 is_active_user: True
ğŸ”§ DEBUG: Using last message in conversation context: deab52be-630e-4440-a126-dd4d637bc8a0
ğŸ”§ DEBUG: Last message category: 'None'
ğŸ”§ __create_user_reply_context DEBUG: status=verified, cross_conv_message has reply_context=True
ğŸ”§ __create_user_reply_context DEBUG: cross_conv_message.reply_context.reply_id=MLvW21NqBlyoyhTgYqVkOF0r5
ğŸ”§ __create_user_reply_context DEBUG: additional_info exists=False
ğŸ”§ __create_user_reply_context DEBUG: additional_info is None!
ğŸ”§ __create_user_reply_context DEBUG: Checking verified condition:
  - status == constants.VERIFIED: True (status='verified', VERIFIED='verified')
  - reply_context is not None: True
  - additional_info is not None: False
ğŸ”§ __create_user_reply_context DEBUG: Using verified flow, reply_id set to: MLvW21NqBlyoyhTgYqVkOF0r5
ğŸ”§ __create_user_reply_context DEBUG: Final reply_id being returned: MLvW21NqBlyoyhTgYqVkOF0r5
ğŸ”§ DEBUG: Created reply_context with reply_id: MLvW21NqBlyoyhTgYqVkOF0r5
ğŸ”˜ User is active, will send regular message through normal flow
ğŸ”§ DEBUG: Created user message with bot_answer: '*Question:* whatis cancer again?
*Answer:* Cancer is a disease where some cells in the body grow uncontrollably and lose the ability to stop multiplying. This abnormal growth can cause local symptoms like pain, bleeding, or difficulty swallowing, and may spread to other parts of the body. It's important to consult with your healthcare provider for personalized information and support.'
ğŸ”§ Including original expert message for storage: ID=gOkOmShezg2YkfSGa0zHYm1kR
ğŸ”§ Original expert message category: ('byoebexpert_to_bot',)
ğŸ“¤ Generated messages: 1 user, 1 expert
=== END EXPERT GENERATE RESPONSE DEBUG ===


=== EXPERT SEND RESPONSE DEBUG ===
ğŸ“¨ Processing 4 messages in send handler
ğŸ“¨ Message 1: user_type='byoebuser', category='bot_to_byoebuser_response'
ğŸ“¨ Message 2: user_type='byoebexpert', category='bot_to_byoebexpert'
ğŸ“¨ Message 3: user_type='None', category='read_receipt'
ğŸ“¨ Message 4: user_type='byoebexpert', category='('byoebexpert_to_bot',)'
ğŸ“¨ After filtering: 1 read receipts, 1 user messages, 2 expert messages

=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 1 requests
ğŸ“¤ Request 1: {'to_contact': '919739811075', 'type': 'text', 'text': {'body': 'Thank you for verifiying the answer.'}, 'context': {'message_id': 'bSuGY19YSkuRX6nHGoPgwhHKX'}}
ğŸ“¤ Got 1 results
ğŸ“¤ Result 1: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'K5XUxm1MMQgXu0LgYPjBueFKb', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '919739811075', 'credits': 0, 'created_at': '2025-11-05T05:34:16.836Z', 'status': 'processing'}]}
ğŸ“¤ Extracted message_id for result 1: K5XUxm1MMQgXu0LgYPjBueFKb
ğŸ“¤ Final message_ids: ['K5XUxm1MMQgXu0LgYPjBueFKb']
=== END QIKCHAT SEND_REQUESTS DEBUG ===

ğŸ“¨ Sending 1 user messages
ğŸ“¤ __handle_user: Processing 1 user messages
ğŸ”§ __modify_user_messages_context: Processing 1 messages
ğŸ”§ No audio messages found, fixing reply contexts for user messages
ğŸ”§ Original reply_id: MLvW21NqBlyoyhTgYqVkOF0r5
ğŸ”§ Reply_id already looks like valid QikChat message ID, keeping it: MLvW21NqBlyoyhTgYqVkOF0r5
ğŸ“¤ After modification: 1 messages to send
ğŸ“¤ Preparing request for message 1/1
ğŸ“¤ Message type: regular_text
ğŸ“¤ Message source text length: 387
ğŸ“¤ Has reply_context: True
ğŸ“¤ Reply ID: MLvW21NqBlyoyhTgYqVkOF0r5
Checking interactive list - has description: False, has row_texts: False, row_texts not None: False, result: False
ğŸµ Preparing audio message request (async)...
ğŸµ Using audio URL: https://smartkcstorage1.blob.core.windows.net/onco...
ğŸµ Audio message request prepared
ğŸ“¤ Successfully prepared 2 requests for message 1

=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 2 requests
ğŸ“¤ Request 1: {'to_contact': '916352927215', 'type': 'text', 'text': {'body': "*Question:* whatis cancer again?\n*Answer:* Cancer is a disease where some cells in the body grow uncontrollably and lose the ability to stop multiplying. This abnormal growth can cause local symptoms like pain, bleeding, or difficulty swallowing, and may spread to other parts of the body. It's important to consult with your healthcare provider for personalized information and support."}, 'context': {'message_id': 'MLvW21NqBlyoyhTgYqVkOF0r5'}}
ğŸ“¤ Request 2: {'to_contact': '916352927215', 'type': 'audio', 'audio': {'link': 'https://smartkcstorage1.blob.core.windows.net/oncobot-container/tts_audio_faaaed3665984b79bea2fa4640bcbbd4.mp3?st=2025-11-05T05%3A34%3A15Z&se=2025-11-05T06%3A34%3A15Z&sp=r&sv=2025-01-05&sr=b&skoid=f5b64d94-ba27-422a-abb5-cad2b511c671&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2025-11-05T05%3A34%3A15Z&ske=2025-11-05T06%3A34%3A15Z&sks=b&skv=2025-01-05&sig=U6oJRWFmZKNC24EdCSe7etR5T9AWkONegIEcd%2B8%2Bg6k%3D'}, 'context': {'message_id': 'MLvW21NqBlyoyhTgYqVkOF0r5'}}
ğŸ“¤ Got 2 results
ğŸ“¤ Result 1: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': '5OxIsE9n3OaXw8PeJVLlrb6sS', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '916352927215', 'credits': 0, 'created_at': '2025-11-05T05:34:17.014Z', 'status': 'processing'}]}
ğŸ“¤ Result 2: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'GxxBXdhWgRB8C5BXVLfmcdsw5', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '916352927215', 'credits': 0, 'created_at': '2025-11-05T05:34:17.011Z', 'status': 'processing'}]}
ğŸ“¤ Extracted message_id for result 1: 5OxIsE9n3OaXw8PeJVLlrb6sS
ğŸ“¤ Extracted message_id for result 2: GxxBXdhWgRB8C5BXVLfmcdsw5
ğŸ“¤ Final message_ids: ['5OxIsE9n3OaXw8PeJVLlrb6sS', 'GxxBXdhWgRB8C5BXVLfmcdsw5']
=== END QIKCHAT SEND_REQUESTS DEBUG ===

ğŸ“¤ Successfully sent message 1, got response: 2 items, message_id: ['5OxIsE9n3OaXw8PeJVLlrb6sS', 'GxxBXdhWgRB8C5BXVLfmcdsw5']
ğŸ”§ FINAL_ANSWER_ID_FIX: Updating 1 message IDs with QikChat IDs
ğŸ”§ FINAL_ANSWER_ID_FIX: Available QikChat IDs: ['5OxIsE9n3OaXw8PeJVLlrb6sS', 'GxxBXdhWgRB8C5BXVLfmcdsw5']
ğŸ”§ FINAL_ANSWER_ID_FIX: Processing message 1
   - Original ID: 145a563b-caeb-4cb6-b307-04dc131df3e7
   - Has audio: True
   - Message type: regular_text
ğŸ”§ FINAL_ANSWER_ID_FIX: Text+Audio message detected
   - Text QikChat ID: 5OxIsE9n3OaXw8PeJVLlrb6sS
   - Audio QikChat ID: GxxBXdhWgRB8C5BXVLfmcdsw5
ğŸ”§ FINAL_ANSWER_ID_FIX: Stored audio ID in additional_info: GxxBXdhWgRB8C5BXVLfmcdsw5
ğŸ”§ FINAL_ANSWER_ID_FIX: Message 1 ID updated: 145a563b-caeb-4cb6-b307-04dc131df3e7 -> 5OxIsE9n3OaXw8PeJVLlrb6sS (text), audio ID: GxxBXdhWgRB8C5BXVLfmcdsw5
ğŸ“¤ No emoji found, skipping final reaction
ğŸ—„ï¸ __prepare_db_queries: Preparing queries for 1 user messages and 2 expert messages
ğŸ—„ï¸ AUDIO_DEBUG: Checking 1 user messages for audio processing
ğŸ—„ï¸ AUDIO_DEBUG: User message 1: ID=5OxIsE9n3OaXw8PeJVLlrb6sS, has_audio=True
ğŸ—„ï¸ Added 1 user response messages for storage
ğŸ—„ï¸ Added 2 expert messages for storage

=== EXPERT HANDLER MESSAGE STORAGE DEBUG ===
ğŸ“Š Total messages to store: 3
  1. ID: 5OxIsE9n3OaXw8PeJVLlrb6sS
     Category: bot_to_byoebuser_response
     Type: regular_text
     Has Audio: True
     QikChat Audio ID: GxxBXdhWgRB8C5BXVLfmcdsw5
     Text: '*Question:* whatis cancer again?
*Answer:* Cancer ...'
  2. ID: aef88871-214c-4b31-accd-1f61796e0ba2
     Category: bot_to_byoebexpert
     Type: regular_text
     Has Audio: None
     Text: 'Thank you for verifiying the answer....'
  3. ID: gOkOmShezg2YkfSGa0zHYm1kR
     Category: ('byoebexpert_to_bot',)
     Type: interactive_button_reply
     Has Audio: False
     Text: 'Yes...'
=== END EXPERT HANDLER DEBUG ===

ğŸ” MESSAGE_CREATE_QUERIES: Processing 3 messages for database storage
ğŸ” MESSAGE_CREATE_QUERIES: Message 1
   Message ID: 5OxIsE9n3OaXw8PeJVLlrb6sS
   Message Type: regular_text
   Conversation Thread ID: None
   Is Expert Verification: False
   Text Preview: *Question:* whatis cancer again?
*Answer:* Cancer is a disease where some cells ...
ğŸ” MESSAGE_CREATE_QUERIES: Message 2
   Message ID: aef88871-214c-4b31-accd-1f61796e0ba2
   Message Type: regular_text
   Conversation Thread ID: None
   Is Expert Verification: False
   Text Preview: Thank you for verifiying the answer....
C:\Users\t-asanghvi\AppData\Local\pypoetry\Cache\virtualenvs\byoeb-7XHC672s-py3.11\Lib\site-packages\pydantic\main.py:463: UserWarning: Pydantic serializer warnings:  
  PydanticSerializationUnexpectedValue(Expected `str` - serialized value may not be as expected [input_value=('byoebexpert_to_bot',), input_type=tuple])
  return self.__pydantic_serializer__.to_python(
ğŸ” MESSAGE_CREATE_QUERIES: Message 3
   Message ID: gOkOmShezg2YkfSGa0zHYm1kR
   Message Type: interactive_button_reply
   Conversation Thread ID: None
   Is Expert Verification: False
   Text Preview: Yes...
ğŸ” MESSAGE_CREATE_QUERIES: Generated 3 database create queries
ğŸ—„ï¸ Generated 3 CREATE queries
ğŸ—„ï¸ Calling correction_update_query
ğŸ—„ï¸ Calling verification_status_update_query
ğŸ—„ï¸ Generated 4 UPDATE queries
ğŸ—„ï¸ Database queries prepared successfully
=== END EXPERT SEND RESPONSE DEBUG ===

ğŸ” PROCESSING RESULTS: Got 1 results from handlers
âœ… Result 0: MSG_CREATE=3, MSG_UPDATE=4, USER_CREATE=0, USER_UPDATE=1
Executing database queries - User updates: 1, Message creates: 3
ğŸ” EXECUTE_QUERIES: Starting execution with queries: ['create', 'update']
ğŸ” EXECUTE_QUERIES: Executing 3 CREATE operations
   CREATE 1: Message ID = 5OxIsE9n3OaXw8PeJVLlrb6sS
   CREATE 2: Message ID = aef88871-214c-4b31-accd-1f61796e0ba2
   CREATE 3: Message ID = gOkOmShezg2YkfSGa0zHYm1kR
âœ… EXECUTE_QUERIES: CREATE operations completed successfully
   Result: (['5OxIsE9n3OaXw8PeJVLlrb6sS', 'aef88871-214c-4b31-accd-1f61796e0ba2', 'gOkOmShezg2YkfSGa0zHYm1kR'], None)
Database operations completed in 0.79 seconds