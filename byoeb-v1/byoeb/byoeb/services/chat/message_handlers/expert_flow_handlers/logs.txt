DEBUG PRODUCER: Message ID in message: None
DEBUG PRODUCER: Payload ID: D2ZWG01Xhb3gdvlj5SZd3IUqO
DEBUG PRODUCER: Using payload ID as fallback: D2ZWG01Xhb3gdvlj5SZd3IUqO

=== QIKCHAT MESSAGE CONVERSION DEBUG ===
ğŸ“¥ Converting message: {
  "from": "916352927215",
  "timestamp": "2025-11-12T05:44:08.000Z",
  "text": {
    "body": "\u0915\u094d\u092f\u093e \u092e\u0948\u0902 \u0930\u0947\u0921\u093f\u092f\u094b\u0925\u0947\u0930\u0947\u092a\u0940 \u0915\u0947 \u092c\u093e\u0926 \u0938\u094d\u0928\u093e\u0928 \u0915\u0930 \u0938\u0915\u0924\u093e\u00a0\u0939\u0942\u0901?"
  },
  "type": "text",
  "id": "D2ZWG01Xhb3gdvlj5SZd3IUqO"
}
ğŸ“ Detected message type: text
âœ… Converting as regular message
ğŸ”— NO REPLY CONTEXT: 'context' not in message keys: ['from', 'timestamp', 'text', 'type', 'id']
=== NO MEDIA CONTEXT CREATED - message_audio is None ===
=== END QIKCHAT MESSAGE CONVERSION DEBUG ===

[DEBUG] Looking up users by phone_numbers: ['916352927215']
[DEBUG] get_users_by_phone_numbers called with phone_numbers: ['916352927215']
[DEBUG] Using collection: 'users'
C:\Users\t-asanghvi\AppData\Local\pypoetry\Cache\virtualenvs\byoeb-7XHC672s-py3.11\Lib\site-packages\motor\core.py:171: UserWarning: You appear to be connected to a CosmosDB cluster. For more information regarding feature compatibility and support please visit https://www.mongodb.com/supportability/cosmosdb       
  delegate = self.__delegate_class__(*args, **kwargs)
[DEBUG] Raw users_obj from DB (by phone numbers): [{'_id': '002', 'User': {'user_id': '002', 'user_name': 'Akshat Sanghvi', 'user_location': {}, 'user_language': 'hi', 'user_type': 'byoebuser', 'phone_number_id': '916352927215', 'test_user': False, 'experts': {'byoebexpert': ['919739811075'], 'byoebexpert2': ['919741363511']}, 'audience': [], 'patient_details': {'date_of_birth': '1985-03-15', 'gender': 'Male', 'age': 21}, 'created_timestamp': 1761388632, 'activity_timestamp': 1762925239, 'last_conversations': [{'question': 'What are the side effects of radiotherapy?', 'answer': 'Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ask more questions.'}, {'question': 'Can I take a bath after radiotherapy?', 'answer': 'Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ask more questions.'}, {'question': 'Can I take a bath after radiotherapy?', 'answer': 'Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ask more questions.'}]}, 'timestamp': '1761388632'}]
[DEBUG] Retrieved user by phone - user_id: '002', phone_number_id: '916352927215', user_name: 'Akshat Sanghvi', conversations: 3
ğŸ” GET_BOT_MESSAGES: Database returned 0 results
âŒ GET_BOT_MESSAGES: No messages found in database
ğŸ” Let's check what IDs actually exist in the database...
ğŸ” Recent messages in database (last hour): 76
   Recent 1: ID=mGAu8W39qlpkvWKRfdFG94bfX, Text='Question: Can I take a bath after radiotherapy?
An...'
   Recent 2: ID=lPQMquhQuEaFPl9JX6JvGTEdM, Text='...'
âŒ Failed to get recent messages for debug: 'NoneType' object is not subscriptable
[DEBUG] Looking for user with phone_number_id: '916352927215' in 1 retrieved users
[DEBUG] Found existing user with user_id: '002', user_name: 'Akshat Sanghvi', phone_number_id: '916352927215', conversations: 3
ğŸ” PROCESSING MESSAGE: Category=byoebuser_to_bot, UserType=byoebuser
ğŸ” Message Text: à¤•à¥à¤¯à¤¾ à¤®à¥ˆà¤‚ à¤°à¥‡à¤¡à¤¿à¤¯à¥‹à¤¥à¥‡à¤°à¥‡à¤ªà¥€ à¤•à¥‡ à¤¬à¤¾à¤¦ à¤¸à¥à¤¨à¤¾à¤¨ à¤•à¤° à¤¸à¤•à¤¤à¤¾ à¤¹à¥‚à¤?
ğŸ” Added USER conversation to processing queue
ğŸ”¤ USER PROCESS: Translating 'à¤•à¥à¤¯à¤¾ à¤®à¥ˆà¤‚ à¤°à¥‡à¤¡à¤¿à¤¯à¥‹à¤¥à¥‡à¤°à¥‡à¤ªà¥€ à¤•à¥‡ à¤¬à¤¾à¤¦ à¤¸à¥à¤¨à¤¾à¤¨ à¤•à¤° à¤¸à¤•à¤¤à¤¾ à¤¹à¥‚à¤?' from hi to en
Thread ID: 9596, Variable Address: 1903547757952, client address: 1903199034640
ğŸ”¤ USER PROCESS: Translation result: 'Can I take a bath after radiotherapy?'

=== RESPONSE GENERATION DEBUG ===
ğŸ“ Original message: 'à¤•à¥à¤¯à¤¾ à¤®à¥ˆà¤‚ à¤°à¥‡à¤¡à¤¿à¤¯à¥‹à¤¥à¥‡à¤°à¥‡à¤ªà¥€ à¤•à¥‡ à¤¬à¤¾à¤¦ à¤¸à¥à¤¨à¤¾à¤¨ à¤•à¤° à¤¸à¤•à¤¤à¤¾ à¤¹à¥‚à¤?'
ğŸ“¤ English message for KB: 'Can I take a bath after radiotherapy?'
ğŸ‘¤ User: 916352927215 (language: hi)

ğŸ” MULTI-KB SEARCH DEBUG:
ğŸ” Query: 'Can I take a bath after radiotherapy?'
ğŸ” Searching 4 knowledge bases...
ğŸ” Searching KB1 (Q&A pairs) with filter: source eq 'oncobot_knowledge_base'
ğŸ” KB1 returned 3 Q&A results
ğŸ” Searching KB2 (Markdown) with filter: source eq 'kb2_content'
ğŸ” KB2 returned 2 Markdown results
ğŸ” Searching KB3 (Markdown) with filter: source eq 'kb3_content'
ğŸ” KB3 returned 2 Markdown results
ğŸ” Searching KB1_Expert (Expert Corrections) with filter: source eq 'oncobot_expert_knowledge_base'
ğŸ” KB1_Expert: No expert corrections available yet (will be populated as experts provide corrections)
ğŸ” Total chunks retrieved: 7 (KB1: 3, KB2: 2, KB3: 2, KB1_Expert: 0)

=== KB CONTEXT RETRIEVED (7 chunks) ===
Query: Can I take a bath after radiotherapy?
Chunk 1:
  Question: Can I use soap on the rest of my body while undergoing radiation therapy?
  Source: oncobot_knowledge_base
  Content: Question: Can I use soap on the rest of my body while undergoing radiation therapy?
Answer: Yes, you can use mild soap on the rest of your body while undergoing radiation therapy. However, be gentle a...
  ---
=== END KB CONTEXT ===


=== FULL LLM INPUT DEBUG ===
Message 1 (system):
  Content: You are an expert oncology assistant helping cancer patients. Your purpose is to answer patients with any oncology-related queries they might have.

You have access to four knowledge bases:
- KB1: Q&A pairs covering general oncology topics
- KB2 & KB3: Detailed radiation therapy treatment guides and procedures
- KB1_Expert: Expert-validated corrections and high-priority answers (marked with [EXPERT-VALIDATED])    

Guidelines for answering:
- USE [EXPERT-VALIDATED] content ONLY when it is directly r...
Message 2 (user):
  Content: The following knowledge base context has been retrieved from multiple sources to help answer your question. Content marked with [EXPERT-VALIDATED] has been specifically reviewed by medical professionals - use this content ONLY if it directly relates to the user's question:

KNOWLEDGE BASE CONTEXT:
Question: Can I use soap on the rest of my body while undergoing radiation therapy?
Answer: Yes, you can use mild soap on the rest of your body while undergoing radiation therapy. However, be gentle an...
ğŸ” Question being processed: 'Can I take a bath after radiotherapy?'
ğŸ” Number of chunks: 7
=== END FULL LLM INPUT DEBUG ===


=== LLM RESPONSE DEBUG ===
ğŸ”¤ Raw LLM response_text: '<BEGIN RESPONSE>
Yes, you can take a bath after radiotherapy, but be gentle with the skin in the treatment area. Use lukewarm or cold water and avoid using soap, oil, or creams on the treated area. Pat your skin dry with a soft towel instead of rubbing it. Always follow any specific recommendations from your healthcare provider regarding skin care.
<END RESPONSE>

<BEGIN QUERY TYPE>
medical
<END QUERY TYPE>'
ğŸ”¤ Response length: 410
ğŸ”¤ Contains 'Sorry': False
ğŸ”¤ Contains 'assist': False
=== END LLM RESPONSE DEBUG ===

Generated answer:  Yes, you can take a bath after radiotherapy, but be gentle with the skin in the treatment area. Use lukewarm or cold water and avoid using soap, oil, or creams on the treated area. Pat your skin dry with a soft towel instead of rubbing it. Always follow any specific recommendations from your healthcare provider regarding skin care.
Query the type:  medical
Query the type:  medical
ğŸ“Š CLASSIFICATION_FIX: Set original message category to 'byoebuser_to_bot' for proper filtering
finding here ['Can I use deodorant during radiation therapy?', 'What should I do if my skin becomes itchy?', 'Is it safe to swim in a pool during treatment?']
Thread ID: 9596, Variable Address: 1903537012608, client address: 1903199034640
Thread ID: 9596, Variable Address: 1903537012608, client address: 1903199034640
Thread ID: 9596, Variable Address: 1903537012608, client address: 1903199034640
âœ… Translated 3 related questions to hi
ğŸ‘¨â€âš•ï¸ Using doctor waiting message for medical query
ğŸ”¤ WAITING MESSAGE: Localized (hi): 'à¤®à¥ˆà¤‚ à¤•à¥‡-à¤à¤®-à¤¸à¥€ à¤•à¥‡ à¤¡à¥‰à¤•à¥à¤Ÿà¤° à¤¸à¥‡ à¤ªà¥‚à¤› à¤•à¤° à¤†à¤ªà¤•à¥‹ à¤à¤• à¤¸à¤Ÿà¥€à¤• à¤‰à¤¤à¥à¤¤à¤° à¤¦à¥‚à¤à¤—à¤¾à¥¤ à¤¤à¤¬ à¤¤à¤•, à¤¬à¥‡          à¥‡à¤à¤¿à¤à¤• à¤”à¤° à¤ªà¥à¤°à¤¶à¥à¤¨ à¤ªà¥‚à¤›à¥‡à¤‚à¥¤'
ğŸ”¤ WAITING MESSAGE: English: 'Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ask more questions.'
ğŸ”— DEBUG: Storing original user question ID for reply context: D2ZWG01Xhb3gdvlj5SZd3IUqO
ğŸ”¤ TRANSLATION DEBUG: About to translate message to hi
ğŸ”¤ TRANSLATION DEBUG: Input text: 'à¤®à¥ˆà¤‚ à¤•à¥‡-à¤à¤®-à¤¸à¥€ à¤•à¥‡ à¤¡à¥‰à¤•à¥à¤Ÿà¤° à¤¸à¥‡ à¤ªà¥‚à¤› à¤•à¤° à¤†à¤ªà¤•à¥‹ à¤à¤• à¤¸à¤Ÿà¥€à¤• à¤‰à¤¤à¥à¤¤à¤° à¤¦à¥‚à¤à¤—à¤¾à¥¤ à¤¤à¤¬ à¤¤à¤•, à¤¬à¥‡à¤à¤¿          à¤¿à¤à¤• à¤”à¤° à¤ªà¥à¤°à¤¶à¥à¤¨ à¤ªà¥‚à¤›à¥‡à¤‚à¥¤'
Thread ID: 9596, Variable Address: 1903537012608, client address: 1903199034640
ğŸ”¤ TRANSLATION DEBUG: Final result: 'à¤®à¥ˆà¤‚ à¤•à¥‡-à¤à¤®-à¤¸à¥€ à¤•à¥‡ à¤¡à¥‰à¤•à¥à¤Ÿà¤° à¤¸à¥‡ à¤ªà¥‚à¤› à¤•à¤° à¤†à¤ªà¤•à¥‹ à¤à¤• à¤¸à¤Ÿà¥€à¤• à¤‰à¤¤à¥à¤¤à¤° à¤¦à¥‚à¤à¤—à¤¾à¥¤ à¤¤à¤¬ à¤¤à¤•, à¤¬à¥‡          à¥‡à¤à¤¿à¤à¤• à¤”à¤° à¤ªà¥à¤°à¤¶à¥à¤¨ à¤ªà¥‚à¤›à¥‡à¤‚à¥¤'
ğŸ”¤ TRANSLATION DEBUG: Translation used: True
ğŸ”¤ ENGLISH TEXT: Using provided English text: 'Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ask more questions.'
ï¿½ Creating user response message...
ğŸ”— Adding 3 follow-up questions to interactive list
ğŸ”— DEBUG: Creating reply context - user message ID: D2ZWG01Xhb3gdvlj5SZd3IUqO
ğŸ”— DEBUG: Created main waiting message reply context with reply_id: D2ZWG01Xhb3gdvlj5SZd3IUqO
ğŸ”— DEBUG: Main waiting message ID: 3e12905a-2701-4542-ba73-a21e8bc2dc7d
ğŸµ Generating TTS audio again for message...
running tts now
running tts now again
ğŸ”§ SPEECH DEBUG - SUCCESS: Generated 109152 bytes of audio
ğŸ”§ TTS DEBUG - Received audio_bytes: <class 'bytes'>, length: 109152
running tts now again 2
ğŸµ TTS audio message generated successfully with SAS URL
ğŸ”— DEBUG: Audio message reply context reply_id: D2ZWG01Xhb3gdvlj5SZd3IUqO
ğŸ”— DEBUG: Audio message ID: 29a85dae-a86f-45f4-9b39-b349a677d1b2
ğŸ’¬ Returning 2 messages: ['interactive_list_reply', 'regular_audio']
âœ… Waiting messages sent to user (in hi)
ğŸ‘¨â€âš•ï¸ Creating expert verification message...
expert result {'byoebexpert': ['919739811075'], 'byoebexpert2': ['919741363511']}
expert result 2 ('919739811075', 'byoebexpert') medical
ğŸ‘¨â€âš•ï¸ Using configured expert: 919739811075 (byoebexpert)
ğŸ†” Generated expert user_id: d7022499fc5fbcd34df184209477a79f from phone: 919739811075
ğŸ‘¤ Added patient context for expert: 2 lines
ğŸ”§ Expert additional_info template_language: en (type: <class 'str'>)
ğŸ“‹ Template parameters created:
  {1} Patient Info: Akshat Sanghvi, Age: 21, Gender: Male, DOB: 1985-03-15
  {2} Question: Can I take a bath after radiotherapy?
  {3} Answer: Yes, you can take a bath after radiotherapy, but be gentle with the skin in the treatment area. Use lukewarm or cold water and avoid using soap, oil, or creams on the treated area. Pat your skin dry with a soft towel instead of rubbing it. Always follow any specific recommendations from your healthcare provider regarding skin care.
ğŸ‘¨â€âš•ï¸ Expert message created with patient info in template format
âœ… Expert verification message created
ğŸ‰ Complete! Generated 5 messages (original user message + waiting messages + expert verification + read receipt)
ğŸ“¥ INCOMING: regular_text, ID=D2ZWG01Xhb3gdvlj5SZd3IUqO
ğŸ“¤ OUTGOING: interactive_list_reply, ID=3e12905a-2701-4542-ba73-a21e8bc2dc7d
ğŸ“¤ OUTGOING: regular_audio, ID=29a85dae-a86f-45f4-9b39-b349a677d1b2
ğŸ” MESSAGE BREAKDOWN: Total=5, Incoming=1, Outgoing=2, Expert=1, ReadReceipt=1
ğŸ” User message 1: Type=interactive_list_reply, ID=3e12905a-2701-4542-ba73-a21e8bc2dc7d
ğŸ” User message 2: Type=regular_audio, ID=29a85dae-a86f-45f4-9b39-b349a677d1b2
ğŸ”§ DEBUG: Using channel_type='qikchat' -> service=QikchatService
ğŸ’¬ Sending response: Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ...
ğŸ·ï¸ Query type: medical
ğŸ‘¨â€âš•ï¸ Found expert verification message for 919739811075
ğŸ“¤ Processing user message 1/2: interactive_list_reply
ğŸ” HANDLE_USER: Processing interactive_list_reply
Checking interactive list - has description: True, has row_texts: True, row_texts not None: True, result: True
ğŸ” HANDLE_USER: Prepared 1 requests

=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 1 requests
ğŸ“¤ Request 1: {'to_contact': '916352927215', 'type': 'interactive', 'interactive': {'type': 'list', 'body': {'text': 'à¤®à¥ˆà¤‚ à¤•à¥‡-à¤à¤®-à¤¸à¥€ à¤•à¥‡ à¤¡à¥‰à¤•à¥à¤Ÿà¤° à¤¸à¥‡ à¤ªà¥‚à¤› à¤•à¤° à¤†à¤ªà¤•à¥‹ à¤à¤• à¤¸à¤Ÿà¥€à¤• à¤‰à¤¤à¥à¤¤à¤° à¤¦à¥‚à¤à¤—à¤¾à¥¤ à¤¤à¤¬ à¤¤à¤•, à¤¬à¥‡à¤à¤¿à¤à¤• à¤”à¤° à¤ªà¥à¤°à¤¶à¥à¤¨ à¤ªà¥‚à¤›à¥‡à¤‚à¥¤'},               , 'action': {'button': 'à¤¸à¤‚à¤¬à¤‚à¤§à¤¿à¤¤ à¤ªà¥à¤°à¤¶à¥à¤¨', 'sections': [{'title': '', 'rows': [{'id': 'option_0', 'title': '   'Q1', 'description': 'à¤•à¥à¤¯à¤¾ à¤®à¥ˆà¤‚ à¤°à¥‡à¤¡à¤¿à¤à¤¶à¤¨ à¤¥à¥‡à¤°à¥‡à¤ªà¥€ à¤•à¥‡ à¤¦à¥Œà¤°à¤¾à¤¨ à¤¡à¤¿à¤¯à¥‹à¤¡à¤°à¥‡à¤‚à¤Ÿ à¤•à¤¾ à¤‰à¤ªà¤¯à¥‹à¤— à¤•à¤° à¤¸à¤•à¤¤à¤¾ à¤¹à¥‚à¤?'}, {'id': 'option_1          1', 'title': 'Q2', 'description': 'à¤…à¤—à¤° à¤†à¤ªà¤•à¥€ à¤¤à¥à¤µà¤šà¤¾ à¤®à¥‡à¤‚ à¤–à¥à¤œà¤²à¥€ à¤¹à¥‹ à¤°à¤¹à¥€ à¤¹à¥ˆ à¤¤à¥‹ à¤†à¤ª à¤¨à¤¿à¤®à¥à¤¨à¤²à¤¿à¤–à¤¿à¤¤ à¤‰à¤ªà¤¾à¤¯ à¤•à¤° à¤¸à¤•à¤¤à¥‡ à¤¹à¥ˆà¤‚:..        ..'}, {'id': 'option_2', 'title': 'Q3', 'description': 'à¤•à¥à¤¯à¤¾ à¤‡à¤²à¤¾à¤œ à¤•à¥‡ à¤¦à¥Œà¤°à¤¾à¤¨ à¤ªà¥‚à¤² à¤®à¥‡à¤‚ à¤¤à¥ˆà¤°à¤¨à¤¾ à¤¸à¥à¤°à¤•à¥à¤·à¤¿à¤¤ à¤¹à¥ˆ?'}]}]        ]}}, 'context': {'message_id': 'D2ZWG01Xhb3gdvlj5SZd3IUqO'}}
ğŸ“¤ Got 1 results
ğŸ“¤ Result 1: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'WN3euHgFQNd2u1jx4Nhopcj4e', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '916352927215', 'credits': 0, 'created_at': '2025-11-12T05:44:57.758Z', 'status': 'processing'}]}
ğŸ“¤ Extracted message_id for result 1: WN3euHgFQNd2u1jx4Nhopcj4e
ğŸ“¤ Final message_ids: ['WN3euHgFQNd2u1jx4Nhopcj4e']
=== END QIKCHAT SEND_REQUESTS DEBUG ===


=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 0 requests
ğŸ“¤ Got 0 results
ğŸ“¤ Final message_ids: []
=== END QIKCHAT SEND_REQUESTS DEBUG ===

ğŸ“¤ Processing user message 2/2: regular_audio
ğŸ” HANDLE_USER: Processing regular_audio
Checking interactive list - has description: False, has row_texts: False, row_texts not None: False, result: False
ğŸµ Preparing audio message request (async)...
ğŸµ Using audio URL: https://smartkcstorage1.blob.core.windows.net/onco...
ğŸµ Audio message request prepared
ğŸ” HANDLE_USER: Prepared 1 requests
ğŸµ Sending audio message...
ğŸµ Audio message only (no follow-up questions)
ğŸµ Found 1 audio requests to send

=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 1 requests
ğŸ“¤ Request 1: {'to_contact': '916352927215', 'type': 'audio', 'audio': {'link': 'https://smartkcstorage1.blob.core.windows.net/oncobot-container/tts_audio_383fd488399844358b7e763e3cb782f1.mp3?st=2025-11-12T05%3A44%3A55Z&se=2025-11-12T06%3A44%3A55Z&sp=r&sv=2025-01-05&sr=b&skoid=f5b64d94-ba27-422a-abb5-cad2b511c671&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2025-11-12T05%3A44%3A55Z&ske=2025-11-12T06%3A44%3A55Z&sks=b&skv=2025-01-05&sig=%2BWv7CBNYHb8n0fje2UKsefbGEwBDvPnPOB24kUMhIPE%3D'}, 'context': {'message_id': 'D2ZWG01Xhb3gdvlj5SZd3IUqO'}}
ğŸ“¤ Got 1 results
ğŸ“¤ Result 1: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'Ai02gpwdF1N46LWw4UjSGVWHp', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '916352927215', 'credits': 0, 'created_at': '2025-11-12T05:44:57.934Z', 'status': 'processing'}]}
ğŸ“¤ Extracted message_id for result 1: Ai02gpwdF1N46LWw4UjSGVWHp
ğŸ“¤ Final message_ids: ['Ai02gpwdF1N46LWw4UjSGVWHp']
=== END QIKCHAT SEND_REQUESTS DEBUG ===


=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 0 requests
ğŸ“¤ Got 0 results
ğŸ“¤ Final message_ids: []
=== END QIKCHAT SEND_REQUESTS DEBUG ===

ğŸ”§ Handling expert message for: 919739811075
ğŸ”§ Expert user_id: d7022499fc5fbcd34df184209477a79f
Last active duration 886.584982
Cached False
ğŸ”§ Expert is_active_user: True
ğŸ”˜ Sending interactive button to active expert

=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 1 requests
ğŸ“¤ Request 1: {'to_contact': '919739811075', 'type': 'interactive', 'interactive': {'type': 'button', 'body': {'text': '*Patient Info*: Akshat Sanghvi, Age: 21, Gender: Male, DOB: 1985-03-15\n\n*Question:* Can I take a bath after radiotherapy?\n*Answer:* Yes, you can take a bath after radiotherapy, but be gentle with the skin in the treatment area. Use lukewarm or cold water and avoid using soap, oil, or creams on the treated area. Pat your skin dry with a soft towel instead of rubbing it. Always follow any specific recommendations from your healthcare provider regarding skin care.\n\nIs the answer correct?'}, 'action': {'buttons': [{'type': 'reply', 'reply': {'id': '5107f97b-daa9-48ba-a8e3-8e496107c369', 'title': 'Yes'}}, {'type': 'reply', 'reply': {'id': '5fd6777b-8e5e-42d3-aa23-fe0c328892a5', 'title': 'No'}}]}}}
ğŸ“¤ Got 1 results
ğŸ“¤ Result 1: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'Tqkv8kmlpk03K6zz9M5uDUPmo', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '919739811075', 'credits': 0, 'created_at': '2025-11-12T05:44:58.430Z', 'status': 'processing'}]}
ğŸ“¤ Extracted message_id for result 1: Tqkv8kmlpk03K6zz9M5uDUPmo
ğŸ“¤ Final message_ids: ['Tqkv8kmlpk03K6zz9M5uDUPmo']
=== END QIKCHAT SEND_REQUESTS DEBUG ===

responses [{'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'Tqkv8kmlpk03K6zz9M5uDUPmo', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '919739811075', 'credits': 0, 'created_at': '2025-11-12T05:44:58.430Z', 'status': 'processing'}]}]
ğŸ“Œ Skipping emoji reaction (emoji is None)

=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 0 requests
ğŸ“¤ Got 0 results
ğŸ“¤ Final message_ids: []
=== END QIKCHAT SEND_REQUESTS DEBUG ===

âœ… Sent 2 user messages and expert verifier message!
âœ… Response sent successfully!
ğŸ” CREATE_CONV DEBUG:
   byoeb_user_message.message_context.message_id: 3e12905a-2701-4542-ba73-a21e8bc2dc7d
   byoeb_user_message.reply_context.reply_id: D2ZWG01Xhb3gdvlj5SZd3IUqO
ğŸ”— REPLY_CONTEXT_FIX: Using reply_context.reply_id as original user question ID: D2ZWG01Xhb3gdvlj5SZd3IUqO
ğŸµ AUDIO_URL_FIX: Using original message 1 additional_info
ğŸ”— REPLY_CONTEXT_FIX: Bot message 1 reply_id set to: D2ZWG01Xhb3gdvlj5SZd3IUqO (QikChat ID: WN3euHgFQNd2u1jx4Nhopcj4e)
ğŸµ AUDIO_URL_FIX: Using original message 2 additional_info
ğŸµ AUDIO_URL_FIX: Found audio_url in original message: https://smartkcstorage1.blob.core.windows.net/onco...
ğŸ”— REPLY_CONTEXT_FIX: Bot message 2 reply_id set to: D2ZWG01Xhb3gdvlj5SZd3IUqO (QikChat ID: Ai02gpwdF1N46LWw4UjSGVWHp)
ğŸ”§ EXPERT MESSAGE ID DEBUG:
   Original expert ID: 02d4da59-ee89-4c56-bf91-1ded14c11380
   Expert responses count: 1
   First expert response: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'Tqkv8kmlpk03K6zz9M5uDUPmo', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '919739811075', 'credits': 0, 'created_at': '2025-11-12T05:44:58.430Z', 'status': 'processing'}]}
ğŸ§¹ FILTER_DUPLICATES: Before filtering - 2 entries in messages_context
ğŸ§¹ FILTER_DUPLICATES: Keeping entry: 694d16d8-bd72-4f3c-8d34-f04b0e88fca7 (UUID: True, Corrected: False) 
ğŸ§¹ FILTER_DUPLICATES: Keeping entry: bdd39cf6-7d37-44d7-b1a0-1cc5e011dc19 (UUID: True, Corrected: False) 
ğŸ§¹ FILTER_DUPLICATES: After filtering - 2 entries remaining
ğŸ”§ CREATE_CROSS_CONV: Processing 1 expert responses
ğŸ”§ CREATE_CROSS_CONV: Expert response 1: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'Tqkv8kmlpk03K6zz9M5uDUPmo', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '919739811075', 'credits': 0, 'created_at': '2025-11-12T05:44:58.430Z', 'status': 'processing'}]}
ğŸ”§ CREATE_CROSS_CONV: Top-level message ID: None
ğŸ”§ CREATE_CROSS_CONV: Checking data array with 1 items
ğŸ”§ CREATE_CROSS_CONV: Found message ID in data[0]: Tqkv8kmlpk03K6zz9M5uDUPmo
ğŸ”§ CREATE_CROSS_CONV: Final extracted expert message ID: Tqkv8kmlpk03K6zz9M5uDUPmo
ğŸ”§ CREATE_CROSS_CONV: Original expert message ID: 02d4da59-ee89-4c56-bf91-1ded14c11380
ğŸ”§ CREATE_CROSS_CONV: Updated expert message ID: 02d4da59-ee89-4c56-bf91-1ded14c11380 -> Tqkv8kmlpk03K6zz9M5uDUPmo
ğŸ”§ CREATE_CROSS_CONV: Expert message will be stored with Qikchat ID: Tqkv8kmlpk03K6zz9M5uDUPmo
ğŸ”§ CREATE_CROSS_CONV: Returning 3 messages for database storage
   Message 1: ID=694d16d8-bd72-4f3c-8d34-f04b0e88fca7, Type=interactive_list_reply, Text='...'
   Message 2: ID=bdd39cf6-7d37-44d7-b1a0-1cc5e011dc19, Type=interactive_list_reply, Text='...'
   Message 3: ID=Tqkv8kmlpk03K6zz9M5uDUPmo, Type=interactive_button_reply, Text='*Patient Info*: Akshat Sanghvi, Age: 21, Gender: M...'
   Expert ID after create_cross_conv: Tqkv8kmlpk03K6zz9M5uDUPmo
   ID changed: True
   â„¹ï¸ Expert message will be stored in database with correct QikChat ID: Tqkv8kmlpk03K6zz9M5uDUPmo       
ğŸ” CLASSIFICATION_FIX: Found original user message with ID D2ZWG01Xhb3gdvlj5SZd3IUqO
ğŸ” CLASSIFICATION_FIX: Using original user message with preserved classification
ğŸ“ Using original message ID from reply context: D2ZWG01Xhb3gdvlj5SZd3IUqO
ğŸ”§ Created USER_TO_BOT message:
   ID: D2ZWG01Xhb3gdvlj5SZd3IUqO
   Text: 'Can I take a bath after radiotherapy?...'

=== USER HANDLER MESSAGE STORAGE DEBUG ===
ğŸ“Š Total conversations to store: 6
  1. ID: D2ZWG01Xhb3gdvlj5SZd3IUqO
     Category: byoebuser_to_bot
     Type: regular_text
     Text: 'Can I take a bath after radiotherapy?...'
  2. ID: WN3euHgFQNd2u1jx4Nhopcj4e
     Category: bot_to_byoebuser_response
     Type: interactive_list_reply
     Text: 'Let me check with a KMC doctor and get back to you...'
  3. ID: Ai02gpwdF1N46LWw4UjSGVWHp
     Category: bot_to_byoebuser_response
     Type: regular_audio
     Text: '...'
  4. ID: 694d16d8-bd72-4f3c-8d34-f04b0e88fca7
     Category: None
     Type: interactive_list_reply
     Text: '...'
  5. ID: bdd39cf6-7d37-44d7-b1a0-1cc5e011dc19
     Category: None
     Type: interactive_list_reply
     Text: '...'
  6. ID: Tqkv8kmlpk03K6zz9M5uDUPmo
     Category: bot_to_byoebexpert_verification
     Type: interactive_button_reply
     Text: '*Patient Info*: Akshat Sanghvi, Age: 21, Gender: M...'
=== END USER HANDLER DEBUG ===

ğŸ” MESSAGE_CREATE_QUERIES: Processing 6 messages for database storage
ğŸ” MESSAGE_CREATE_QUERIES: Message 1
   Message ID: D2ZWG01Xhb3gdvlj5SZd3IUqO
   Message Type: regular_text
   Message Class: medical
   Is Expert Verification: False
   QikChat Audio ID: None
   Text Preview: Can I take a bath after radiotherapy?...
ğŸ” MESSAGE_CREATE_QUERIES: Message 2
   Message ID: WN3euHgFQNd2u1jx4Nhopcj4e
   Message Type: interactive_list_reply
   Message Class: Not classified
   Is Expert Verification: False
   QikChat Audio ID: None
   Text Preview: Let me check with a KMC doctor and get back to you with a verified answer. Until...     
ğŸ” MESSAGE_CREATE_QUERIES: Message 3
   Message ID: Ai02gpwdF1N46LWw4UjSGVWHp
   Message Type: regular_audio
   Message Class: Not classified
   Is Expert Verification:
   QikChat Audio ID: None
   Text Preview: ...
ğŸ” MESSAGE_CREATE_QUERIES: Message 4
   Message ID: 694d16d8-bd72-4f3c-8d34-f04b0e88fca7
   Message Type: interactive_list_reply
   Message Class: Not classified
   Is Expert Verification: None
   QikChat Audio ID: None
   Text Preview: ...
ğŸ” MESSAGE_CREATE_QUERIES: Message 5
   Message ID: bdd39cf6-7d37-44d7-b1a0-1cc5e011dc19
   Message Type: interactive_list_reply
   Message Class: Not classified
   Is Expert Verification: None
   QikChat Audio ID: None
   Text Preview: ...
ğŸ” MESSAGE_CREATE_QUERIES: Message 6
   Message ID: Tqkv8kmlpk03K6zz9M5uDUPmo
   Message Type: interactive_button_reply
   Message Class: Not classified
   Is Expert Verification: True
   QikChat Audio ID: None
   Text Preview: *Patient Info*: Akshat Sanghvi, Age: 21, Gender: Male, DOB: 1985-03-15

*Questio...
ğŸ” MESSAGE_CREATE_QUERIES: Generated 6 database create queries
ğŸ” FINAL_QUERIES_DEBUG: About to return 6 queries:
   Query 1: ID=D2ZWG01Xhb3gdvlj5SZd3IUqO, has_text=True, has_audio=False
   Query 2: ID=WN3euHgFQNd2u1jx4Nhopcj4e, has_text=True, has_audio=False
   Query 3: ID=Ai02gpwdF1N46LWw4UjSGVWHp, has_text=False, has_audio=True
   Query 4: ID=694d16d8-bd72-4f3c-8d34-f04b0e88fca7, has_text=False, has_audio=False
   Query 5: ID=bdd39cf6-7d37-44d7-b1a0-1cc5e011dc19, has_text=False, has_audio=False
   Query 6: ID=Tqkv8kmlpk03K6zz9M5uDUPmo, has_text=True, has_audio=False
Saving conversation history: Q: Can I take a bath after radiotherapy? | A: Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ...
ğŸ” PROCESSING RESULTS: Got 1 results from handlers
âœ… Result 0: MSG_CREATE=6, MSG_UPDATE=0, USER_CREATE=0, USER_UPDATE=1
Executing database queries - User updates: 1, Message creates: 6
ğŸ” EXECUTE_QUERIES: Starting execution with queries: ['create', 'update']
ğŸ” EXECUTE_QUERIES: Executing 6 CREATE operations
   CREATE 1: Message ID = D2ZWG01Xhb3gdvlj5SZd3IUqO
   CREATE 2: Message ID = WN3euHgFQNd2u1jx4Nhopcj4e
   CREATE 3: Message ID = Ai02gpwdF1N46LWw4UjSGVWHp
   CREATE 4: Message ID = 694d16d8-bd72-4f3c-8d34-f04b0e88fca7
   CREATE 5: Message ID = bdd39cf6-7d37-44d7-b1a0-1cc5e011dc19
   CREATE 6: Message ID = Tqkv8kmlpk03K6zz9M5uDUPmo
âœ… EXECUTE_QUERIES: CREATE operations completed successfully
   Result: (['D2ZWG01Xhb3gdvlj5SZd3IUqO', 'WN3euHgFQNd2u1jx4Nhopcj4e', 'Ai02gpwdF1N46LWw4UjSGVWHp', '694d16d8-bd72-4f3c-8d34-f04b0e88fca7', 'bdd39cf6-7d37-44d7-b1a0-1cc5e011dc19', 'Tqkv8kmlpk03K6zz9M5uDUPmo'], None)
Database operations completed in 0.64 seconds
hi there
DEBUG PRODUCER: Message ID in message: None
DEBUG PRODUCER: Payload ID: CvJH7zUfOU3w4ZRS226y8bs9s
DEBUG PRODUCER: Using payload ID as fallback: CvJH7zUfOU3w4ZRS226y8bs9s

=== QIKCHAT MESSAGE CONVERSION DEBUG ===
ğŸ“¥ Converting message: {
  "from": "919739811075",
  "timestamp": "2025-11-12T05:45:06.000Z",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "5fd6777b-8e5e-42d3-aa23-fe0c328892a5",
      "title": "No"
    }
  },
  "type": "interactive",
  "context": {
    "messageId": "Tqkv8kmlpk03K6zz9M5uDUPmo"
  },
  "id": "CvJH7zUfOU3w4ZRS226y8bs9s"
}
ğŸ“ Detected message type: interactive
ğŸ”˜ Converting as interactive message
ğŸ” Interactive context data found: {'messageId': 'Tqkv8kmlpk03K6zz9M5uDUPmo'}
ğŸ”— INTERACTIVE REPLY CONTEXT FOUND: reply_to_message_id = Tqkv8kmlpk03K6zz9M5uDUPmo
âœ… Interactive conversion successful
   - Reply ID: Tqkv8kmlpk03K6zz9M5uDUPmo
=== END QIKCHAT MESSAGE CONVERSION DEBUG ===

INFO:     35.207.205.165:0 - "POST /webhook/whk HTTP/1.1" 200 OK
[DEBUG] Looking up users by phone_numbers: ['919739811075']
[DEBUG] get_users_by_phone_numbers called with phone_numbers: ['919739811075']
[DEBUG] Using collection: 'users'
[DEBUG] Raw users_obj from DB (by phone numbers): [{'_id': 'd7022499fc5fbcd34df184209477a79f', 'User': {'user_id': 'd7022499fc5fbcd34df184209477a79f', 'user_name': None, 'user_location': {}, 'user_language': 'en', 'user_type': 'byoebexpert', 'phone_number_id': '919739811075', 'test_user': False, 'experts': {}, 'audience': ['918375066113', '918123273694', '918861000105', '916352927215'], 'patient_details': {}, 'created_timestamp': 1759916945, 'activity_timestamp': 1762925411, 'last_conversations': []}, 'timestamp': '1759916945'}]
[DEBUG] Retrieved user by phone - user_id: 'd7022499fc5fbcd34df184209477a79f', phone_number_id: '919739811075', user_name: 'None', conversations: 0
ğŸ” GET_BOT_MESSAGES: Database returned 1 results
âœ… GET_BOT_MESSAGES: Found matching messages
   Found 1: ID=Tqkv8kmlpk03K6zz9M5uDUPmo
ğŸ¤– Bot message 0: ID=Tqkv8kmlpk03K6zz9M5uDUPmo
[DEBUG] Looking for user with phone_number_id: '919739811075' in 1 retrieved users
[DEBUG] Found existing user with user_id: 'd7022499fc5fbcd34df184209477a79f', user_name: 'None', phone_number_id: '919739811075', conversations: 0
ï¿½ Expert message debug - reply_id: Tqkv8kmlpk03K6zz9M5uDUPmo, bot_message found: True
ğŸ” Reply context exists: reply_id=Tqkv8kmlpk03K6zz9M5uDUPmo
ğŸ” PROCESSING MESSAGE: Category=('byoebexpert_to_bot',), UserType=byoebexpert
ğŸ” Message Text: No
ğŸ” Added EXPERT conversation to processing queue

=== EXPERT MESSAGE CONSUMER DEBUG ===
ğŸ‘¨â€âš•ï¸ Processing expert message from: 919739811075
ğŸ’¬ Message text: 'No'
ğŸ“ Message type: interactive_button_reply
ğŸ”— Reply ID: Tqkv8kmlpk03K6zz9M5uDUPmo
ğŸ”— Reply additional info: {'verification_status': 'pending'}
=== END EXPERT MESSAGE CONSUMER DEBUG ===

Translation skipped - same language

=== EXPERT GENERATE RESPONSE DEBUG ===
ğŸ“§ Processing expert message from: 919739811075
ğŸ’¬ Message text: 'No'
ğŸ“ Message type: interactive_button_reply
ğŸ”— Reply context exists: True
ğŸ”— Reply ID: Tqkv8kmlpk03K6zz9M5uDUPmo
ğŸ”— Reply message category: bot_to_byoebexpert_verification
ğŸ”— Reply additional_info keys: ['verification_status']
ğŸ”— Verification status: pending
âŒ Branch: Expert clicked NO - asking for correction, notifying user
ğŸ”§ DEBUG: About to create expert correction message
ğŸ”§ DEBUG: EXPERT_ASK_FOR_CORRECTION = Noted. Please provide the correct answer. Reply by tagging the original verification message
âœ… DEBUG: Expert message created successfully: <class 'list'>
ğŸ”§ Including original expert message for storage: ID=CvJH7zUfOU3w4ZRS226y8bs9s
ğŸ”§ Original expert message category: ('byoebexpert_to_bot',)
ğŸ“¤ Generated messages: 0 user, 1 expert
=== END EXPERT GENERATE RESPONSE DEBUG ===


=== EXPERT SEND RESPONSE DEBUG ===
ğŸ“¨ Processing 3 messages in send handler
ğŸ“¨ Message 1: user_type='byoebexpert', category='bot_to_byoebexpert'
ğŸ“¨ Message 2: user_type='None', category='read_receipt'
ğŸ“¨ Message 3: user_type='byoebexpert', category='('byoebexpert_to_bot',)'
ğŸ“¨ After filtering: 1 read receipts, 0 user messages, 2 expert messages

=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 1 requests
ğŸ“¤ Request 1: {'to_contact': '919739811075', 'type': 'text', 'text': {'body': 'Noted. Please provide the correct answer. Reply by tagging the original verification message'}, 'context': {'message_id': 'Tqkv8kmlpk03K6zz9M5uDUPmo'}}
ğŸ“¤ Got 1 results
ğŸ“¤ Result 1: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'OzhlI1hS042iZe9XeQycVEf7P', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '919739811075', 'credits': 0, 'created_at': '2025-11-12T05:45:12.210Z', 'status': 'processing'}]}
ğŸ“¤ Extracted message_id for result 1: OzhlI1hS042iZe9XeQycVEf7P
ğŸ“¤ Final message_ids: ['OzhlI1hS042iZe9XeQycVEf7P']
=== END QIKCHAT SEND_REQUESTS DEBUG ===

ğŸ”§ EXPERT_ID_FIX: Updating expert message ID: a9fd6d72-07ee-40ba-9818-b1154e67fcf1 -> OzhlI1hS042iZe9XeQycVEf7P
ğŸ”„ Updating expert message ID in database: a9fd6d72-07ee-40ba-9818-b1154e67fcf1 -> OzhlI1hS042iZe9XeQycVEf7P
ğŸ”„ UPDATE_MESSAGE_ID: Starting ID update process
   Old ID: a9fd6d72-07ee-40ba-9818-b1154e67fcf1
   New ID: OzhlI1hS042iZe9XeQycVEf7P
ğŸ”„ UPDATE_MESSAGE_ID: Looking for document with old ID: a9fd6d72-07ee-40ba-9818-b1154e67fcf1
âŒ UPDATE_MESSAGE_ID: Message with ID a9fd6d72-07ee-40ba-9818-b1154e67fcf1 not found for update
ğŸ” UPDATE_MESSAGE_ID: Checking if message exists in different format...
âŒ UPDATE_MESSAGE_ID: Message not found in nested structure either
ğŸ“¨ No user messages to send
ğŸ—„ï¸ __prepare_db_queries: Preparing queries for 0 user messages and 2 expert messages
ğŸ—„ï¸ Added 2 expert messages for storage

=== EXPERT HANDLER MESSAGE STORAGE DEBUG ===
ğŸ“Š Total messages to store: 2
  1. ID: OzhlI1hS042iZe9XeQycVEf7P
     Category: bot_to_byoebexpert
     Type: regular_text
     Has Audio: None
     Text: 'Noted. Please provide the correct answer. Reply by...'
  2. ID: CvJH7zUfOU3w4ZRS226y8bs9s
     Category: ('byoebexpert_to_bot',)
     Type: interactive_button_reply
     Has Audio: False
     Text: 'No...'
=== END EXPERT HANDLER DEBUG ===

ğŸ” MESSAGE_CREATE_QUERIES: Processing 2 messages for database storage
ğŸ” MESSAGE_CREATE_QUERIES: Message 1
   Message ID: OzhlI1hS042iZe9XeQycVEf7P
   Message Type: regular_text
   Message Class: Not classified
   Is Expert Verification: False
   QikChat Audio ID: None
   Text Preview: Noted. Please provide the correct answer. Reply by tagging the original verifica...     
C:\Users\t-asanghvi\AppData\Local\pypoetry\Cache\virtualenvs\byoeb-7XHC672s-py3.11\Lib\site-packages\pydantic\main.py:463: UserWarning: Pydantic serializer warnings:
  PydanticSerializationUnexpectedValue(Expected `str` - serialized value may not be as expected [input_value=('byoebexpert_to_bot',), input_type=tuple])
  return self.__pydantic_serializer__.to_python(
ğŸ” MESSAGE_CREATE_QUERIES: Message 2
   Message ID: CvJH7zUfOU3w4ZRS226y8bs9s
   Message Type: interactive_button_reply
   Message Class: Not classified
   Is Expert Verification: False
   QikChat Audio ID: None
   Text Preview: No...
ğŸ” MESSAGE_CREATE_QUERIES: Generated 2 database create queries
ğŸ” FINAL_QUERIES_DEBUG: About to return 2 queries:
   Query 1: ID=OzhlI1hS042iZe9XeQycVEf7P, has_text=True, has_audio=False
   Query 2: ID=CvJH7zUfOU3w4ZRS226y8bs9s, has_text=True, has_audio=False
ğŸ—„ï¸ Generated 2 CREATE queries
ğŸ—„ï¸ Database queries prepared successfully
=== END EXPERT SEND RESPONSE DEBUG ===

ğŸ” PROCESSING RESULTS: Got 1 results from handlers
âœ… Result 0: MSG_CREATE=2, MSG_UPDATE=0, USER_CREATE=0, USER_UPDATE=1
Executing database queries - User updates: 1, Message creates: 2
ğŸ” EXECUTE_QUERIES: Starting execution with queries: ['create', 'update']
ğŸ” EXECUTE_QUERIES: Executing 2 CREATE operations
   CREATE 1: Message ID = OzhlI1hS042iZe9XeQycVEf7P
   CREATE 2: Message ID = CvJH7zUfOU3w4ZRS226y8bs9s
âœ… EXECUTE_QUERIES: CREATE operations completed successfully
   Result: (['OzhlI1hS042iZe9XeQycVEf7P', 'CvJH7zUfOU3w4ZRS226y8bs9s'], None)
Database operations completed in 0.62 seconds
DEBUG PRODUCER: Payload ID: ZuzOBxR8Dt40xmfAM3BVabBGb
DEBUG PRODUCER: Using payload ID as fallback: ZuzOBxR8Dt40xmfAM3BVabBGb

=== QIKCHAT MESSAGE CONVERSION DEBUG ===
ğŸ“¥ Converting message: {
  "from": "919739811075",
  "timestamp": "2025-11-12T05:45:15.000Z",
  "text": {
    "body": "no you cannot"
  },
  "type": "text",
  "context": {
    "messageId": "Tqkv8kmlpk03K6zz9M5uDUPmo"
  },
  "id": "ZuzOBxR8Dt40xmfAM3BVabBGb"
}
ğŸ“ Detected message type: text
âœ… Converting as regular message
ğŸ” Context data found: {'messageId': 'Tqkv8kmlpk03K6zz9M5uDUPmo'}
ğŸ”— REPLY CONTEXT FOUND: reply_to_message_id = Tqkv8kmlpk03K6zz9M5uDUPmo
=== NO MEDIA CONTEXT CREATED - message_audio is None ===
   - Reply ID: Tqkv8kmlpk03K6zz9M5uDUPmo
=== END QIKCHAT MESSAGE CONVERSION DEBUG ===

INFO:     35.207.205.165:0 - "POST /webhook/whk HTTP/1.1" 200 OK
[DEBUG] Looking up users by phone_numbers: ['919739811075']
[DEBUG] get_users_by_phone_numbers called with phone_numbers: ['919739811075']
[DEBUG] Using collection: 'users'
[DEBUG] Raw users_obj from DB (by phone numbers): [{'_id': 'd7022499fc5fbcd34df184209477a79f', 'User': {'user_id': 'd7022499fc5fbcd34df184209477a79f', 'user_name': None, 'user_location': {}, 'user_language': 'en', 'user_type': 'byoebexpert', 'phone_number_id': '919739811075', 'test_user': False, 'experts': {}, 'audience': ['918375066113', '918123273694', '918861000105', '916352927215'], 'patient_details': {}, 'created_timestamp': 1759916945, 'activity_timestamp': 1762926312, 'last_conversations': []}, 'timestamp': '1759916945'}]
[DEBUG] Retrieved user by phone - user_id: 'd7022499fc5fbcd34df184209477a79f', phone_number_id: '919739811075', user_name: 'None', conversations: 0
ğŸ” GET_BOT_MESSAGES: Database returned 1 results
âœ… GET_BOT_MESSAGES: Found matching messages
   Found 1: ID=Tqkv8kmlpk03K6zz9M5uDUPmo
ğŸ¤– Bot message 0: ID=Tqkv8kmlpk03K6zz9M5uDUPmo
[DEBUG] Looking for user with phone_number_id: '919739811075' in 1 retrieved users
[DEBUG] Found existing user with user_id: 'd7022499fc5fbcd34df184209477a79f', user_name: 'None', phone_number_id: '919739811075', conversations: 0
ï¿½ Expert message debug - reply_id: Tqkv8kmlpk03K6zz9M5uDUPmo, bot_message found: True
ğŸ” Reply context exists: reply_id=Tqkv8kmlpk03K6zz9M5uDUPmo
ğŸ” PROCESSING MESSAGE: Category=('byoebexpert_to_bot',), UserType=byoebexpert
ğŸ” Message Text: no you cannot
ğŸ” Added EXPERT conversation to processing queue

=== EXPERT MESSAGE CONSUMER DEBUG ===
ğŸ‘¨â€âš•ï¸ Processing expert message from: 919739811075
ğŸ’¬ Message text: 'no you cannot'
ğŸ“ Message type: regular_text
ğŸ”— Reply ID: Tqkv8kmlpk03K6zz9M5uDUPmo
ğŸ”— Reply additional info: {'verification_status': 'pending'}
=== END EXPERT MESSAGE CONSUMER DEBUG ===

Translation skipped - same language

=== EXPERT GENERATE RESPONSE DEBUG ===
ğŸ“§ Processing expert message from: 919739811075
ğŸ’¬ Message text: 'no you cannot'
ğŸ“ Message type: regular_text
ğŸ”— Reply context exists: True
ğŸ”— Reply ID: Tqkv8kmlpk03K6zz9M5uDUPmo
ğŸ”— Reply message category: bot_to_byoebexpert_verification
ğŸ”— Reply additional_info keys: ['verification_status']
ğŸ”— Verification status: pending
ğŸ”„ Branch: Expert provided correction after clicking NO - generating corrected answer
ğŸ”§ Original verification message: '*Patient Info*: Akshat Sanghvi, Age: 21, Gender: Male, DOB: 1985-03-15

*Question:* Can I take a bath after radiotherapy?
*Answer:* Yes, you can take a bath after radiotherapy, but be gentle with the skin in the treatment area. Use lukewarm or cold water and avoid using soap, oil, or creams on the treated area. Pat your skin dry with a soft towel instead of rubbing it. Always follow any specific recommendations from your healthcare provider regarding skin care.

Is the answer correct?'
ğŸ”§ Correction text: 'no you cannot'
ğŸ”§ DEBUG: Original verification text for correction (after NO): '*Patient Info*: Akshat Sanghvi, Age: 21, Gender: Male, DOB: 1985-03-15

*Question:* Can I take a bath after radiotherapy?
*Answer:* Yes, you can take a bath after radiotherapy, but be gentle with the skin in the treatment area. Use lukewarm or cold water and avoid using soap, oil, or creams on the treated area. Pat your skin dry with a soft towel instead of rubbing it. Always follow any specific recommendations from your healthcare provider regarding skin care.

Is the answer correct?'
ğŸ”§ DEBUG: Parsed verification message for correction (after NO): {'Question': 'Can I take a bath after radiotherapy?', 'Bot_Answer': 'Yes, you can take a bath after radiotherapy, but be gentle with the skin in the treatment area. Use lukewarm or cold water and avoid using soap, oil, or creams on the treated area. Pat your skin dry with a soft towel instead of rubbing it. Always follow any specific recommendations from your healthcare provider regarding skin care.'}
ğŸ”§ DEBUG: Final extracted for correction (after NO) - question: 'Can I take a bath after radiotherapy?', bot_answer: 'Yes, you can take a bath after radiotherapy, but be gentle with the skin in the treatment area. Use lukewarm or cold water and avoid using soap, oil, or creams on the treated area. Pat your skin dry with a soft towel instead of rubbing it. Always follow any specific recommendations from your healthcare provider regarding skin care.'
ğŸ”§ DEBUG: EXACT TEXT BEING CORRECTED BY LLM (after NO):
     Question: 'Can I take a bath after radiotherapy?'
     Original Bot Answer: 'Yes, you can take a bath after radiotherapy, but be gentle with the skin in the treatment area. Use lukewarm or cold water and avoid using soap, oil, or creams on the treated area. Pat your skin dry with a soft towel instead of rubbing it. Always follow any specific recommendations from your healthcare provider regarding skin care.'
     Expert Correction: 'no you cannot'
     Final User Prompt to LLM: 'Following are the question, answer, and correction to the answer:        
 Question: Can I take a bath after radiotherapy?
 Answer: Yes, you can take a bath after radiotherapy, but be gentle with the skin in the treatment area. Use lukewarm or cold water and avoid using soap, oil, or creams on the treated area. Pat your skin dry with a soft towel instead of rubbing it. Always follow any specific recommendations from your healthcare provider regarding skin care.
 Experts Correction for the answer: no you cannot'
ğŸ”§ LLM corrected response: 'No, you should avoid taking a bath immediately after radiotherapy. It's important to follow specific recommendations from your healthcare provider regarding skin care and bathing to ensure proper healing and avoid irritation in the treated area.'
Last active duration 23.974783
Cached False
ğŸ”§ User 002 is_active_user: True
ğŸ”˜ User is active, will send regular text message False
ğŸ”§ DEBUG: Expert approval case - preparing verified message
Thread ID: 9596, Variable Address: 1903590223040, client address: 1903199034640
ğŸ”§ DEBUG: Final message text: 'à¤°à¥‡à¤¡à¤¿à¤¯à¥‹à¤¥à¥‡à¤°à¥‡à¤ªà¥€ à¤•à¥‡ à¤¬à¤¾à¤¦ à¤¤à¥à¤°à¤‚à¤¤ à¤¸à¥à¤¨à¤¾à¤¨ à¤¨à¤¹à¥€à¤‚ à¤•à¤°à¤¨à¤¾ à¤šà¤¾à¤¹à¤¿à¤à¥¤ à¤†à¤ªà¤•à¥‡ à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ à¤¸à¥‡à¤µà¤¾ à¤ªà¥à¤°à¤¦à¤¾             à¤¾à¤¤à¤¾ à¤¸à¥‡ à¤¤à¥à¤µà¤šà¤¾ à¤•à¥€ à¤¦à¥‡à¤–à¤­à¤¾à¤² à¤”à¤° à¤¸...'