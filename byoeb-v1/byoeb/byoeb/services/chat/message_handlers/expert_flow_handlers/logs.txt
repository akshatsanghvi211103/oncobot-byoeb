(byoeb-py3.11) PS C:\Users\t-asanghvi\work\byoeb\byoeb-v1\byoeb\byoeb\chat_app> p3 .\run.py
cool /subscriptions/cef13953-6a76-4434-9a65-1d95481f83c7/resourceGroups/swasthyabot/providers/Microsoft.CognitiveServices/accounts/swasthyabot-speech2 bruh <function get_bearer_token_provider.<locals>.wrapper at 0x00000206635C68E0> nice
INFO:     Started server process [28572]
INFO:     Waiting for application startup.
FastAPI app is running with PID: 28572
hi there
INFO:     Application startup complete.
INFO:     Uvicorn running on http://127.0.0.1:5000 (Press CTRL+C to quit)
DEBUG PRODUCER: Message ID in message: None
DEBUG PRODUCER: Payload ID: auxxQcojVxCYrTLZGkhwHAan1
DEBUG PRODUCER: Using payload ID as fallback: auxxQcojVxCYrTLZGkhwHAan1

=== QIKCHAT MESSAGE CONVERSION DEBUG ===
ğŸ“¥ Converting message: {
  "from": "916352927215",
  "timestamp": "2025-12-10T14:49:10.000Z",
  "audio": {
    "mime_type": "audio/ogg; codecs=opus",
    "sha256": "aNhsf/dH2pFr2l0mBTTZ3NgHJgVCOxKN+UbqPe3uS2Q=",
    "id": "1203555251914127",
    "url": "https://storage.googleapis.com/qikchat-chats/TelfYQC/1203555251914127.ogg",
    "voice": false
  },
  "type": "audio",
  "id": "auxxQcojVxCYrTLZGkhwHAan1"
}
ğŸ“ Detected message type: audio
âœ… Converting as regular message
ğŸ”— NO REPLY CONTEXT: 'context' not in message keys: ['from', 'timestamp', 'audio', 'type', 'id']
=== END QIKCHAT MESSAGE CONVERSION DEBUG ===

[DEBUG] Looking up users by phone_numbers: ['916352927215']
[DEBUG] get_users_by_phone_numbers called with phone_numbers: ['916352927215']
[DEBUG] Using collection: 'users'
C:\Users\t-asanghvi\AppData\Local\pypoetry\Cache\virtualenvs\byoeb-7XHC672s-py3.11\Lib\site-packages\motor\core.py:171: UserWarning: You appear to be connected to a CosmosDB cluster. For more information regarding feature compatibility and support please visit https://www.mongodb.com/supportability/cosmosdb
  delegate = self.__delegate_class__(*args, **kwargs)
[DEBUG] Raw users_obj from DB (by phone numbers): [{'_id': '1101', 'User': {'user_id': '1101', 'user_name': 'Akshat Sanghvi', 'user_location': {}, 'user_language': 'hi', 'user_type': 'byoebuser', 'phone_number_id': '916352927215', 'test_user': False, 'experts': {'byoebexpert': ['919739811075'], 'byoebexpert2': ['919739811075']}, 'audience': [], 'patient_details': {'date_of_birth': '1985-03-15', 'gender': 'Male', 'age': 21}, 'created_timestamp': 1762936642, 'activity_timestamp': 1765377885, 'last_conversations': [{'question': 'Can I take a bath after radiotherapy?', 'answer': 'Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ask more questions.'}, {'question': 'Can I take a bath after radiotherapy?', 'answer': 'Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ask more questions.'}, {'question': 'Can I take a bath after radiotherapy?', 'answer': 'Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ask more questions.'}]}, 'timestamp': '1762936642'}]
[DEBUG] Retrieved user by phone - user_id: '1101', phone_number_id: '916352927215', user_name: 'Akshat Sanghvi', conversations: 3
ğŸ” GET_BOT_MESSAGES: Database returned 0 results
âŒ GET_BOT_MESSAGES: No messages found in database
ğŸ” Let's check what IDs actually exist in the database...
ğŸ” Recent messages in database (last hour): 83
   Recent 1: ID=zf2JUDHl6aniBQgZA5zAXNxZl, Text='Let me check with a KMC doctor and get back to you...'
   Recent 2: ID=Yqd2z7tFPFb5p09smqxr2ggpX, Text='...'
âŒ Failed to get recent messages for debug: 'NoneType' object is not subscriptable
[DEBUG] Looking for user with phone_number_id: '916352927215' in 1 retrieved users
[DEBUG] Found existing user with user_id: '1101', user_name: 'Akshat Sanghvi', phone_number_id: '916352927215', conversations: 3
ğŸ” PROCESSING MESSAGE: Category=byoebuser_to_bot, UserType=byoebuser
ğŸ” Message Text: No text
ğŸ” Added USER conversation to processing queue

=== AUDIO MESSAGE PROCESSING DEBUG ===
Processing audio message with media_id: https://storage.googleapis.com/qikchat-chats/TelfYQC/1203555251914127.ogg
Media download result: status=200, audio_message=True, err=None
âœ… Audio download successful. Data size: 6885 bytes, mime_type: audio/wav
Translating speech to text using AsyncAzureOpenAIWhisper to language: hi
Output text after translation to hi : à¤•à¥à¤¯à¤¾ à¤®à¥ˆà¤‚ à¤°à¥‡à¤¡à¤¿à¤¯à¥‹ à¤¥à¥‡à¤°à¤ªà¥€ à¤•à¥‡ à¤¬à¤¾à¤¦ à¤¨à¤¹à¤¾ à¤¸à¤•à¤¤à¤¾ à¤¹à¥‚à¤?
ğŸ¤ AUDIO TO TEXT: 'à¤•à¥à¤¯à¤¾ à¤®à¥ˆà¤‚ à¤°à¥‡à¤¡à¤¿à¤¯à¥‹ à¤¥à¥‡à¤°à¤ªà¥€ à¤•à¥‡ à¤¬à¤¾à¤¦ à¤¨à¤¹à¤¾ à¤¸à¤•à¤¤à¤¾ à¤¹à¥‚à¤?' (in hi)
ğŸ”¤ AUDIO SOURCE TEXT SET: 'à¤•à¥à¤¯à¤¾ à¤®à¥ˆà¤‚ à¤°à¥‡à¤¡à¤¿à¤¯à¥‹ à¤¥à¥‡à¤°à¤ªà¥€ à¤•à¥‡ à¤¬à¤¾à¤¦ à¤¨à¤¹à¤¾ à¤¸à¤•à¤¤à¤¾ à¤¹à¥‚à¤?'
Thread ID: 26124, Variable Address: 2224971250496, client address: 2226460158096
ğŸ”¤ AUDIO TRANSLATION: 'à¤•à¥à¤¯à¤¾ à¤®à¥ˆà¤‚ à¤°à¥‡à¤¡à¤¿à¤¯à¥‹ à¤¥à¥‡à¤°à¤ªà¥€ à¤•à¥‡ à¤¬à¤¾à¤¦ à¤¨à¤¹à¤¾ à¤¸à¤•à¤¤à¤¾ à¤¹à¥‚à¤?' -> 'Can I take a bath after radiotherapy?'

=== RESPONSE GENERATION DEBUG ===
ğŸ“ Original message: 'à¤•à¥à¤¯à¤¾ à¤®à¥ˆà¤‚ à¤°à¥‡à¤¡à¤¿à¤¯à¥‹ à¤¥à¥‡à¤°à¤ªà¥€ à¤•à¥‡ à¤¬à¤¾à¤¦ à¤¨à¤¹à¤¾ à¤¸à¤•à¤¤à¤¾ à¤¹à¥‚à¤?'
ğŸ“¤ English message for KB: 'Can I take a bath after radiotherapy?'
ğŸ‘¤ User: 916352927215 (language: hi)

ğŸ” MULTI-KB SEARCH DEBUG:
ğŸ” Query: 'Can I take a bath after radiotherapy?'
ğŸ” Searching 4 knowledge bases...
ğŸ” Searching KB1 (Q&A pairs) with filter: source eq 'oncobot_knowledge_base'
ğŸ” KB1 returned 3 Q&A results
ğŸ” Searching KB2 (Markdown) with filter: source eq 'kb2_content'
ğŸ” KB2 returned 2 Markdown results
ğŸ” Searching KB3 (Markdown) with filter: source eq 'kb3_content'
ğŸ” KB3 returned 2 Markdown results
ğŸ” Searching KB1_Expert (Expert Corrections) with filter: source eq 'oncobot_expert_knowledge_base'
ğŸ” KB1_Expert returned 1 Expert-validated results
ğŸ” Total chunks retrieved: 8 (KB1: 3, KB2: 2, KB3: 2, KB1_Expert: 1)

=== KB CONTEXT RETRIEVED (8 chunks) ===
Query: Can I take a bath after radiotherapy?
Chunk 1:
  Question: Can I use soap on the rest of my body while undergoing radiation therapy?
  Source: oncobot_knowledge_base
  Content: Question: Can I use soap on the rest of my body while undergoing radiation therapy?
Answer: Yes, you can use mild soap on the rest of your body while undergoing radiation therapy. However, be gentle a...
  ---
=== END KB CONTEXT ===


=== FULL LLM INPUT DEBUG ===
Message 1 (system):
  Content: You are an expert oncology assistant helping cancer patients. Your purpose is to answer patients with any oncology-related queries they might have.    

You have access to four knowledge bases:
- KB1: Q&A pairs covering general oncology topics.
- KB2 & KB3: Detailed radiation therapy treatment guides and procedures.
- KB1_Expert: Expert-validated corrections and high-priority answers (marked with [EXPERT-VALIDATED]).

Guidelines for answering:
- USE [EXPERT-VALIDATED] content ONLY when it is directl...
Message 2 (user):
  Content: The following knowledge base context has been retrieved from multiple sources to help answer your question. Content marked with [EXPERT-VALIDATED] has been specifically reviewed by medical professionals - use this content ONLY if it directly relates to the user's question:

KNOWLEDGE BASE CONTEXT:
Question: Can I use soap on the rest of my body while undergoing radiation therapy?
Answer: Yes, you can use mild soap on the rest of your body while undergoing radiation therapy. However, be gentle an...
ğŸ” Question being processed: 'Can I take a bath after radiotherapy?'
ğŸ” Number of chunks: 8
=== END FULL LLM INPUT DEBUG ===


=== LLM RESPONSE DEBUG ===
ğŸ”¤ Raw LLM response_text: '<BEGIN RESPONSE>
Yes, you can take a bath after radiotherapy, but it's important to be gentle with your skin, especially in the treatment area. Use lukewarm water and avoid using soap, oil, or cream on the treated area. Pat your skin dry with a soft towel instead of rubbing it. If you have any concerns about skin care, please consult your healthcare provider for personalized advice.
<END RESPONSE>

<BEGIN QUERY TYPE>
medical
<END QUERY TYPE>'
ğŸ”¤ Response length: 445
ğŸ”¤ Contains 'Sorry': False
ğŸ”¤ Contains 'assist': False
=== END LLM RESPONSE DEBUG ===

Generated answer:  Yes, you can take a bath after radiotherapy, but it's important to be gentle with your skin, especially in the treatment area. Use lukewarm water and avoid using soap, oil, or cream on the treated area. Pat your skin dry with a soft towel instead of rubbing it. If you have any concerns about skin care, please consult your healthcare provider for personalized advice.
Query the type:  medical
Query the type:  medical
ğŸ“Š CLASSIFICATION_FIX: Set original message category to 'byoebuser_to_bot' for proper filtering
finding here ['Can I use deodorant during radiation therapy?', 'What should I do if my skin becomes itchy?', 'Is it safe to swim in a pool during treatment?']
Thread ID: 26124, Variable Address: 2224923314688, client address: 2226460158096
Thread ID: 26124, Variable Address: 2224923314688, client address: 2226460158096
Thread ID: 26124, Variable Address: 2224923314688, client address: 2226460158096
âœ… Translated 3 related questions to hi
ğŸ‘¨â€âš•ï¸ Using doctor waiting message for medical query
ğŸ”¤ WAITING MESSAGE: Localized (hi): 'à¤®à¥ˆà¤‚ à¤•à¥‡-à¤à¤®-à¤¸à¥€ à¤•à¥‡ à¤¡à¥‰à¤•à¥à¤Ÿà¤° à¤¸à¥‡ à¤ªà¥‚à¤› à¤•à¤° à¤†à¤ªà¤•à¥‹ à¤à¤• à¤¸à¤Ÿà¥€à¤• à¤‰à¤¤à¥à¤¤à¤° à¤¦à¥‚à¤à¤—à¤¾à¥¤ à¤¤à¤¬ à¤¤à¤•, à¤¬à¥‡à¤à¤¿à¤à¤• à¤”à¤° à¤ªà¥à¤°à¤¶à¥à¤¨ à¤ªà¥‚à¤›à¥‡à¤‚à¥¤'
ğŸ”¤ WAITING MESSAGE: English: 'Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ask more questions.'
ğŸ”— DEBUG: Storing original user question ID for reply context: auxxQcojVxCYrTLZGkhwHAan1
ğŸ”¤ TRANSLATION DEBUG: About to translate message to hi
ğŸ”¤ TRANSLATION DEBUG: Input text: 'à¤®à¥ˆà¤‚ à¤•à¥‡-à¤à¤®-à¤¸à¥€ à¤•à¥‡ à¤¡à¥‰à¤•à¥à¤Ÿà¤° à¤¸à¥‡ à¤ªà¥‚à¤› à¤•à¤° à¤†à¤ªà¤•à¥‹ à¤à¤• à¤¸à¤Ÿà¥€à¤• à¤‰à¤¤à¥à¤¤à¤° à¤¦à¥‚à¤à¤—à¤¾à¥¤ à¤¤à¤¬ à¤¤à¤•, à¤¬à¥‡à¤à¤¿à¤à¤• à¤”à¤° à¤ªà¥à¤°à¤¶à¥à¤¨ à¤ªà¥‚à¤›à¥‡à¤‚à¥¤'
Thread ID: 26124, Variable Address: 2224923314688, client address: 2226460158096
ğŸ”¤ TRANSLATION DEBUG: Final result: 'à¤®à¥ˆà¤‚ à¤•à¥‡-à¤à¤®-à¤¸à¥€ à¤•à¥‡ à¤¡à¥‰à¤•à¥à¤Ÿà¤° à¤¸à¥‡ à¤ªà¥‚à¤› à¤•à¤° à¤†à¤ªà¤•à¥‹ à¤à¤• à¤¸à¤Ÿà¥€à¤• à¤‰à¤¤à¥à¤¤à¤° à¤¦à¥‚à¤à¤—à¤¾à¥¤ à¤¤à¤¬ à¤¤à¤•, à¤¬à¥‡à¤à¤¿à¤à¤• à¤”à¤° à¤ªà¥à¤°à¤¶à¥à¤¨ à¤ªà¥‚à¤›à¥‡à¤‚à¥¤'
ğŸ”¤ TRANSLATION DEBUG: Translation used: True
ğŸ”¤ ENGLISH TEXT: Using provided English text: 'Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ask more questions.'
ï¿½ Creating user response message...
ğŸ”— Adding 3 follow-up questions to interactive list
ğŸ”— DEBUG: Creating reply context - user message ID: auxxQcojVxCYrTLZGkhwHAan1
ğŸ”— DEBUG: Created main waiting message reply context with reply_id: auxxQcojVxCYrTLZGkhwHAan1
ğŸ”— DEBUG: Main waiting message ID: 8cb672c7-51dd-4661-b9b2-218e8c984089
ğŸµ Generating TTS audio again for message...
running tts now
running tts now again
ğŸ”§ SPEECH DEBUG - SUCCESS: Generated 109152 bytes of audio
ğŸ”§ TTS DEBUG - Received audio_bytes: <class 'bytes'>, length: 109152
running tts now again 2
ğŸµ TTS audio message generated successfully with SAS URL
ğŸ”— DEBUG: Audio message reply context reply_id: auxxQcojVxCYrTLZGkhwHAan1
ğŸ”— DEBUG: Audio message ID: d8f3821e-e08e-478f-ad51-2f53038dacf3
ğŸ’¬ Returning 2 messages: ['interactive_list_reply', 'regular_audio']
âœ… Waiting messages sent to user (in hi)
ğŸ‘¨â€âš•ï¸ Creating expert verification message...
expert result {'byoebexpert': ['919739811075'], 'byoebexpert2': ['919739811075']}
expert result 2 ('919739811075', 'byoebexpert') medical
ğŸ‘¨â€âš•ï¸ Using configured expert: 919739811075 (byoebexpert)
ğŸ†” Generated expert user_id: d7022499fc5fbcd34df184209477a79f from phone: 919739811075
ğŸ‘¤ Added patient context for expert: 2 lines
ğŸ¤ DEBUG [Creating expert verification]: Original user query was audio: True
ğŸ”§ Expert additional_info template_language: en (type: <class 'str'>)
ğŸ“‹ Template parameters created:
  {1} Patient Info: Akshat Sanghvi, Age: 21, Gender: Male, DOB: 1985-03-15
  {2} Question: Can I take a bath after radiotherapy?
  {3} Answer: Yes, you can take a bath after radiotherapy, but it's important to be gentle with your skin, especially in the treatment area. Use lukewarm water and avoid using soap, oil, or cream on the treated area. Pat your skin dry with a soft towel instead of rubbing it. If you have any concerns about skin care, please consult your healthcare provider for personalized advice.
ğŸ” DEBUG [Expert message creation]: additional_info contents:
        emoji: None
        verification_status: pending
        button_titles: ['Yes', 'No']
        template_name: verification_with_butons
        template_language: en
        template_parameters: ['Akshat Sanghvi, Age: 21, Gender: Male, DOB: 1985-03-15', 'Can I take a bath after radiotherapy?', ...
     âœ… is_audio_query: True
        related_questions: ['à¤•à¥à¤¯à¤¾ à¤®à¥ˆà¤‚ à¤°à¥‡à¤¡à¤¿à¤à¤¶à¤¨ à¤¥à¥‡à¤°à¥‡à¤ªà¥€ à¤•à¥‡ à¤¦à¥Œà¤°à¤¾à¤¨ à¤¡à¤¿à¤¯à¥‹à¤¡à¤°à¥‡à¤‚à¤Ÿ à¤•à¤¾ à¤‰à¤ªà¤¯à¥‹à¤— à¤•à¤° à¤¸à¤•à¤¤à¤¾ à¤¹à¥‚à¤?', 'à¤…à¤—à¤° à¤†à¤ªà¤•à¥€ à¤¤à¥à¤µà¤šà¤¾ à¤®à¥‡à¤‚ à¤–à¥à¤œà¤²à¥€ à¤¹à¥‹ à¤°à¤¹...
ğŸ‘¨â€âš•ï¸ Expert message created with patient info in template format
ğŸ” DEBUG [After expert message creation]: message_context.additional_info has is_audio_query: True
     Value: True
âœ… Expert verification message created
ğŸ‰ Complete! Generated 5 messages (original user message + waiting messages + expert verification + read receipt)
ğŸ“¥ INCOMING: regular_audio, ID=auxxQcojVxCYrTLZGkhwHAan1
ğŸ“¤ OUTGOING: interactive_list_reply, ID=8cb672c7-51dd-4661-b9b2-218e8c984089
ğŸ“¤ OUTGOING: regular_audio, ID=d8f3821e-e08e-478f-ad51-2f53038dacf3
ğŸ” MESSAGE BREAKDOWN: Total=5, Incoming=1, Outgoing=2, Expert=1, ReadReceipt=1
ğŸ” User message 1: Type=interactive_list_reply, ID=8cb672c7-51dd-4661-b9b2-218e8c984089
ğŸ” User message 2: Type=regular_audio, ID=d8f3821e-e08e-478f-ad51-2f53038dacf3
ğŸ”§ DEBUG: Using channel_type='qikchat' -> service=QikchatService
ğŸ’¬ Sending response: Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ...
ğŸ·ï¸ Query type: medical
ğŸ‘¨â€âš•ï¸ Found expert verification message for 919739811075
ğŸ“¤ Processing user message 1/2: interactive_list_reply
ğŸ” HANDLE_USER: Processing interactive_list_reply
Checking interactive list - has description: True, has row_texts: True, row_texts not None: True, result: True
ğŸ” HANDLE_USER: Prepared 1 requests

=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 1 requests
ğŸ“¤ Request 1: {'to_contact': '916352927215', 'type': 'interactive', 'interactive': {'type': 'list', 'body': {'text': 'à¤®à¥ˆà¤‚ à¤•à¥‡-à¤à¤®-à¤¸à¥€ à¤•à¥‡ à¤¡à¥‰à¤•à¥à¤Ÿà¤° à¤¸à¥‡ à¤ªà¥‚à¤› à¤•à¤° à¤†à¤ªà¤•à¥‹ à¤à¤• à¤¸à¤Ÿà¥€      à¥€à¤• à¤‰à¤¤à¥à¤¤à¤° à¤¦à¥‚à¤à¤—à¤¾à¥¤ à¤¤à¤¬ à¤¤à¤•, à¤¬à¥‡à¤à¤¿à¤à¤• à¤”à¤° à¤ªà¥à¤°à¤¶à¥à¤¨ à¤ªà¥‚à¤›à¥‡à¤‚à¥¤'}, 'action': {'button': 'à¤¸à¤‚à¤¬à¤‚à¤§à¤¿à¤¤ à¤ªà¥à¤°à¤¶à¥à¤¨', 'sections': [{'title': '', 'rows': [{'id': 'option_0', 'title': 'Q1', 'des            scription': 'à¤•à¥à¤¯à¤¾ à¤®à¥ˆà¤‚ à¤°à¥‡à¤¡à¤¿à¤à¤¶à¤¨ à¤¥à¥‡à¤°à¥‡à¤ªà¥€ à¤•à¥‡ à¤¦à¥Œà¤°à¤¾à¤¨ à¤¡à¤¿à¤¯à¥‹à¤¡à¤°à¥‡à¤‚à¤Ÿ à¤•à¤¾ à¤‰à¤ªà¤¯à¥‹à¤— à¤•à¤° à¤¸à¤•à¤¤à¤¾ à¤¹à¥‚à¤?'}, {'id': 'option_1', 'title': 'Q2', 'description': 'à¤…à¤—à¤° à¤†à¤ªà¤•à¥€ à¤¤à¥à¤µà¤šà¤¾ à¤®à¥‡à¤‚ à¤–à¥à¤œà¤²à¥€ à¤¹à¥‹ à¤°à¤¹à¥€                à¤¹à¥ˆ, à¤¤à¥‹ à¤†à¤ª à¤ à¤‚à¤¡à¥‡ à¤ªà¤¾à¤¨à¥€ à¤¸à¥‡ à¤§à¥‹ à¤¸à¤•à¤¤à¥‡ à¤¹à¥ˆà¤‚, à¤®...'}, {'id': 'option_2', 'title': 'Q3', 'description': 'à¤•à¥à¤¯à¤¾ à¤‡à¤²à¤¾à¤œ à¤•à¥‡ à¤¦à¥Œà¤°à¤¾à¤¨ à¤ªà¥‚à¤² à¤®à¥‡à¤‚ à¤¤à¥ˆà¤°à¤¨à¤¾ à¤¸à¥à¤°à¤•à¥à¤·à¤¿à¤¤ à¤¹à¥ˆ?'}]}]}}, 'context': {'m               message_id': 'auxxQcojVxCYrTLZGkhwHAan1'}}
ğŸ“¤ Got 1 results
ğŸ“¤ Result 1: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'EZMXe7htXETLceGm3HV65iqrH', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '916352927215', 'credits': 0, 'created_at': '2025-12-10T14:50:21.274Z', 'status': 'processing'}]}
ğŸ“¤ Extracted message_id for result 1: EZMXe7htXETLceGm3HV65iqrH
ğŸ“¤ Final message_ids: ['EZMXe7htXETLceGm3HV65iqrH']
=== END QIKCHAT SEND_REQUESTS DEBUG ===


=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 0 requests
ğŸ“¤ Got 0 results
ğŸ“¤ Final message_ids: []
=== END QIKCHAT SEND_REQUESTS DEBUG ===

ğŸ“¤ Processing user message 2/2: regular_audio
ğŸ” HANDLE_USER: Processing regular_audio
Checking interactive list - has description: False, has row_texts: False, row_texts not None: False, result: False
ğŸµ Preparing audio message request (async)...
ğŸµ Using audio URL: https://smartkcstorage1.blob.core.windows.net/onco...
ğŸµ Audio message request prepared
ğŸ” HANDLE_USER: Prepared 1 requests
ğŸµ Sending audio message...
ğŸµ Audio message only (no follow-up questions)
ğŸµ Found 1 audio requests to send

=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 1 requests
ğŸ“¤ Request 1: {'to_contact': '916352927215', 'type': 'audio', 'audio': {'link': 'https://smartkcstorage1.blob.core.windows.net/oncobot-container/tts_audio_35ea42fea2c245bab86742c1d32a619a.mp3?st=2025-12-10T14%3A50%3A19Z&se=2025-12-10T15%3A50%3A19Z&sp=r&sv=2025-01-05&sr=b&skoid=f5b64d94-ba27-422a-abb5-cad2b511c671&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2025-12-10T14%3A50%3A19Z&ske=2025-12-10T15%3A50%3A19Z&sks=b&skv=2025-01-05&sig=B1IJ4QlG3fKv7ip3dVIbrEbcddsC0bwesTD91B71LIE%3D'}, 'context': {'message_id': 'auxxQcojVxCYrTLZGkhwHAan1'}}
ğŸ“¤ Got 1 results
ğŸ“¤ Result 1: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'DEqJaxWcLNUC274rU2KvO1qiw', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '916352927215', 'credits': 0, 'created_at': '2025-12-10T14:50:21.455Z', 'status': 'processing'}]}
ğŸ“¤ Extracted message_id for result 1: DEqJaxWcLNUC274rU2KvO1qiw
ğŸ“¤ Final message_ids: ['DEqJaxWcLNUC274rU2KvO1qiw']
=== END QIKCHAT SEND_REQUESTS DEBUG ===


=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 0 requests
ğŸ“¤ Got 0 results
ğŸ“¤ Final message_ids: []
=== END QIKCHAT SEND_REQUESTS DEBUG ===

ğŸ”§ Handling expert message for: 919739811075
ğŸ”§ Expert user_id: d7022499fc5fbcd34df184209477a79f
Last active duration 276.574581
Cached False
ğŸ”§ Expert is_active_user: True
ğŸ”˜ Sending interactive button to active expert

=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 1 requests
ğŸ“¤ Request 1: {'to_contact': '919739811075', 'type': 'interactive', 'interactive': {'type': 'button', 'body': {'text': "*Patient Info*: Akshat Sanghvi, Age: 21, Gender: Male, DOB: 1985-03-15\n\n*Question:* Can I take a bath after radiotherapy?\n*Answer:* Yes, you can take a bath after radiotherapy, but it's important to be gentle with your skin, especially in the treatment area. Use lukewarm water and avoid using soap, oil, or cream on the treated area. Pat your skin dry with a soft towel instead of rubbing it. If you have any concerns about skin care, please consult your healthcare provider for personalized advice.\n\nIs the answer correct?"}, 'action': {'buttons': [{'type': 'reply', 'reply': {'id': '58fa9556-de1e-4809-9903-4f9a66ecc58c', 'title': 'Yes'}}, {'type': 'reply', 'reply': {'id': '0fc8e4c0-9de1-4565-a79f-adbc7543acbc', 'title': 'No'}}]}}}
ğŸ“¤ Got 1 results
ğŸ“¤ Result 1: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'Pg18GJ6sUpmoU2XWAKP0WSKY4', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '919739811075', 'credits': 0, 'created_at': '2025-12-10T14:50:21.937Z', 'status': 'processing'}]}
ğŸ“¤ Extracted message_id for result 1: Pg18GJ6sUpmoU2XWAKP0WSKY4
ğŸ“¤ Final message_ids: ['Pg18GJ6sUpmoU2XWAKP0WSKY4']
=== END QIKCHAT SEND_REQUESTS DEBUG ===

responses [{'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'Pg18GJ6sUpmoU2XWAKP0WSKY4', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '919739811075', 'credits': 0, 'created_at': '2025-12-10T14:50:21.937Z', 'status': 'processing'}]}]
ğŸ“Œ Skipping emoji reaction (emoji is None)

=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 0 requests
ğŸ“¤ Got 0 results
ğŸ“¤ Final message_ids: []
=== END QIKCHAT SEND_REQUESTS DEBUG ===

âœ… Sent 2 user messages and expert verifier message!
âœ… Response sent successfully!
ğŸ” CREATE_CONV DEBUG:
   byoeb_user_message.message_context.message_id: 8cb672c7-51dd-4661-b9b2-218e8c984089
   byoeb_user_message.reply_context.reply_id: auxxQcojVxCYrTLZGkhwHAan1
ğŸ”— REPLY_CONTEXT_FIX: Using reply_context.reply_id as original user question ID: auxxQcojVxCYrTLZGkhwHAan1
ğŸ•’ CREATE_CONV Response 1/2: created_at from QikChat = 2025-12-10T14:50:21.274Z
ğŸ•’ CREATE_CONV: Parsed QikChat created_at to Unix timestamp: 1765378221
ğŸµ AUDIO_URL_FIX: Using original message 1 additional_info
ğŸ”— REPLY_CONTEXT_FIX: Bot message 1 reply_id set to: auxxQcojVxCYrTLZGkhwHAan1 (QikChat ID: EZMXe7htXETLceGm3HV65iqrH)
ğŸ•’ CREATE_CONV Response 2/2: created_at from QikChat = 2025-12-10T14:50:21.455Z
ğŸ•’ CREATE_CONV: Parsed QikChat created_at to Unix timestamp: 1765378221
ğŸµ AUDIO_URL_FIX: Using original message 2 additional_info
ğŸµ AUDIO_URL_FIX: Found audio_url in original message: https://smartkcstorage1.blob.core.windows.net/onco...
ğŸ”— REPLY_CONTEXT_FIX: Bot message 2 reply_id set to: auxxQcojVxCYrTLZGkhwHAan1 (QikChat ID: DEqJaxWcLNUC274rU2KvO1qiw)
ğŸ”§ EXPERT MESSAGE ID DEBUG:
   Original expert ID: 61212bf4-aaf4-4285-b143-40e471fc38ac
   Expert responses count: 1
   First expert response: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'Pg18GJ6sUpmoU2XWAKP0WSKY4', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '919739811075', 'credits': 0, 'created_at': '2025-12-10T14:50:21.937Z', 'status': 'processing'}]}
ğŸ§¹ FILTER_DUPLICATES: Before filtering - 2 entries in messages_context
ğŸ§¹ FILTER_DUPLICATES: Keeping entry: b5060b57-c73e-418c-8a33-9f8635bb2436 (UUID: True, Corrected: False)
ğŸ§¹ FILTER_DUPLICATES: Keeping entry: 2fb4a153-66f7-4b01-99c5-a07fb099944f (UUID: True, Corrected: False)
ğŸ§¹ FILTER_DUPLICATES: After filtering - 2 entries remaining
ğŸ”§ CREATE_CROSS_CONV: Processing 1 expert responses
ğŸ”§ CREATE_CROSS_CONV: Expert response 1: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'Pg18GJ6sUpmoU2XWAKP0WSKY4', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '919739811075', 'credits': 0, 'created_at': '2025-12-10T14:50:21.937Z', 'status': 'processing'}]}
ğŸ”§ CREATE_CROSS_CONV: Top-level message ID: None
ğŸ”§ CREATE_CROSS_CONV: Checking data array with 1 items
ğŸ”§ CREATE_CROSS_CONV: Found message ID in data[0]: Pg18GJ6sUpmoU2XWAKP0WSKY4
ğŸ”§ CREATE_CROSS_CONV: Final extracted expert message ID: Pg18GJ6sUpmoU2XWAKP0WSKY4
ğŸ”§ CREATE_CROSS_CONV: Original expert message ID: 61212bf4-aaf4-4285-b143-40e471fc38ac
ğŸ”§ CREATE_CROSS_CONV: Updated expert message ID: 61212bf4-aaf4-4285-b143-40e471fc38ac -> Pg18GJ6sUpmoU2XWAKP0WSKY4
ğŸ”§ CREATE_CROSS_CONV: Expert message will be stored with Qikchat ID: Pg18GJ6sUpmoU2XWAKP0WSKY4
ğŸ”§ CREATE_CROSS_CONV: Returning 3 messages for database storage
   Message 1: ID=b5060b57-c73e-418c-8a33-9f8635bb2436, Type=interactive_list_reply, Text='...'
   Message 2: ID=2fb4a153-66f7-4b01-99c5-a07fb099944f, Type=interactive_list_reply, Text='...'
   Message 3: ID=Pg18GJ6sUpmoU2XWAKP0WSKY4, Type=interactive_button_reply, Text='*Patient Info*: Akshat Sanghvi, Age: 21, Gender: M...'
   Expert ID after create_cross_conv: Pg18GJ6sUpmoU2XWAKP0WSKY4
   ID changed: True
   â„¹ï¸ Expert message will be stored in database with correct QikChat ID: Pg18GJ6sUpmoU2XWAKP0WSKY4
ğŸ” CLASSIFICATION_FIX: Found original user message with ID auxxQcojVxCYrTLZGkhwHAan1
ğŸ” CLASSIFICATION_FIX: Using original user message with preserved classification
ğŸ“ Using original message ID from reply context: auxxQcojVxCYrTLZGkhwHAan1
ğŸ”§ Created USER_TO_BOT message:
   ID: auxxQcojVxCYrTLZGkhwHAan1
   Text: 'Can I take a bath after radiotherapy?...'

=== USER HANDLER MESSAGE STORAGE DEBUG ===
ğŸ“Š Total conversations to store: 6
  1. ID: auxxQcojVxCYrTLZGkhwHAan1
     Category: byoebuser_to_bot
     Type: regular_audio
     Text: 'Can I take a bath after radiotherapy?...'
  2. ID: EZMXe7htXETLceGm3HV65iqrH
     Category: bot_to_byoebuser_response
     Type: interactive_list_reply
     Text: 'Let me check with a KMC doctor and get back to you...'
  3. ID: DEqJaxWcLNUC274rU2KvO1qiw
     Category: bot_to_byoebuser_response
     Type: regular_audio
     Text: '...'
  4. ID: b5060b57-c73e-418c-8a33-9f8635bb2436
     Category: None
     Type: interactive_list_reply
     Text: '...'
  5. ID: 2fb4a153-66f7-4b01-99c5-a07fb099944f
     Category: None
     Type: interactive_list_reply
     Text: '...'
  6. ID: Pg18GJ6sUpmoU2XWAKP0WSKY4
     Category: bot_to_byoebexpert_verification
     Type: interactive_button_reply
     Text: '*Patient Info*: Akshat Sanghvi, Age: 21, Gender: M...'
=== END USER HANDLER DEBUG ===

ğŸ” MESSAGE_CREATE_QUERIES: Processing 6 messages for database storage
ğŸ•’ TIMESTAMP_DEBUG Message 1/6: ID=auxxQcojVxCYrTLZGkhw
   has_outgoing_timestamp: 1765378221
   outgoing_timestamp value: 1765378221
   final timestamp: 1765378221
   message_type: regular_audio
ğŸ” MESSAGE_CREATE_QUERIES: Message 1
   Message ID: auxxQcojVxCYrTLZGkhwHAan1
   Message Type: regular_audio
   Message Class: medical
   Is Expert Verification: False
   QikChat Audio ID: None
   Text Preview: Can I take a bath after radiotherapy?...
ğŸ•’ TIMESTAMP_DEBUG Message 2/6: ID=EZMXe7htXETLceGm3HV6
   has_outgoing_timestamp: 1765378221
   outgoing_timestamp value: 1765378221
   final timestamp: 1765378221
   message_type: interactive_list_reply
ğŸ” MESSAGE_CREATE_QUERIES: Message 2
   Message ID: EZMXe7htXETLceGm3HV65iqrH
   Message Type: interactive_list_reply
   Message Class: Not classified
   Is Expert Verification: False
   QikChat Audio ID: None
   Text Preview: Let me check with a KMC doctor and get back to you with a verified answer. Until...
ğŸ•’ TIMESTAMP_DEBUG Message 3/6: ID=DEqJaxWcLNUC274rU2Kv
   has_outgoing_timestamp: 1765378221
   outgoing_timestamp value: 1765378221
   final timestamp: 1765378221
   message_type: regular_audio
ğŸ” MESSAGE_CREATE_QUERIES: Message 3
   Message ID: DEqJaxWcLNUC274rU2KvO1qiw
   Message Type: regular_audio
   Message Class: Not classified
   Is Expert Verification:
   QikChat Audio ID: None
   Text Preview: ...
ğŸ•’ TIMESTAMP_DEBUG Message 4/6: ID=b5060b57-c73e-418c-8
   has_outgoing_timestamp: None
   outgoing_timestamp value: None
   final timestamp: 1765378221
   message_type: interactive_list_reply
ğŸ” MESSAGE_CREATE_QUERIES: Message 4
   Message ID: b5060b57-c73e-418c-8a33-9f8635bb2436
   Message Type: interactive_list_reply
   Message Class: Not classified
   Is Expert Verification: None
   QikChat Audio ID: None
   Text Preview: ...
ğŸ•’ TIMESTAMP_DEBUG Message 5/6: ID=2fb4a153-66f7-4b01-9
   has_outgoing_timestamp: None
   outgoing_timestamp value: None
   final timestamp: 1765378221
   message_type: interactive_list_reply
ğŸ” MESSAGE_CREATE_QUERIES: Message 5
   Message ID: 2fb4a153-66f7-4b01-99c5-a07fb099944f
   Message Type: interactive_list_reply
   Message Class: Not classified
   Is Expert Verification: None
   QikChat Audio ID: None
   Text Preview: ...
ğŸ•’ TIMESTAMP_DEBUG Message 6/6: ID=Pg18GJ6sUpmoU2XWAKP0
   has_outgoing_timestamp: None
   outgoing_timestamp value: None
   final timestamp: 1765378221
   message_type: interactive_button_reply
ğŸ” MESSAGE_CREATE_QUERIES: Message 6
   Message ID: Pg18GJ6sUpmoU2XWAKP0WSKY4
   Message Type: interactive_button_reply
   Message Class: Not classified
   Is Expert Verification: True
   QikChat Audio ID: None
   Text Preview: *Patient Info*: Akshat Sanghvi, Age: 21, Gender: Male, DOB: 1985-03-15

*Questio...
   ğŸ” Expert verification additional_info keys: ['verification_status']
ğŸ” MESSAGE_CREATE_QUERIES: Generated 6 database create queries
ğŸ” FINAL_QUERIES_DEBUG: About to return 6 queries:
   Query 1: ID=auxxQcojVxCYrTLZGkhwHAan1, has_text=True, has_audio=False
   Query 2: ID=EZMXe7htXETLceGm3HV65iqrH, has_text=True, has_audio=False
   Query 3: ID=DEqJaxWcLNUC274rU2KvO1qiw, has_text=False, has_audio=True
   Query 4: ID=b5060b57-c73e-418c-8a33-9f8635bb2436, has_text=False, has_audio=False
   Query 5: ID=2fb4a153-66f7-4b01-99c5-a07fb099944f, has_text=False, has_audio=False
   Query 6: ID=Pg18GJ6sUpmoU2XWAKP0WSKY4, has_text=True, has_audio=False
Saving conversation history: Q: Can I take a bath after radiotherapy? | A: Let me check with a KMC doctor and get back to you with a verified answer. Until then, feel free to ...
ğŸ” PROCESSING RESULTS: Got 1 results from handlers
âœ… Result 0: MSG_CREATE=6, MSG_UPDATE=0, USER_CREATE=0, USER_UPDATE=1
Executing database queries - User updates: 1, Message creates: 6
ğŸ” EXECUTE_QUERIES: Starting execution with queries: ['create', 'update']
ğŸ” EXECUTE_QUERIES: Executing 6 CREATE operations
   CREATE 1: Message ID = auxxQcojVxCYrTLZGkhwHAan1
   CREATE 2: Message ID = EZMXe7htXETLceGm3HV65iqrH
   CREATE 3: Message ID = DEqJaxWcLNUC274rU2KvO1qiw
   CREATE 4: Message ID = b5060b57-c73e-418c-8a33-9f8635bb2436
   CREATE 5: Message ID = 2fb4a153-66f7-4b01-99c5-a07fb099944f
   CREATE 6: Message ID = Pg18GJ6sUpmoU2XWAKP0WSKY4
Inserting documents: ['auxxQcojVxCYrTLZGkhwHAan1', 'EZMXe7htXETLceGm3HV65iqrH', 'DEqJaxWcLNUC274rU2KvO1qiw', 'b5060b57-c73e-418c-8a33-9f8635bb2436', '2fb4a153-66f7-4b01-99c5-a07fb099944f', 'Pg18GJ6sUpmoU2XWAKP0WSKY4']
âœ… EXECUTE_QUERIES: CREATE operations completed successfully
   Result: (['auxxQcojVxCYrTLZGkhwHAan1', 'EZMXe7htXETLceGm3HV65iqrH', 'DEqJaxWcLNUC274rU2KvO1qiw', 'b5060b57-c73e-418c-8a33-9f8635bb2436', '2fb4a153-66f7-4b01-99c5-a07fb099944f', 'Pg18GJ6sUpmoU2XWAKP0WSKY4'], None)
Database operations completed in 0.76 seconds
hi there
DEBUG PRODUCER: Message ID in message: None
DEBUG PRODUCER: Payload ID: qgomoP1RdEfC0MCJv5rzqbatz
DEBUG PRODUCER: Using payload ID as fallback: qgomoP1RdEfC0MCJv5rzqbatz

=== QIKCHAT MESSAGE CONVERSION DEBUG ===
ğŸ“¥ Converting message: {
  "from": "919739811075",
  "timestamp": "2025-12-10T14:50:34.000Z",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "58fa9556-de1e-4809-9903-4f9a66ecc58c",
      "title": "Yes"
    }
  },
  "type": "interactive",
  "context": {
    "messageId": "Pg18GJ6sUpmoU2XWAKP0WSKY4"
  },
  "id": "qgomoP1RdEfC0MCJv5rzqbatz"
}
ğŸ“ Detected message type: interactive
ğŸ”˜ Converting as interactive message
ğŸ” Interactive context data found: {'messageId': 'Pg18GJ6sUpmoU2XWAKP0WSKY4'}
ğŸ”— INTERACTIVE REPLY CONTEXT FOUND: reply_to_message_id = Pg18GJ6sUpmoU2XWAKP0WSKY4
âœ… Interactive conversion successful
   - Reply ID: Pg18GJ6sUpmoU2XWAKP0WSKY4
=== END QIKCHAT MESSAGE CONVERSION DEBUG ===

INFO:     35.207.205.165:0 - "POST /webhook/whk HTTP/1.1" 200 OK
[DEBUG] Looking up users by phone_numbers: ['919739811075']
[DEBUG] get_users_by_phone_numbers called with phone_numbers: ['919739811075']
[DEBUG] Using collection: 'users'
[DEBUG] Raw users_obj from DB (by phone numbers): [{'_id': 'd7022499fc5fbcd34df184209477a79f', 'User': {'user_id': 'd7022499fc5fbcd34df184209477a79f', 'user_name': None, 'user_location': {}, 'user_language': 'en', 'user_type': 'byoebexpert', 'phone_number_id': '919739811075', 'test_user': False, 'experts': {}, 'audience': ['916360720233', '916352927215'], 'patient_details': {}, 'created_timestamp': 1762936628, 'activity_timestamp': 1765377945, 'last_conversations': []}, 'timestamp': '1762936628'}]
[DEBUG] Retrieved user by phone - user_id: 'd7022499fc5fbcd34df184209477a79f', phone_number_id: '919739811075', user_name: 'None', conversations: 0
ğŸ” GET_BOT_MESSAGES: Database returned 1 results
âœ… GET_BOT_MESSAGES: Found matching messages
   Found 1: ID=Pg18GJ6sUpmoU2XWAKP0WSKY4
ğŸ¤– Bot message 0: ID=Pg18GJ6sUpmoU2XWAKP0WSKY4
[DEBUG] Looking for user with phone_number_id: '919739811075' in 1 retrieved users
[DEBUG] Found existing user with user_id: 'd7022499fc5fbcd34df184209477a79f', user_name: 'None', phone_number_id: '919739811075', conversations: 0
ï¿½ Expert message debug - reply_id: Pg18GJ6sUpmoU2XWAKP0WSKY4, bot_message found: True
ğŸ” Reply context exists: reply_id=Pg18GJ6sUpmoU2XWAKP0WSKY4
ğŸ” PROCESSING MESSAGE: Category=('byoebexpert_to_bot',), UserType=byoebexpert
ğŸ” Message Text: Yes
ğŸ” Added EXPERT conversation to processing queue

=== EXPERT MESSAGE CONSUMER DEBUG ===
ğŸ‘¨â€âš•ï¸ Processing expert message from: 919739811075
ğŸ’¬ Message text: 'Yes'
ğŸ“ Message type: interactive_button_reply
ğŸ”— Reply ID: Pg18GJ6sUpmoU2XWAKP0WSKY4
ğŸ”— Reply additional info: {'verification_status': 'pending'}
=== END EXPERT MESSAGE CONSUMER DEBUG ===

Translation skipped - same language

=== EXPERT GENERATE RESPONSE DEBUG ===
ğŸ“§ Processing expert message from: 919739811075
ğŸ’¬ Message text: 'Yes'
ğŸ“ Message type: interactive_button_reply
ğŸ”— Reply context exists: True
ğŸ”— Reply ID: Pg18GJ6sUpmoU2XWAKP0WSKY4
ğŸ”— Reply message category: bot_to_byoebexpert_verification
ğŸ”— Reply additional_info keys: ['verification_status']
ğŸ”— Verification status: pending
âœ… Branch: Expert clicked YES - sending approved answer to user and thank you to expert
ğŸ”§ DEBUG: Final extracted question: 'Can I take a bath after radiotherapy?' bot_answer: 'Yes, you can take a bath after radiotherapy, but it's important to be gentle with your skin, especially in the treatment area. Use lukewarm water and avoid using soap, oil, or cream on the treated area. Pat your skin dry with a soft towel instead of rubbing it. If you have any concerns about skin care, please consult your healthcare provider for personalized advice.'
ğŸ”§ DEBUG: Expert thank you message: 'Thank you for verifiying the answer.'
ğŸ”§ DEBUG: Created expert message with text: 'Thank you for verifiying the answer.'
Translating bot answer to user's language: hi
ğŸ” DEBUG [Expert YES - checking additional_info]:
     reply_context.additional_info keys: ['verification_status']
     has is_audio_query: False
ğŸ¤ DEBUG [Expert YES approval]: Original user query was audio: False
here now,  Yes, you can take a bath after radiotherapy, but it's important to be gentle with your skin, especially in the treatment area. Use lukewarm water and avoid using soap, oil, or cream on the treated area. Pat your skin dry with a soft towel instead of rubbing it. If you have any concerns about skin care, please consult your healthcare provider for personalized advice.
Thread ID: 26124, Variable Address: 2224972561088, client address: 2226460158096
ğŸ”§ SPEECH DEBUG - SUCCESS: Generated 429120 bytes of audio
ğŸ”§ TTS DEBUG - Received audio_bytes: <class 'bytes'>, length: 429120
ğŸ”§ DEBUG: Audio message generated successfully for YES flow with SAS URL
Last active duration 26.818218
Cached False
ğŸ”§ User 1101 is_active_user: True
COMING HERE 3
Using fallback
ğŸ”§ DEBUG: Using translated template params (case 3) - Q: 'à¤¨à¥€à¤šà¥‡ à¤¦à¥‡à¤–à¥‡à¤‚', A: 'à¤¹à¤¾à¤, à¤†à¤ª à¤°à¥‡à¤¡à¤¿à¤¯à¥‹à¤¥à¥‡à¤°à¥‡à¤ªà¥€ à¤•à¥‡ à¤¬à¤¾à¤¦ à¤¸à¥à¤¨à¤¾à¤¨ à¤•à¤° à¤¸à¤•à¤¤à¥‡ à¤¹à¥ˆà¤‚, à¤²à¥‡à¤•à¤¿à¤¨ à¤…à¤ªà¤¨à¥€ à¤¤à¥à¤µà¤šà¤¾ à¤•à¥‡ à¤¸à¤¾à¤¥ à¤µà¤¿à¤¶à¥‡à¤· à¤°à¥‚à¤ª à¤¸à¥‡ à¤‰à¤ªà¤š                  à¤šà¤¾à¤° à¤•à¥à¤·à¥‡à¤¤à¥à¤° à¤®à¥‡à¤‚ à¤•à¥‹à¤®à¤² à¤°à¤¹à¤¨à¤¾ à¤®à¤¹à¤¤à¥à¤µà¤ªà¥‚à¤°à¥à¤£ à¤¹à¥ˆà¥¤ à¤—à¥à¤¨à¤—à¥à¤¨à¥‡ à¤ªà¤¾à¤¨à¥€ à¤•à¤¾ à¤‰à¤ªà¤¯à¥‹à¤— à¤•à¤°à¥‡à¤‚ à¤”à¤° à¤‰à¤ªà¤šà¤¾à¤°à¤¿à¤¤ à¤•à¥à¤·à¥‡à¤¤à¥à¤° à¤ªà¤° à¤¸à¤¾à¤¬à¥à¤¨, à¤¤à¥‡à¤², à¤¯à¤¾ à¤•à¥à¤°à¥€à¤® à¤•à¤¾ à¤‰à¤ªà¤¯à¥‹à¤— à¤•à¤°à¤¨à¥‡ à¤¸à¥‡ à¤¬à¤šà¥‡à¤‚à¥¤ à¤…à¤ªà¤¨à¥€ à¤¤à¥à¤µà¤šà¤¾ à¤•à¥‹ à¤®à¥à¤²à¤¾à¤¯à¤® à¤¤à¥Œà¤²à¤¿à¤¯à¥‡ à¤¸                          à¤¸à¥‡ à¤¥à¤ªà¤¥à¤ªà¤¾à¤•à¤° à¤¸à¥à¤–à¤¾à¤à¤‚, à¤°à¤—à¤¡à¤¼à¥‡à¤‚ à¤¨à¤¹à¥€à¤‚à¥¤ à¤¯à¤¦à¤¿ à¤†à¤ªà¤•à¥‹ à¤¤à¥à¤µà¤šà¤¾ à¤•à¥€ à¤¦à¥‡à¤–à¤­à¤¾à¤² à¤•à¥‡ à¤¬à¤¾à¤°à¥‡ à¤®à¥‡à¤‚ à¤•à¥‹à¤ˆ à¤šà¤¿à¤‚à¤¤à¤¾ à¤¹à¥ˆ, à¤¤à¥‹ à¤•à¥ƒà¤ªà¤¯à¤¾ à¤µà¥à¤¯à¤•à¥à¤¤à¤¿à¤—à¤¤ à¤¸à¤²à¤¾à¤¹ à¤•à¥‡ à¤²à¤¿à¤ à¤…à¤ªà¤¨à¥‡ à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ à¤¸à¥‡à¤µà¤¾ à¤ªà¥à¤°à¤¦à¤¾à¤¤à¤¾ à¤¸à¥‡ à¤ªà¤°à¤¾à¤®à¤°à¥à¤¶ à¤•à¤°à¥‡à¤‚à¥¤'    
ğŸ”§ DEBUG: Using last message in conversation context: 2fb4a153-66f7-4b01-99c5-a07fb099944f
ğŸ”§ DEBUG: Last message category: 'None'
ğŸ”§ __create_user_reply_context DEBUG: status=verified, cross_conv_message has reply_context=True
ğŸ”§ __create_user_reply_context DEBUG: cross_conv_message.reply_context.reply_id=auxxQcojVxCYrTLZGkhwHAan1
ğŸ”§ __create_user_reply_context DEBUG: additional_info exists=False
ğŸ”§ __create_user_reply_context DEBUG: additional_info is None!
ğŸ”§ __create_user_reply_context DEBUG: Checking verified condition:
  - status == constants.VERIFIED: True (status='verified', VERIFIED='verified')
  - reply_context is not None: True
  - additional_info is not None: False
ğŸ”§ __create_user_reply_context DEBUG: Using verified flow, reply_id set to: auxxQcojVxCYrTLZGkhwHAan1
ğŸ”§ __create_user_reply_context DEBUG: Final reply_id being returned: auxxQcojVxCYrTLZGkhwHAan1
ğŸ”§ DEBUG: Created reply_context with reply_id: auxxQcojVxCYrTLZGkhwHAan1
ğŸ”˜ User is active, will send regular message through normal flow
ğŸ”§ DEBUG: Created user message with bot_answer: 'Yes, you can take a bath after radiotherapy, but it's important to be gentle with your skin, especially in the treatment area. Use lukewarm water and avoid using soap, oil, or cream on the treated area. Pat your skin dry with a soft towel instead of rubbing it. If you have any concerns about skin care, please consult your healthcare provider for personalized advice.'
ğŸ”§ Including original expert message for storage: ID=qgomoP1RdEfC0MCJv5rzqbatz
ğŸ”§ Original expert message category: ('byoebexpert_to_bot',)
ğŸ“¤ Generated messages: 1 user, 1 expert
=== END EXPERT GENERATE RESPONSE DEBUG ===


=== EXPERT SEND RESPONSE DEBUG ===
ğŸ“¨ Processing 4 messages in send handler
ğŸ“¨ Message 1: user_type='byoebuser', category='bot_to_byoebuser_response'
ğŸ“¨ Message 2: user_type='byoebexpert', category='bot_to_byoebexpert'
ğŸ“¨ Message 3: user_type='None', category='read_receipt'
ğŸ“¨ Message 4: user_type='byoebexpert', category='('byoebexpert_to_bot',)'
ğŸ“¨ After filtering: 1 read receipts, 1 user messages, 2 expert messages

=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 1 requests
ğŸ“¤ Request 1: {'to_contact': '919739811075', 'type': 'text', 'text': {'body': 'Thank you for verifiying the answer.'}, 'context': {'message_id': 'Pg18GJ6sUpmoU2XWAKP0WSKY4'}}
ğŸ“¤ Got 1 results
ğŸ“¤ Result 1: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'pvsFgujB2l4OBAIr1kYWBK9nI', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '919739811075', 'credits': 0, 'created_at': '2025-12-10T14:50:48.172Z', 'status': 'processing'}]}
ğŸ“¤ Extracted message_id for result 1: pvsFgujB2l4OBAIr1kYWBK9nI
ğŸ“¤ Final message_ids: ['pvsFgujB2l4OBAIr1kYWBK9nI']
=== END QIKCHAT SEND_REQUESTS DEBUG ===

ğŸ”§ EXPERT_ID_FIX: Updating expert message ID: fb17abe6-0403-4b1d-83bc-a41417ae1ace -> pvsFgujB2l4OBAIr1kYWBK9nI
ğŸ”„ Updating expert message ID in database: fb17abe6-0403-4b1d-83bc-a41417ae1ace -> pvsFgujB2l4OBAIr1kYWBK9nI
ğŸ”„ UPDATE_MESSAGE_ID: Starting ID update process
   Old ID: fb17abe6-0403-4b1d-83bc-a41417ae1ace
   New ID: pvsFgujB2l4OBAIr1kYWBK9nI
ğŸ”„ UPDATE_MESSAGE_ID: Looking for document with old ID: fb17abe6-0403-4b1d-83bc-a41417ae1ace
âŒ UPDATE_MESSAGE_ID: Message with ID fb17abe6-0403-4b1d-83bc-a41417ae1ace not found for update
ğŸ” UPDATE_MESSAGE_ID: Checking if message exists in different format...
âŒ UPDATE_MESSAGE_ID: Message not found in nested structure either
ğŸ“¨ Sending 1 user messages
ğŸ“¤ __handle_user: Processing 1 user messages
ğŸ”§ __modify_user_messages_context: Processing 1 messages
ğŸ”§ No audio messages found, fixing reply contexts for user messages
ğŸ”§ Original reply_id: auxxQcojVxCYrTLZGkhwHAan1
ğŸ”§ Reply_id already looks like valid QikChat message ID, keeping it: auxxQcojVxCYrTLZGkhwHAan1
ğŸ“¤ After modification: 1 messages to send
ğŸ“¤ Preparing request for message 1/1
ğŸ“¤ Message type: regular_text
ğŸ“¤ Message source text length: 406
ğŸ“¤ Has reply_context: True
ğŸ“¤ Reply ID: auxxQcojVxCYrTLZGkhwHAan1
Checking interactive list - has description: False, has row_texts: False, row_texts not None: False, result: False
ğŸµ Preparing audio message request (async)...
ğŸµ Using audio URL: https://smartkcstorage1.blob.core.windows.net/onco...
ğŸµ Audio message request prepared
ğŸ“¤ Successfully prepared 2 requests for message 1

=== QIKCHAT SEND_REQUESTS DEBUG ===
ğŸ“¤ Sending 2 requests
ğŸ“¤ Request 1: {'to_contact': '916352927215', 'type': 'text', 'text': {'body': 'à¤¹à¤¾à¤, à¤†à¤ª à¤°à¥‡à¤¡à¤¿à¤¯à¥‹à¤¥à¥‡à¤°à¥‡à¤ªà¥€ à¤•à¥‡ à¤¬à¤¾à¤¦ à¤¸à¥à¤¨à¤¾à¤¨ à¤•à¤° à¤¸à¤•à¤¤à¥‡ à¤¹à¥ˆà¤‚, à¤²à¥‡à¤•à¤¿à¤¨ à¤…à¤ªà¤¨à¥€ à¤¤à¥à¤µà¤šà¤¾ à¤•à¥‡ à¤¸à¤¾à¤¥ à¤µà¤¿à¤¶à¥‡à¤· à¤°à¥‚à¤ª à¤¸à¥‡               à¤‰à¤ªà¤šà¤¾à¤° à¤•à¥à¤·à¥‡à¤¤à¥à¤° à¤®à¥‡à¤‚ à¤•à¥‹à¤®à¤² à¤°à¤¹à¤¨à¤¾ à¤®à¤¹à¤¤à¥à¤µà¤ªà¥‚à¤°à¥à¤£ à¤¹à¥ˆà¥¤ à¤—à¥à¤¨à¤—à¥à¤¨à¥‡ à¤ªà¤¾à¤¨à¥€ à¤•à¤¾ à¤‰à¤ªà¤¯à¥‹à¤— à¤•à¤°à¥‡à¤‚ à¤”à¤° à¤‰à¤ªà¤šà¤¾à¤°à¤¿à¤¤ à¤•à¥à¤·à¥‡à¤¤à¥à¤° à¤ªà¤° à¤¸à¤¾à¤¬à¥à¤¨, à¤¤à¥‡à¤², à¤¯à¤¾ à¤•à¥à¤°à¥€à¤® à¤•à¤¾ à¤‰à¤ªà¤¯à¥‹à¤— à¤•à¤°à¤¨à¥‡ à¤¸à¥‡ à¤¬à¤šà¥‡à¤‚à¥¤ à¤…à¤ªà¤¨à¥€ à¤¤à¥à¤µà¤šà¤¾ à¤•à¥‹ à¤®à¥à¤²à¤¾à¤¯à¤® à¤¤à¥Œà¤²à¤¿                         à¤¿à¤¯à¥‡ à¤¸à¥‡ à¤¥à¤ªà¤¥à¤ªà¤¾à¤•à¤° à¤¸à¥à¤–à¤¾à¤à¤‚, à¤°à¤—à¤¡à¤¼à¥‡à¤‚ à¤¨à¤¹à¥€à¤‚à¥¤ à¤¯à¤¦à¤¿ à¤†à¤ªà¤•à¥‹ à¤¤à¥à¤µà¤šà¤¾ à¤•à¥€ à¤¦à¥‡à¤–à¤­à¤¾à¤² à¤•à¥‡ à¤¬à¤¾à¤°à¥‡ à¤®à¥‡à¤‚ à¤•à¥‹à¤ˆ à¤šà¤¿à¤‚à¤¤à¤¾ à¤¹à¥ˆ, à¤¤à¥‹ à¤•à¥ƒà¤ªà¤¯à¤¾ à¤µà¥à¤¯à¤•à¥à¤¤à¤¿à¤—à¤¤ à¤¸à¤²à¤¾à¤¹ à¤•à¥‡ à¤²à¤¿à¤ à¤…à¤ªà¤¨à¥‡ à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ à¤¸à¥‡à¤µà¤¾ à¤ªà¥à¤°à¤¦à¤¾à¤¤à¤¾ à¤¸à¥‡ à¤ªà¤°à¤¾à¤®à¤°à¥à¤¶ à¤•à¤°à¥‡à¤‚à¥¤'                             '}, 'context': {'message_id': 'auxxQcojVxCYrTLZGkhwHAan1'}}
ğŸ“¤ Request 2: {'to_contact': '916352927215', 'type': 'audio', 'audio': {'link': 'https://smartkcstorage1.blob.core.windows.net/oncobot-container/tts_audio_23081e6fe1cd463499a91e642c571bb7.mp3?st=2025-12-10T14%3A50%3A46Z&se=2025-12-10T15%3A50%3A46Z&sp=r&sv=2025-01-05&sr=b&skoid=f5b64d94-ba27-422a-abb5-cad2b511c671&sktid=72f988bf-86f1-41af-91ab-2d7cd011db47&skt=2025-12-10T14%3A50%3A46Z&ske=2025-12-10T15%3A50%3A46Z&sks=b&skv=2025-01-05&sig=TxAGbtb08f5D%2B91wegej6CUxf8ubGOVvsh4p1zIC4%2Bw%3D'}, 'context': {'message_id': 'auxxQcojVxCYrTLZGkhwHAan1'}}
ğŸ“¤ Got 2 results
ğŸ“¤ Result 1: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'pNn0Jz3dQxo1nZg4eeOWR71Qs', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '916352927215', 'credits': 0, 'created_at': '2025-12-10T14:50:49.019Z', 'status': 'processing'}]}
ğŸ“¤ Result 2: {'status': True, 'message': 'Messages queued successfully', 'data': [{'id': 'QHsTCDVeGt9NWPsZL1vsv848z', 'channel': 'whatsapp', 'from': '916366282002', 'recipient': '916352927215', 'credits': 0, 'created_at': '2025-12-10T14:50:49.032Z', 'status': 'processing'}]}
ğŸ“¤ Extracted message_id for result 1: pNn0Jz3dQxo1nZg4eeOWR71Qs
ğŸ“¤ Extracted message_id for result 2: QHsTCDVeGt9NWPsZL1vsv848z
ğŸ“¤ Final message_ids: ['pNn0Jz3dQxo1nZg4eeOWR71Qs', 'QHsTCDVeGt9NWPsZL1vsv848z']
=== END QIKCHAT SEND_REQUESTS DEBUG ===

ğŸ“¤ Successfully sent message 1, got response: 2 items, message_id: ['pNn0Jz3dQxo1nZg4eeOWR71Qs', 'QHsTCDVeGt9NWPsZL1vsv848z']
ğŸ”§ FINAL_ANSWER_ID_FIX: Updating 1 message IDs with QikChat IDs
ğŸ”§ FINAL_ANSWER_ID_FIX: Available QikChat IDs: ['pNn0Jz3dQxo1nZg4eeOWR71Qs', 'QHsTCDVeGt9NWPsZL1vsv848z']
ğŸ”§ FINAL_ANSWER_ID_FIX: Processing message 1
   - Original ID: dc0f88a8-8840-4396-aad9-3909726d6a12
   - Has audio: True
   - Message type: regular_text
ğŸ”§ FINAL_ANSWER_ID_FIX: Text+Audio message detected
   - Text QikChat ID: pNn0Jz3dQxo1nZg4eeOWR71Qs
   - Audio QikChat ID: QHsTCDVeGt9NWPsZL1vsv848z
ğŸ”§ FINAL_ANSWER_ID_FIX: Stored audio ID in additional_info: QHsTCDVeGt9NWPsZL1vsv848z
ğŸ”§ FINAL_ANSWER_ID_FIX: Message 1 ID updated: dc0f88a8-8840-4396-aad9-3909726d6a12 -> pNn0Jz3dQxo1nZg4eeOWR71Qs (text), audio ID: QHsTCDVeGt9NWPsZL1vsv848z       
ğŸ“¤ No emoji found, skipping final reaction
ğŸ—„ï¸ __prepare_db_queries: Preparing queries for 1 user messages and 2 expert messages
ğŸ—„ï¸ AUDIO_DEBUG: Checking 1 user messages for audio processing
ğŸ—„ï¸ AUDIO_DEBUG: User message 1: ID=pNn0Jz3dQxo1nZg4eeOWR71Qs, has_audio=True
ğŸ—„ï¸ Added 1 user response messages for storage
ğŸ—„ï¸ Added 2 expert messages for storage

=== EXPERT HANDLER MESSAGE STORAGE DEBUG ===
ğŸ“Š Total messages to store: 3
  1. ID: pNn0Jz3dQxo1nZg4eeOWR71Qs
     Category: bot_to_byoebuser_response
     Type: regular_text
     Has Audio: True
     QikChat Audio ID: QHsTCDVeGt9NWPsZL1vsv848z
     Text: 'Yes, you can take a bath after radiotherapy, but i...'
  2. ID: pvsFgujB2l4OBAIr1kYWBK9nI
     Category: bot_to_byoebexpert
     Type: regular_text
     Has Audio: None
     Text: 'Thank you for verifiying the answer....'
  3. ID: qgomoP1RdEfC0MCJv5rzqbatz
     Category: ('byoebexpert_to_bot',)
     Type: interactive_button_reply
     Has Audio: False
     Text: 'Yes...'
=== END EXPERT HANDLER DEBUG ===

ğŸ” MESSAGE_CREATE_QUERIES: Processing 3 messages for database storage
ğŸ•’ TIMESTAMP_DEBUG Message 1/3: ID=pNn0Jz3dQxo1nZg4eeOW
   has_outgoing_timestamp: None
   outgoing_timestamp value: None
   final timestamp: 1765378248
   message_type: regular_text
ğŸ” MESSAGE_CREATE_QUERIES: Message 1
   Message ID: pNn0Jz3dQxo1nZg4eeOWR71Qs
   Message Type: regular_text
   Message Class: Not classified
   Is Expert Verification: False
   QikChat Audio ID: QHsTCDVeGt9NWPsZL1vsv848z
   Text Preview: Yes, you can take a bath after radiotherapy, but it's important to be gentle wit...
ğŸµ AUDIO_ID_STORED: QikChat audio ID QHsTCDVeGt9NWPsZL1vsv848z is stored in message additional_info
ğŸ•’ TIMESTAMP_DEBUG Message 2/3: ID=pvsFgujB2l4OBAIr1kYW
   has_outgoing_timestamp: None
   outgoing_timestamp value: None
   final timestamp: 1765378248
   message_type: regular_text
ğŸ” MESSAGE_CREATE_QUERIES: Message 2
   Message ID: pvsFgujB2l4OBAIr1kYWBK9nI
   Message Type: regular_text
   Message Class: Not classified
   Is Expert Verification: False
   QikChat Audio ID: None
   Text Preview: Thank you for verifiying the answer....
ğŸ•’ TIMESTAMP_DEBUG Message 3/3: ID=qgomoP1RdEfC0MCJv5rz
   has_outgoing_timestamp: None
   outgoing_timestamp value: None
   final timestamp: 1765378248
   message_type: interactive_button_reply
C:\Users\t-asanghvi\AppData\Local\pypoetry\Cache\virtualenvs\byoeb-7XHC672s-py3.11\Lib\site-packages\pydantic\main.py:463: UserWarning: Pydantic serializer warnings:
  PydanticSerializationUnexpectedValue(Expected `str` - serialized value may not be as expected [input_value=('byoebexpert_to_bot',), input_type=tuple])
  return self.__pydantic_serializer__.to_python(
ğŸ” MESSAGE_CREATE_QUERIES: Message 3
   Message ID: qgomoP1RdEfC0MCJv5rzqbatz
   Message Type: interactive_button_reply
   Message Class: Not classified
   Is Expert Verification: False
   QikChat Audio ID: None
   Text Preview: Yes...
ğŸ” MESSAGE_CREATE_QUERIES: Generated 3 database create queries
ğŸ” FINAL_QUERIES_DEBUG: About to return 3 queries:
   Query 1: ID=pNn0Jz3dQxo1nZg4eeOWR71Qs, has_text=True, has_audio=True
   Query 2: ID=pvsFgujB2l4OBAIr1kYWBK9nI, has_text=True, has_audio=False
   Query 3: ID=qgomoP1RdEfC0MCJv5rzqbatz, has_text=True, has_audio=False
ğŸ—„ï¸ Generated 3 CREATE queries
ğŸ—„ï¸ Calling correction_update_query
ğŸ—„ï¸ Calling verification_status_update_query
ğŸ—„ï¸ Generated 4 UPDATE queries
ğŸ—„ï¸ Database queries prepared successfully
=== END EXPERT SEND RESPONSE DEBUG ===

ğŸ” PROCESSING RESULTS: Got 1 results from handlers
âœ… Result 0: MSG_CREATE=3, MSG_UPDATE=4, USER_CREATE=0, USER_UPDATE=1
Executing database queries - User updates: 1, Message creates: 3
ğŸ” EXECUTE_QUERIES: Starting execution with queries: ['create', 'update']
ğŸ” EXECUTE_QUERIES: Executing 3 CREATE operations
   CREATE 1: Message ID = pNn0Jz3dQxo1nZg4eeOWR71Qs
   CREATE 2: Message ID = pvsFgujB2l4OBAIr1kYWBK9nI
   CREATE 3: Message ID = qgomoP1RdEfC0MCJv5rzqbatz
Inserting documents: ['pNn0Jz3dQxo1nZg4eeOWR71Qs', 'pvsFgujB2l4OBAIr1kYWBK9nI', 'qgomoP1RdEfC0MCJv5rzqbatz']
âœ… EXECUTE_QUERIES: CREATE operations completed successfully
   Result: (['pNn0Jz3dQxo1nZg4eeOWR71Qs', 'pvsFgujB2l4OBAIr1kYWBK9nI', 'qgomoP1RdEfC0MCJv5rzqbatz'], None)
Database operations completed in 0.79 seconds
